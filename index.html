<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>é£ä¹¦æ’ç­è¶…çº§åŠ©æ‰‹ Â· All in One</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --primary: #2563eb;
      --bg: #f8fafc;
      --panel-bg: #ffffff;
      --border: #e2e8f0;
      --text: #1e293b;
      --text-light: #64748b;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; line-height: 1.5; }
    
    /* å¸ƒå±€ */
    .app-container { max-width: 1000px; margin: 0 auto; background: var(--panel-bg); border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); overflow: hidden; }
    
    /* å¤´éƒ¨ & å¯¼èˆª */
    .header { background: #1e293b; color: white; padding: 20px; }
    .header h1 { margin: 0; font-size: 1.25rem; }
    .header p { margin: 5px 0 0; opacity: 0.8; font-size: 0.875rem; }
    
    .tabs { display: flex; background: #334155; overflow-x: auto; }
    .tab-btn { flex: 1; border: none; background: none; color: #cbd5e1; padding: 12px 16px; cursor: pointer; white-space: nowrap; font-size: 14px; transition: 0.2s; border-bottom: 3px solid transparent; }
    .tab-btn:hover { background: #475569; color: white; }
    .tab-btn.active { color: white; border-bottom-color: var(--primary); background: #1e293b; font-weight: bold; }

    /* å†…å®¹åŒº */
    .content-area { padding: 24px; min-height: 500px; }
    .tab-content { display: none; animation: fadeIn 0.3s; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* è¡¨å•ç»„ä»¶ */
    .panel-section { margin-bottom: 24px; border: 1px solid var(--border); border-radius: 8px; padding: 16px; }
    .section-title { font-weight: 600; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; color: var(--primary); font-size: 14px; }
    
    textarea, input, select { width: 100%; box-sizing: border-box; border: 1px solid var(--border); border-radius: 6px; padding: 10px; font-family: monospace; font-size: 13px; resize: vertical; margin-bottom: 10px; background: #fdfdfd; }
    textarea:focus, input:focus { outline: none; border-color: var(--primary); ring: 2px var(--primary); }
    
    .btn-group { display: flex; gap: 10px; margin-top: 10px; }
    .btn { padding: 8px 16px; border-radius: 6px; border: 1px solid var(--border); background: white; cursor: pointer; font-size: 13px; font-weight: 500; color: var(--text); transition: 0.1s; }
    .btn:hover { background: #f1f5f9; }
    .btn-primary { background: var(--primary); color: white; border-color: var(--primary); }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-danger { color: #ef4444; border-color: #fecaca; }
    .btn-danger:hover { background: #fef2f2; }

    /* çŠ¶æ€ä¸è¾“å‡º */
    .status-msg { margin-top: 10px; font-size: 13px; min-height: 20px; }
    .status-msg.ok { color: #16a34a; }
    .status-msg.error { color: #dc2626; }

    .output-box { background: #f1f5f9; border: 1px solid var(--border); color: #334155; height: 150px; }
    
    /* å¸®åŠ©æç¤º */
    .hint { font-size: 12px; color: var(--text-light); margin-bottom: 4px; display: block; }

  </style>
</head>
<body>

<div class="app-container">
  <div class="header">
    <h1>ğŸ“… é£ä¹¦æ’ç­å·¥å…·é›† (Pro)</h1>
    <p>å•æ–‡ä»¶ç¦»çº¿ç‰ˆ Â· è‡ªåŠ¨ä¿å­˜è¾“å…¥ Â· æ™ºèƒ½è§£æ</p>
  </div>
  
  <div class="tabs" id="navTabs">
    <button class="tab-btn active" data-target="t1">1. å•äººç­è¡¨è½¬æ¢</button>
    <button class="tab-btn" data-target="t2">2. ç­è¡¨å¯¹æ¯”</button>
    <button class="tab-btn" data-target="t3">3. ç­æ¬¡æŸ¥äºº</button>
    <button class="tab-btn" data-target="t4">4. æŒ‰æ—¥æœŸæŸ¥ä»£ç </button>
    <button class="tab-btn" data-target="t5">5. ä»£ç ç»Ÿè®¡</button>
  </div>

  <div class="content-area">
    
    <div id="t1" class="tab-content active">
      <div class="panel-section">
        <div class="section-title"><span>åŸå§‹æ•°æ®è¾“å…¥</span> <span style="font-size:12px;color:#64748b">åŒ…å«ï¼šæ—¥æœŸè¡Œ+æ˜ŸæœŸè¡Œ+æ—¶é—´è¡Œ</span></div>
        <textarea id="in1_raw" style="height:100px;" placeholder="ç²˜è´´ç¤ºä¾‹ï¼š&#10;12æœˆ1æ—¥ 12æœˆ2æ—¥...&#10;æ˜ŸæœŸä¸€ æ˜ŸæœŸäºŒ...&#10;9:00 OFF 15:00..."></textarea>
        <div class="btn-group">
           <input id="in1_title" type="text" placeholder="ä½ çš„åå­—ï¼ˆç”¨äºå¯¼å‡ºæ–‡ä»¶åï¼‰" style="width:200px;margin:0;">
           <button class="btn btn-primary" onclick="App.t1_parse()">ç”Ÿæˆæ—¶é—´è¡¨</button>
           <button class="btn" onclick="App.clear('in1_raw')">æ¸…ç©º</button>
        </div>
        <div id="st1" class="status-msg"></div>
      </div>
      <div class="panel-section">
        <div class="section-title"><span>ç»“æœè¾“å‡º</span></div>
        <textarea id="out1" class="output-box" readonly></textarea>
        <div class="btn-group">
          <button class="btn" onclick="App.copy('out1')">å¤åˆ¶æ–‡æœ¬</button>
          <button class="btn" onclick="App.t1_downloadICS()">å¯¼å‡º iOS/Outlook æ—¥å† (.ics)</button>
        </div>
      </div>
    </div>

    <div id="t2" class="tab-content">
      <div class="panel-section">
        <div class="section-title">
            <span>å¤šäººå¯¹æ¯”è¾“å…¥</span>
            <select id="in2_count" onchange="App.t2_renderInputs()" style="width:auto;padding:2px;">
                <option value="2">2äººå¯¹æ¯”</option>
                <option value="3">3äººå¯¹æ¯”</option>
                <option value="4">4äººå¯¹æ¯”</option>
            </select>
        </div>
        <div id="in2_container"></div> <div class="btn-group">
            <button class="btn btn-primary" onclick="App.t2_compare()">å¼€å§‹å¯¹æ¯”</button>
            <button class="btn" onclick="App.t2_clear()">æ¸…ç©ºæ‰€æœ‰</button>
        </div>
        <div id="st2" class="status-msg"></div>
      </div>
      <div class="panel-section">
        <div class="section-title"><span>å¯¹æ¯”ç»“æœï¼ˆå…±åŒä¸Šç­/åŒç­æ¬¡ï¼‰</span></div>
        <textarea id="out2" class="output-box" style="height:200px;"></textarea>
      </div>
    </div>

    <div id="t3" class="tab-content">
      <div class="panel-section">
        <div class="section-title"><span>è¾“å…¥ï¼šå§“ååˆ—è¡¨ + ç›´åˆ—ç­æ¬¡</span></div>
        <div style="display:grid; grid-template-columns: 1fr 2fr; gap:10px;">
            <div>
                <span class="hint">å§“å (æ¯è¡Œä¸€ä¸ª)</span>
                <textarea id="in3_names" style="height:150px;" placeholder="Joyi Xiang&#10;Aiden Cho"></textarea>
            </div>
            <div>
                <span class="hint">ç›´åˆ—ç­æ¬¡ (ä¸å§“åè¡Œå¯¹åº”)</span>
                <textarea id="in3_shifts" style="height:150px;" placeholder="9:00&#10;OFF&#10;15:00..."></textarea>
            </div>
        </div>
        <div class="btn-group">
            <input id="in3_dateLabel" placeholder="æ—¥æœŸï¼ˆå¯é€‰ï¼Œå¦‚ 12æœˆ4æ—¥ï¼‰" style="flex:1;">
            <button class="btn btn-primary" onclick="App.t3_parse()">æŸ¥è¯¢äººå‘˜</button>
        </div>
        <div id="st3" class="status-msg"></div>
      </div>
      <div class="panel-section">
        <div class="section-title"><span>æŒ‰ç­æ¬¡åˆ†ç»„ç»“æœ</span></div>
        <textarea id="out3" class="output-box"></textarea>
      </div>
    </div>

    <div id="t4" class="tab-content">
      <div class="panel-section">
        <div class="section-title"><span>ä¸‰åŒºåŸŸå…¨æœˆæ•°æ®ç²˜è´´</span></div>
        <span class="hint">â‘  æ—¥æœŸè¡Œ (12æœˆ1æ—¥...) + æ˜ŸæœŸè¡Œ</span>
        <textarea id="in4_dates" style="height:60px;" placeholder="ç²˜è´´æ—¥æœŸå’Œæ˜ŸæœŸè¡Œ"></textarea>
        <span class="hint">â‘¡ å§“ååˆ—è¡¨ (Joyi...)</span>
        <textarea id="in4_names" style="height:80px;" placeholder="ç²˜è´´å§“ååˆ—"></textarea>
        <span class="hint">â‘¢ å…¨æœˆä»£ç çŸ©é˜µ (OFF 9:00...)</span>
        <textarea id="in4_codes" style="height:100px;" placeholder="ç²˜è´´å¯¹åº”çš„å…¨æœˆæ’ç­æ•°æ®"></textarea>
        
        <div class="btn-group">
            <button class="btn btn-primary" onclick="App.t4_parse()">1. è§£æè¡¨æ ¼</button>
            <button class="btn btn-danger" onclick="App.t4_clear()">æ¸…ç©º</button>
        </div>
        <div id="st4" class="status-msg"></div>

        <div style="margin-top:15px; border-top:1px dashed #ddd; padding-top:15px;">
             <div class="section-title"><span>2. æŸ¥è¯¢äº¤äº’</span></div>
             <div style="display:flex; gap:10px;">
                 <select id="sel4_day"><option>å…ˆè§£æè¡¨æ ¼</option></select>
                 <select id="sel4_code"><option>å…ˆè§£æè¡¨æ ¼</option></select>
                 <button class="btn btn-primary" onclick="App.t4_query()">æŸ¥è¯¢</button>
             </div>
        </div>
      </div>
      <div class="panel-section">
        <textarea id="out4" class="output-box" placeholder="ç»“æœæ˜¾ç¤ºåŒºåŸŸ"></textarea>
      </div>
    </div>

    <div id="t5" class="tab-content">
      <div class="panel-section">
        <div class="section-title"><span>æ•°æ®æºï¼ˆå¤ç”¨åŠŸèƒ½4çš„è¾“å…¥ï¼‰</span></div>
        <p style="font-size:13px; color:#666;">æ­¤åŠŸèƒ½ç›´æ¥ä½¿ç”¨â€œåŠŸèƒ½4â€ä¸­ç²˜è´´çš„æ•°æ®ã€‚è¯·ç¡®ä¿åœ¨é‚£è¾¹å·²ç»ç²˜è´´äº†å†…å®¹ã€‚</p>
        <div class="btn-group">
            <input id="in5_code" type="text" value="MC" placeholder="è¾“å…¥ä»£ç  (MC, AL, OFF...)" style="width:150px;">
            <button class="btn btn-primary" onclick="App.t5_stats()">ç»Ÿè®¡æ•´æœˆæ¬¡æ•°</button>
        </div>
        <div id="st5" class="status-msg"></div>
      </div>
      <div class="panel-section">
        <div class="section-title"><span>ç»Ÿè®¡æ’è¡Œæ¦œ</span></div>
        <textarea id="out5" class="output-box" style="height:200px;"></textarea>
      </div>
    </div>

  </div>
</div>

<script>
/**
 * æ ¸å¿ƒé€»è¾‘æ¨¡å—
 */
const App = (function(){
    // === å·¥å…·å‡½æ•° ===
    const $ = id => document.getElementById(id);
    const pad = n => n < 10 ? "0"+n : ""+n;
    
    // è‡ªåŠ¨ä¿å­˜è¾“å…¥åˆ° LocalStorage
    function saveState(key, val) { localStorage.setItem('fs_tool_'+key, val); }
    function loadState(key) { return localStorage.getItem('fs_tool_'+key) || ''; }
    
    // ç»‘å®šæ‰€æœ‰å¸¦ ID çš„è¾“å…¥æ¡†è‡ªåŠ¨ä¿å­˜
    function bindAutoSave() {
        const inputs = document.querySelectorAll('textarea, input[type="text"]');
        inputs.forEach(el => {
            if(el.id) {
                el.value = loadState(el.id);
                el.addEventListener('input', () => saveState(el.id, el.value));
            }
        });
    }

    // çŠ¶æ€æ˜¾ç¤º
    function setStatus(id, msg, type='ok') {
        const el = $(id);
        if(!msg) { el.innerHTML=''; return; }
        el.className = `status-msg ${type}`;
        el.innerHTML = msg;
        setTimeout(() => { if(type==='ok') el.innerHTML=''; }, 5000);
    }

    // å¤åˆ¶åŠŸèƒ½
    function copyText(id) {
        const el = $(id);
        el.select();
        document.execCommand('copy');
        alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    }

    // === ä¸šåŠ¡é€»è¾‘æ ¸å¿ƒ ===
    
    // 1. ç­æ¬¡å¤„ç†ï¼š9:00 -> 09:00 - 18:00
    function formatShift(raw) {
        raw = raw.trim();
        const m = raw.match(/^(\d{1,2}):(\d{2})$/);
        if (!m) return raw;
        let h = parseInt(m[1]), min = parseInt(m[2]);
        let endH = (h + 9) % 24;
        let endHStr = (h + 9 >= 24 && endH === 0) ? "24" : pad(endH); // é€»è¾‘ä¿®æ­£
        return `${pad(h)}:${pad(min)} - ${endHStr}:${pad(min)}`;
    }

    // è§£æé€šç”¨ä¸‰è¡Œæ•°æ® (æ—¥æœŸ, æ˜ŸæœŸ, æ•°æ®)
    function parseFeishuLines(text) {
        const lines = text.split(/[\r\n]+/).map(l=>l.trim()).filter(Boolean);
        if (lines.length < 2) throw new Error("è¡Œæ•°ä¸è¶³ï¼Œè¯·åŒ…å«æ—¥æœŸã€æ˜ŸæœŸå’Œæ’ç­è¡Œ");
        
        // æ™ºèƒ½è¯†åˆ«æ—¥æœŸè¡Œ
        const dateLineIdx = lines.findIndex(l => /(\d{1,2})\s*[æœˆ\/-]\s*(\d{1,2})/.test(l));
        if(dateLineIdx === -1) throw new Error("æœªæ‰¾åˆ°æ—¥æœŸè¡Œ (å¦‚ 12æœˆ1æ—¥)");
        
        const dateTokens = lines[dateLineIdx].split(/[\t\s]+/).filter(Boolean);
        const weekTokens = (lines[dateLineIdx+1] || "").match(/æ˜ŸæœŸ/) ? lines[dateLineIdx+1].split(/[\t\s]+/).filter(Boolean) : [];
        
        // å¯»æ‰¾åŒ…å«æ—¶é—´çš„æ’ç­è¡Œ
        const shiftLine = lines.slice(dateLineIdx+1).find(l => /\d{1,2}:\d{2}|OFF|REST|MC/.test(l));
        if(!shiftLine) throw new Error("æœªæ‰¾åˆ°å…·ä½“çš„æ’ç­æ—¶é—´è¡Œ");
        
        const shiftTokens = shiftLine.split(/[\t\s]+/).filter(Boolean);
        
        return { dateTokens, weekTokens, shiftTokens };
    }

    // === åŠŸèƒ½ 1: å•äººç­è¡¨ ===
    let t1_events = []; // ç”¨äºå¯¼å‡º ICS

    function t1_parse() {
        try {
            const raw = $('in1_raw').value;
            const name = $('in1_title').value || "æˆ‘çš„";
            const { dateTokens, weekTokens, shiftTokens } = parseFeishuLines(raw);
            
            t1_events = [];
            let output = `${name} æ’ç­è¡¨\n\n`;
            let stats = { work:0, off:0, leave:0 };

            // å¯¹é½é€»è¾‘ï¼šå°è¯•æŒ‰ç´¢å¼•å¯¹é½
            const len = Math.min(dateTokens.length, shiftTokens.length);
            
            for(let i=0; i<len; i++) {
                const date = dateTokens[i];
                const week = weekTokens[i] || "";
                const code = shiftTokens[i];
                const shiftDisplay = formatShift(code);
                
                output += `${date} (${week}): ${shiftDisplay}\n`;

                // ç®€å•çš„ç»Ÿè®¡
                if(/OFF|REST/.test(code)) stats.off++;
                else if(/MC|AL/.test(code)) stats.leave++;
                else stats.work++;

                // å‡†å¤‡æ—¥å†æ•°æ®
                const dateMatch = date.match(/(\d{1,2})\s*[æœˆ\/-]\s*(\d{1,2})/);
                const timeMatch = code.match(/^(\d{1,2}):(\d{2})$/);
                if(dateMatch && timeMatch) {
                    // å‡è®¾å½“å‰å¹´ä»½æˆ–ä¸‹ä¸€å¹´
                    const now = new Date();
                    let year = now.getFullYear();
                    const month = parseInt(dateMatch[1]);
                    // å¦‚æœå½“å‰æ˜¯12æœˆä½†æ’ç­æ˜¯1æœˆï¼Œå¹´ä»½+1
                    if(now.getMonth()===11 && month===1) year++; 

                    t1_events.push({
                        year, month, day: parseInt(dateMatch[2]),
                        sh: parseInt(timeMatch[1]), sm: parseInt(timeMatch[2]),
                        eh: (parseInt(timeMatch[1])+9), em: parseInt(timeMatch[2]) // ç®€å•+9å¤„ç†
                    });
                }
            }
            
            output += `\nç»Ÿè®¡ï¼šå‡ºå‹¤ ${stats.work} å¤©ï¼Œä¼‘æ¯ ${stats.off} å¤©ï¼Œè¯·å‡ ${stats.leave} å¤©`;
            $('out1').value = output;
            setStatus('st1', 'ç”ŸæˆæˆåŠŸ', 'ok');
        } catch(e) {
            setStatus('st1', e.message, 'error');
        }
    }

    function t1_downloadICS() {
        if(!t1_events.length) return alert("è¯·å…ˆç”Ÿæˆæ—¶é—´è¡¨ï¼Œä¸”ç¡®ä¿åŒ…å«å…·ä½“æ—¶é—´ç­æ¬¡(9:00ç­‰)");
        let ics = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//FeishuTool//CN\n";
        t1_events.forEach(e => {
            const pad2 = n => n<10 ? "0"+n : ""+n;
            const start = `${e.year}${pad2(e.month)}${pad2(e.day)}T${pad2(e.sh)}${pad2(e.sm)}00`;
            // å¤„ç†è·¨å¤©
            let endH = e.eh, endD = e.day;
            if(endH >= 24) { endH -= 24; endD += 1; } // ç®€åŒ–ç‰ˆï¼Œä¸å¤„ç†æœˆåº•è·¨æœˆï¼Œæ—¥å†è½¯ä»¶é€šå¸¸èƒ½å®¹é”™
            const end = `${e.year}${pad2(e.month)}${pad2(endD)}T${pad2(endH)}${pad2(e.em)}00`;
            
            ics += "BEGIN:VEVENT\n";
            ics += `DTSTART:${start}\nDTEND:${end}\nSUMMARY:ä¸Šç­\n`;
            ics += "END:VEVENT\n";
        });
        ics += "END:VCALENDAR";
        
        const blob = new Blob([ics], {type: "text/calendar;charset=utf-8"});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "schedule.ics";
        link.click();
    }

    // === åŠŸèƒ½ 2: ç­è¡¨å¯¹æ¯” ===
    function t2_renderInputs() {
        const n = $('in2_count').value;
        const container = $('in2_container');
        let html = '';
        for(let i=1; i<=n; i++) {
            html += `<div style="margin-top:8px; padding:8px; background:#f1f5f9; border-radius:4px;">
                <input id="in2_name_${i}" placeholder="æˆå‘˜ ${i} å§“å" style="width:120px; margin-bottom:5px;">
                <textarea id="in2_raw_${i}" style="height:60px; margin-bottom:0;" placeholder="æˆå‘˜ ${i} çš„æ’ç­æ•°æ® ${i===1?'(å¿…é¡»åŒ…å«æ—¥æœŸè¡Œ)':'(å¯åªåŒ…å«æ—¶é—´è¡Œ)'}"></textarea>
            </div>`;
        }
        container.innerHTML = html;
        bindAutoSave(); // é‡æ–°ç»‘å®šæ–°ç”Ÿæˆçš„è¾“å…¥æ¡†
    }

    function t2_compare() {
        try {
            const n = parseInt($('in2_count').value);
            let refDates = [];
            let schedules = []; // [{name, shifts:[]}]

            for(let i=1; i<=n; i++) {
                const raw = $(`in2_raw_${i}`).value;
                const name = $(`in2_name_${i}`).value || `æˆå‘˜${i}`;
                if(!raw.trim()) throw new Error(`è¯·å¡«å†™æˆå‘˜ ${i} çš„æ•°æ®`);
                
                const tokens = raw.split(/[\t\s]+/).filter(Boolean);
                
                // ç¬¬ä¸€ä¸ªäººä½œä¸ºåŸºå‡†ï¼Œæå–æ—¥æœŸ
                if(i === 1) {
                   // ç®€å•æå–é€»è¾‘ï¼šæ‰¾åˆ°æ‰€æœ‰çš„æ’ç­ä»£ç å’Œæ—¥æœŸ
                   const parsed = parseFeishuLines(raw); // å¤ç”¨è§£æå™¨
                   refDates = parsed.dateTokens.map((d, idx) => `${d}(${parsed.weekTokens[idx]||''})`);
                   schedules.push({ name, shifts: parsed.shiftTokens });
                } else {
                   // å…¶ä»–äººåªå–æœ€åä¸€è¡Œï¼ˆå‡å®šæ˜¯æ—¶é—´è¡Œï¼‰
                   const lines = raw.split(/[\r\n]+/).filter(Boolean);
                   const lastLine = lines[lines.length-1];
                   const shifts = lastLine.split(/[\t\s]+/).filter(Boolean);
                   schedules.push({ name, shifts });
                }
            }

            // å¼€å§‹å¯¹æ¯”
            let commonDays = [];
            let sameShiftDays = [];
            
            const len = Math.min(refDates.length, ...schedules.map(s=>s.shifts.length));
            
            for(let i=0; i<len; i++) {
                const currentShifts = schedules.map(s => s.shifts[i]);
                const isAllWork = currentShifts.every(s => /\d{1,2}:\d{2}/.test(s)); // éƒ½æ˜¯æ—¶é—´æ ¼å¼
                
                if(isAllWork) {
                    commonDays.push(refDates[i]);
                    // æ£€æŸ¥æ˜¯å¦å…¨åŒ
                    const first = currentShifts[0];
                    if(currentShifts.every(s => s === first)) {
                        sameShiftDays.push(`${refDates[i]} [${formatShift(first)}]`);
                    }
                }
            }

            let res = `å¯¹æ¯”äººæ•°: ${n}\n`;
            res += `å…±åŒä¸Šç­å¤©æ•°: ${commonDays.length} å¤©\n`;
            res += `å®Œå…¨åŒç­æ¬¡å¤©æ•°: ${sameShiftDays.length} å¤©\n\n`;
            if(sameShiftDays.length) {
                res += "=== åŒç­æ¬¡æ—¥æœŸ ===\n" + sameShiftDays.join('\n');
            } else {
                res += "æ— å®Œå…¨ç›¸åŒçš„ç­æ¬¡æ—¥æœŸã€‚";
            }
            $('out2').value = res;
            setStatus('st2', 'å¯¹æ¯”å®Œæˆ');
        } catch(e) {
            setStatus('st2', e.message, 'error');
        }
    }
    
    // === åŠŸèƒ½ 3: ç­æ¬¡æŸ¥äºº ===
    function t3_parse() {
        const names = $('in3_names').value.split(/[\r\n]+/).map(n=>n.trim()).filter(Boolean);
        const shifts = $('in3_shifts').value.split(/[\r\n]+/).map(s=>s.trim()).filter(Boolean);
        const dateLabel = $('in3_dateLabel').value;
        
        if(names.length !== shifts.length) {
            return setStatus('st3', `è¡Œæ•°ä¸åŒ¹é…: å§“å ${names.length} è¡Œï¼Œç­æ¬¡ ${shifts.length} è¡Œ`, 'error');
        }
        
        const map = {}; // { "9:00": ["Name1", "Name2"] }
        shifts.forEach((s, i) => {
            const key = formatShift(s); // ç»Ÿä¸€æ ¼å¼
            if(!map[key]) map[key] = [];
            map[key].push(names[i]);
        });
        
        let out = dateLabel ? `æ—¥æœŸï¼š${dateLabel}\n\n` : "";
        // æ’åºé”®å€¼
        Object.keys(map).sort().forEach(k => {
            out += `ã€${k}ã€‘ (${map[k].length}äºº):\n`;
            out += map[k].join(', ') + "\n\n";
        });
        $('out3').value = out;
        setStatus('st3', 'æŸ¥è¯¢æˆåŠŸ');
    }

    // === åŠŸèƒ½ 4 & 5: çŸ©é˜µè§£æ ===
    let sheetData = null; // { days:[], staff:[ {name, codes:[]} ] }

    function t4_parse() {
        try {
            const dateText = $('in4_dates').value;
            const nameText = $('in4_names').value;
            const codeText = $('in4_codes').value;

            // 1. è§£ææ—¥æœŸè¡Œ
            const dLines = dateText.split(/[\r\n]+/).filter(Boolean);
            const days = dLines[0].split(/[\t\s]+/).filter(Boolean).map(d => {
                const m = d.match(/(\d+)æœˆ(\d+)æ—¥/) || d.match(/(\d+)/);
                return { raw: d, dayNum: m ? parseInt(m[2]||m[1]) : 0 };
            });

            // 2. è§£æå§“å
            const names = nameText.split(/[\r\n]+/).map(l=>l.trim()).filter(Boolean);
            
            // 3. è§£æä»£ç çŸ©é˜µ
            const cLines = codeText.split(/[\r\n]+/).map(l=>l.trim()).filter(Boolean);
            
            if(names.length !== cLines.length) throw new Error(`å§“åè¡Œæ•°(${names.length})ä¸ä»£ç è¡Œæ•°(${cLines.length})ä¸ä¸€è‡´`);
            
            const staff = names.map((n, i) => {
                const codes = cLines[i].split(/[\t\s]+/).filter(Boolean);
                return { name: n, codes };
            });

            sheetData = { days, staff };
            
            // å¡«å……ä¸‹æ‹‰æ¡†
            const dSel = $('sel4_day');
            dSel.innerHTML = '<option value="">é€‰æ‹©æ—¥æœŸ</option>';
            days.forEach((d, i) => {
                dSel.add(new Option(d.raw, i)); // value is index
            });

            setStatus('st4', 'è¡¨æ ¼è§£ææˆåŠŸï¼Œå¯è¿›è¡ŒæŸ¥è¯¢æˆ–ç»Ÿè®¡');
            
            // è”åŠ¨æ›´æ–°ä»£ç ä¸‹æ‹‰æ¡†ï¼ˆè·å–æ‰€æœ‰å‡ºç°çš„å”¯ä¸€ä»£ç ï¼‰
            const allCodes = new Set();
            staff.forEach(s => s.codes.forEach(c => allCodes.add(c)));
            const cSel = $('sel4_code');
            cSel.innerHTML = '<option value="">é€‰æ‹©ä»£ç </option>';
            Array.from(allCodes).sort().forEach(c => cSel.add(new Option(c, c)));

        } catch(e) {
            setStatus('st4', e.message, 'error');
            sheetData = null;
        }
    }

    function t4_query() {
        if(!sheetData) return setStatus('st4', 'è¯·å…ˆç‚¹å‡»è§£æè¡¨æ ¼', 'error');
        const dayIdx = $('sel4_day').value;
        const targetCode = $('sel4_code').value;
        
        if(dayIdx === "" || !targetCode) return;
        
        const dateLabel = sheetData.days[dayIdx].raw;
        const results = [];
        
        sheetData.staff.forEach(s => {
            const c = s.codes[dayIdx]; // è·å–è¯¥äººåœ¨è¯¥åˆ—çš„ä»£ç 
            if(c === targetCode) results.push(s.name);
        });
        
        $('out4').value = `${dateLabel} ä»£ç  [${targetCode}] äººå‘˜åå• (${results.length}äºº):\n\n` + results.map(n=>"- "+n).join('\n');
    }
    
    function t4_clear() {
        $('in4_dates').value=''; $('in4_names').value=''; $('in4_codes').value='';
        saveState('in4_dates',''); saveState('in4_names',''); saveState('in4_codes','');
        sheetData = null;
    }

    // === åŠŸèƒ½ 5 ===
    function t5_stats() {
        if(!sheetData) {
            // å°è¯•è‡ªåŠ¨è§£æä¸€æ¬¡
            t4_parse(); 
            if(!sheetData) return setStatus('st5', 'è¯·å…ˆåœ¨åŠŸèƒ½4ä¸­ç²˜è´´æ•°æ®å¹¶è§£æ', 'error');
        }
        
        const target = $('in5_code').value.trim().toUpperCase();
        if(!target) return;
        
        let list = [];
        sheetData.staff.forEach(s => {
            let count = 0;
            s.codes.forEach(c => {
                if(c.toUpperCase() === target) count++;
            });
            if(count > 0) list.push({ name: s.name, count });
        });
        
        list.sort((a,b) => b.count - a.count); // é™åº
        
        let out = `å…¨æœˆ [${target}] ç»Ÿè®¡æ¦œ:\n\n`;
        list.forEach(item => {
            out += `${item.name}: \t${item.count}æ¬¡\n`;
        });
        
        $('out5').value = out;
        setStatus('st5', 'ç»Ÿè®¡å®Œæˆ');
    }

    // === åˆå§‹åŒ– ===
    // Tab åˆ‡æ¢é€»è¾‘
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            $(btn.dataset.target).classList.add('active');
        });
    });
    
    // åˆå§‹åŒ–
    t2_renderInputs();
    bindAutoSave();

    // å¯¼å‡ºç»™ HTML è°ƒç”¨
    return {
        t1_parse, t1_downloadICS, copy: copyText, clear: (id) => {$(id).value=''; saveState(id,'');},
        t2_renderInputs, t2_compare, t2_clear: () => { document.querySelectorAll('#in2_container input, #in2_container textarea').forEach(el=>{el.value='';saveState(el.id,'')}); },
        t3_parse,
        t4_parse, t4_query, t4_clear,
        t5_stats
    };

})();
</script>
</body>
</html>
