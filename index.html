<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>é£ä¹¦æ’ç­è¶…çº§åŠ©æ‰‹ Â· æ™ºèƒ½ä¿®æ­£ç‰ˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { --primary: #2563eb; --bg: #f8fafc; --panel-bg: #ffffff; --border: #e2e8f0; --text: #1e293b; }
    body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 20px; line-height: 1.5; }
    .app-container { max-width: 1000px; margin: 0 auto; background: var(--panel-bg); border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); overflow: hidden; }
    .header { background: #1e293b; color: white; padding: 20px; }
    .tabs { display: flex; background: #334155; overflow-x: auto; }
    .tab-btn { flex: 1; border: none; background: none; color: #cbd5e1; padding: 12px; cursor: pointer; white-space: nowrap; }
    .tab-btn.active { color: white; background: #1e293b; font-weight: bold; border-bottom: 3px solid var(--primary); }
    .content-area { padding: 24px; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    textarea, input, select { width: 100%; box-sizing: border-box; border: 1px solid var(--border); border-radius: 6px; padding: 10px; margin-bottom: 10px; font-family: monospace; }
    .btn { padding: 8px 16px; border-radius: 6px; border: 1px solid #ccc; cursor: pointer; background: white; margin-right: 10px; }
    .btn-primary { background: var(--primary); color: white; border-color: var(--primary); }
    .status-msg { margin-top: 5px; font-size: 13px; font-weight: bold; }
    .status-msg.ok { color: #16a34a; }
    .status-msg.error { color: #dc2626; }
    .hint { font-size: 12px; color: #64748b; display: block; margin-bottom: 4px; }
  </style>
</head>
<body>

<div class="app-container">
  <div class="header">
    <h1 style="margin:0;font-size:18px;">ğŸ“… é£ä¹¦æ’ç­åŠ©æ‰‹ (V2.0 æ™ºèƒ½ä¿®æ­£ç‰ˆ)</h1>
    <p style="margin:5px 0 0;font-size:12px;opacity:0.8;">å·²ä¿®å¤â€œæ—¥æœŸç²˜è¿â€å’Œâ€œæ ¼å¼é”™ä¹±â€é—®é¢˜</p>
  </div>
  
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('t4')">æŒ‰æ—¥æœŸæŸ¥ä»£ç  / ç»Ÿè®¡</button>
    <button class="tab-btn" onclick="switchTab('t1')">å•äººç­è¡¨</button>
  </div>

  <div class="content-area">

    <div id="t4" class="tab-content active">
      <div style="border:1px solid #e2e8f0; padding:15px; border-radius:8px; margin-bottom:20px;">
        <h3 style="margin-top:0;color:#2563eb;">ç¬¬ä¸€æ­¥ï¼šç²˜è´´æ•°æ®ï¼ˆä¸‰åŒºç²˜è´´æ³•ï¼‰</h3>
        
        <span class="hint">â‘  ç²˜è´´æ—¥æœŸè¡Œ (å³ä½¿æ˜¯ 12æœˆ1æ—¥12æœˆ2æ—¥... è¿åœ¨ä¸€èµ·ä¹Ÿæ²¡å…³ç³»)</span>
        <textarea id="in4_dates" style="height:60px;" placeholder="ç²˜è´´ï¼š12æœˆ1æ—¥ 12æœˆ2æ—¥..."></textarea>
        
        <span class="hint">â‘¡ ç²˜è´´å§“ååˆ— (ä»ä½ çš„æ•°æ®ä¸ŠåŠéƒ¨åˆ†å¤åˆ¶åå­—)</span>
        <textarea id="in4_names" style="height:100px;" placeholder="ç²˜è´´ï¼š&#10;Candace Cheng ç¨‹å®‰é¡º&#10;Rex Phoon å†¯å‹‹åº†&#10;..."></textarea>
        
        <span class="hint">â‘¢ ç²˜è´´æ’ç­ä»£ç å— (ä»ä½ çš„æ•°æ®ä¸‹åŠéƒ¨åˆ†å¤åˆ¶ OFF REST 9:00...)</span>
        <textarea id="in4_codes" style="height:150px;" placeholder="ç²˜è´´ï¼š&#10;OFF REST 9:00...&#10;OFF REST 15:00..."></textarea>
        
        <button class="btn btn-primary" onclick="App.t4_parse()">è§£æè¡¨æ ¼</button>
        <button class="btn" onclick="App.clear4()">æ¸…ç©º</button>
        <div id="st4" class="status-msg"></div>
      </div>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
        <div>
           <h4 style="margin:0 0 10px 0;">æŸ¥è¯¢æŸæ—¥æŸç­æ¬¡</h4>
           <div style="display:flex; gap:5px; margin-bottom:10px;">
             <select id="sel4_day"><option>å…ˆè§£æ</option></select>
             <select id="sel4_code"><option>å…ˆè§£æ</option></select>
             <button class="btn btn-primary" onclick="App.t4_query()" style="padding:5px 10px;">æŸ¥</button>
           </div>
           <textarea id="out4" style="height:200px; background:#f1f5f9;" readonly></textarea>
        </div>
        <div>
           <h4 style="margin:0 0 10px 0;">å…¨æœˆç»Ÿè®¡æ’è¡Œæ¦œ</h4>
           <div style="display:flex; gap:5px; margin-bottom:10px;">
             <input id="in5_code" value="MC" placeholder="ä»£ç " style="width:80px;">
             <button class="btn btn-primary" onclick="App.t5_stats()" style="padding:5px 10px;">ç»Ÿè®¡</button>
           </div>
           <textarea id="out5" style="height:200px; background:#f1f5f9;" readonly></textarea>
        </div>
      </div>
    </div>

    <div id="t1" class="tab-content">
      <textarea id="in1_raw" style="height:100px;" placeholder="é€‚åˆå¤åˆ¶å•äººçš„é‚£ä¸‰è¡Œï¼šæ—¥æœŸ+æ˜ŸæœŸ+æ—¶é—´"></textarea>
      <button class="btn btn-primary" onclick="App.t1_parse()">ç”Ÿæˆ</button>
      <textarea id="out1" style="height:150px; margin-top:10px;"></textarea>
    </div>

  </div>
</div>

<script>
function switchTab(id){
    document.querySelectorAll('.tab-content').forEach(d=>d.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    event.target.classList.add('active');
}

const App = (function(){
    const $ = id => document.getElementById(id);
    const setStatus = (id, msg, type) => { $(id).innerHTML = msg; $(id).className = `status-msg ${type}`; };
    let sheetData = null;

    // === æ ¸å¿ƒä¿®å¤ï¼šæ™ºèƒ½æ—¥æœŸæå– ===
    function extractDates(text) {
        // 1. å°è¯•åŒ¹é… "12æœˆ1æ—¥" è¿™ç§æ ¼å¼ï¼ˆå…¼å®¹æœ‰æ— ç©ºæ ¼ï¼‰
        // ä½¿ç”¨ matchAll æˆ–å…¨å±€ matchï¼Œä¸“é—¨æå– æ—¥æœŸæ ¼å¼
        const regex = /(\d{1,2})\s*[æœˆ\/-]\s*(\d{1,2})/g;
        const matches = [...text.matchAll(regex)];
        
        if (matches.length > 0) {
            return matches.map((m, index) => ({
                raw: m[0],
                month: parseInt(m[1]),
                day: parseInt(m[2]),
                index: index
            }));
        }
        
        // 2. å¦‚æœæ²¡æ‰¾åˆ°ä¸­æ–‡æ—¥æœŸï¼Œå°è¯•ç®€å•çš„æ•°å­—åˆ†å‰²ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
        const tokens = text.split(/[\s\t]+/).filter(t => /^\d+$/.test(t));
        if(tokens.length > 20) {
            return tokens.map((t, i) => ({ raw: t+"æ—¥", day: parseInt(t), index: i }));
        }
        return [];
    }

    // === æ ¸å¿ƒä¿®å¤ï¼šæ›´å¼ºçš„è¡Œå¤„ç† ===
    function cleanLines(text) {
        return text.split(/[\r\n]+/)
                   .map(l => l.trim())
                   .filter(l => l && !/^\d+(\s+\d+)*$/.test(l)) // è¿‡æ»¤æ‰å…¨æ˜¯æ•°å­—çš„ç»Ÿè®¡è¡Œ (å¦‚ 33 36 40...)
                   .filter(l => !l.includes("å‰éš†å¡")); // è¿‡æ»¤æ‰ä¹±ä¸ƒå…«ç³Ÿçš„è¡¨å¤´
    }

    function t4_parse() {
        try {
            const dateText = $('in4_dates').value;
            const nameText = $('in4_names').value;
            const codeText = $('in4_codes').value;

            if(!dateText || !nameText || !codeText) throw new Error("è¯·ç¡®ä¿ä¸‰ä¸ªåŒºåŸŸéƒ½ç²˜è´´äº†å†…å®¹");

            // 1. è§£ææ—¥æœŸ (æ™ºèƒ½ç‰ˆ)
            const days = extractDates(dateText);
            if(days.length === 0) throw new Error("æœªè¯†åˆ«åˆ°æ—¥æœŸï¼Œè¯·ç¡®è®¤ç²˜è´´äº†åŒ…å« 'XæœˆXæ—¥' çš„å†…å®¹");

            // 2. è§£æåå­— (è¿‡æ»¤æ‰ç©ºè¡Œ)
            // é’ˆå¯¹ä½ çš„æ•°æ®ï¼Œåå­—å¯èƒ½å¤¹æ‚èŒåŠ¡ï¼Œè¿™é‡Œç®€å•ä¿ç•™æ‰€æœ‰çœ‹èµ·æ¥åƒåå­—çš„è¡Œ
            const names = nameText.split(/[\r\n]+/)
                                  .map(l=>l.trim())
                                  .filter(l => l.length > 0 && !/^(ç™½|ä¸­|æ™š|å¤œ|TICKET|VIP|å¤§å®¢æˆ·)/.test(l)); // è¿‡æ»¤æ‰æ˜æ˜¾ä¸æ˜¯åå­—çš„è¡Œ

            // 3. è§£æä»£ç çŸ©é˜µ
            // ä½ çš„ä»£ç æ•°æ®é‡Œæœ‰å¾ˆå¤šé‡å¤çš„æ—¥æœŸå¤´ï¼Œæˆ‘ä»¬éœ€è¦åªæå–åŒ…å«æ’ç­ä»£ç çš„è¡Œ
            const allCodeLines = codeText.split(/[\r\n]+/).map(l=>l.trim());
            const validCodeLines = allCodeLines.filter(line => {
                // è¿™ä¸€è¡Œå¿…é¡»åŒ…å«æ—¶é—´(9:00)æˆ–è€…ä»£ç (OFF, REST, MC)
                return /\d{1,2}:\d{2}|OFF|REST|MC|AL/.test(line) && !/æœˆ\d+æ—¥/.test(line);
            });

            // æ ¡éªŒè¡Œæ•°
            // å¦‚æœåå­—æ¯”ä»£ç è¡Œå¤šï¼Œæˆªå–åå­—ï¼›å¦‚æœä»£ç è¡Œå¤šï¼Œæˆªå–ä»£ç ã€‚å°½é‡å¯¹é½ã€‚
            const count = Math.min(names.length, validCodeLines.length);
            if(count === 0) throw new Error("æœªæ‰¾åˆ°æœ‰æ•ˆçš„æ’ç­ä»£ç è¡Œ");

            const staff = [];
            for(let i=0; i<count; i++) {
                // åˆ†å‰²æ¯ä¸€è¡Œçš„ä»£ç 
                // ä½ çš„æ•°æ®ä»£ç è¡Œæ˜¯ç”¨ Tab åˆ†éš”çš„ï¼Œæˆ–è€…ç©ºæ ¼
                const tokens = validCodeLines[i].split(/[\t\s]+/).filter(Boolean);
                staff.push({ name: names[i], codes: tokens });
            }

            sheetData = { days, staff };

            // UI æ›´æ–°
            const dSel = $('sel4_day');
            dSel.innerHTML = '<option value="">é€‰æ‹©æ—¥æœŸ</option>';
            days.forEach((d, i) => dSel.add(new Option(`${d.month}æœˆ${d.day}æ—¥`, i)));

            const cSel = $('sel4_code');
            const uniqueCodes = new Set();
            staff.forEach(s => s.codes.forEach(c => uniqueCodes.add(c)));
            cSel.innerHTML = '<option value="">é€‰æ‹©ä»£ç </option>';
            Array.from(uniqueCodes).sort().forEach(c => cSel.add(new Option(c,c)));

            setStatus('st4', `è§£ææˆåŠŸï¼åŒ¹é…åˆ° ${count} äººï¼Œ${days.length} å¤©çš„æ•°æ®ã€‚`, 'ok');

        } catch(e) {
            setStatus('st4', e.message, 'error');
            console.error(e);
        }
    }

    function t4_query() {
        if(!sheetData) return;
        const dayIdx = $('sel4_day').value;
        const code = $('sel4_code').value;
        if(dayIdx==="" || !code) return;

        const dayInfo = sheetData.days[dayIdx];
        const res = sheetData.staff.filter(s => s.codes[dayIdx] === code).map(s => s.name);
        
        $('out4').value = `${dayInfo.month}æœˆ${dayInfo.day}æ—¥ - ${code} (${res.length}äºº):\n\n` + res.join('\n');
    }

    function t5_stats() {
        if(!sheetData) { t4_parse(); if(!sheetData) return; }
        const code = $('in5_code').value.toUpperCase();
        
        const list = sheetData.staff.map(s => {
            let cnt = 0;
            // éå†æ‰€æœ‰å¤©æ•°ï¼Œé˜²æ­¢ä»£ç è¡Œé•¿åº¦è¶…è¿‡æ—¥æœŸæ•°
            for(let i=0; i<sheetData.days.length; i++) {
                if((s.codes[i]||"").toUpperCase() === code) cnt++;
            }
            return { name: s.name, count: cnt };
        }).filter(x => x.count > 0).sort((a,b) => b.count - a.count);

        $('out5').value = `å…¨æœˆ [${code}] ç»Ÿè®¡:\n\n` + list.map(x => `${x.name}: ${x.count}`).join('\n');
    }

    function t1_parse() {
        // ç®€æ˜“å•äººè§£æï¼Œåˆ©ç”¨æ–°çš„ extractDates
        try {
            const raw = $('in1_raw').value;
            const days = extractDates(raw);
            const lines = raw.split(/[\r\n]+/).filter(l => /\d{1,2}:\d{2}|OFF/.test(l));
            if(!lines.length) return;
            const shifts = lines[0].split(/[\t\s]+/).filter(Boolean);
            
            let out = "";
            for(let i=0; i<Math.min(days.length, shifts.length); i++) {
                out += `${days[i].month}æœˆ${days[i].day}æ—¥: ${shifts[i]}\n`;
            }
            $('out1').value = out;
        } catch(e) { alert("è§£æé”™è¯¯"); }
    }

    return { t4_parse, t4_query, t5_stats, t1_parse, clear4: ()=> { $('in4_dates').value=''; $('in4_names').value=''; $('in4_codes').value=''; } };
})();
</script>
</body>
</html>
