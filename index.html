<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>é£ä¹¦æ’ç­å¯è§†åŒ–çœ‹æ¿ Â· V5.0 (ä¿®å¤ä¸ç»Ÿè®¡å¢å¼º)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { --primary: #2563eb; --bg: #f1f5f9; --text: #1e293b; --border: #cbd5e1; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); padding: 20px; margin: 0; }
    
    /* å®¹å™¨å¸ƒå±€ */
    .app-container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); overflow: hidden; display: flex; flex-direction: column; min-height: 90vh; }
    
    .header { background: #1e293b; color: white; padding: 15px 20px; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
    .header h1 { margin: 0; font-size: 18px; display: flex; align-items: center; gap: 10px; }
    .badge { background: #f59e0b; color: #000; font-size: 12px; padding: 2px 6px; border-radius: 4px; font-weight: bold; }

    /* Tabs æ ·å¼ */
    .tabs { display: flex; background: #f8fafc; border-bottom: 1px solid var(--border); }
    .tab-btn { flex: 1; border: none; background: none; color: #64748b; padding: 12px; cursor: pointer; white-space: nowrap; font-weight: 500; transition: 0.2s; max-width: 300px; }
    .tab-btn.active { color: var(--primary); background: white; font-weight: bold; border-bottom: 3px solid var(--primary); }

    /* å†…å®¹åŒºåŸŸ */
    .content-area { padding: 24px; flex-grow: 1; display: flex; flex-direction: column; }
    .tab-content { display: none; }
    .tab-content.active { display: flex; flex-direction: column; flex-grow: 1; }
    
    /* è¾“å…¥/è¾“å‡ºé€šç”¨æ ·å¼ */
    textarea { width: 100%; box-sizing: border-box; border: 1px solid #cbd5e1; border-radius: 6px; padding: 8px; font-size: 12px; font-family: monospace; resize: vertical; min-height: 80px; margin-bottom: 10px; }
    textarea:focus { outline: 2px solid var(--primary); border-color: transparent; }
    input[type="text"] { width: 100%; box-sizing: border-box; border: 1px solid #cbd5e1; border-radius: 6px; padding: 8px; margin-bottom: 10px; }
    
    .btn-group { display: flex; gap: 10px; margin-top: 10px; }
    .btn { background: white; border: 1px solid #cbd5e1; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; color: #334155; transition: 0.2s; }
    .btn-primary { background: var(--primary); color: white; border-color: var(--primary); }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-clear { background: #fee2e2; color: #b91c1c; border-color: #fecaca; }
    
    .status-msg { margin-top: 5px; font-size: 13px; font-weight: bold; padding: 10px; border-radius: 6px; }
    .status-msg.ok { color: #16a34a; background: #dcfce7; border: 1px solid #bbf7d0; }
    .status-msg.error { color: #dc2626; background: #fee2e2; border: 1px solid #fecaca; }

    /* T4/T5 å¯è§†åŒ–å¸ƒå±€ */
    .main-layout { display: flex; flex: 1; overflow: hidden; }
    .input-sidebar { width: 320px; background: #f8fafc; border-right: 1px solid var(--border); padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
    .visual-area { flex: 1; overflow: hidden; display: flex; flex-direction: column; position: relative; }
    .visual-placeholder { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #94a3b8; text-align: center; }
    .status-bar { padding: 8px 15px; background: #fff7ed; border-bottom: 1px solid #fed7aa; font-size: 12px; color: #9a3412; display: none; }
    .status-bar.show { display: block; }
    .table-wrapper { flex: 1; overflow: auto; position: relative; }
    
    /* è¡¨æ ¼æ ·å¼ */
    table { border-collapse: separate; border-spacing: 0; width: max-content; font-size: 12px; }
    th, td { border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; padding: 6px 10px; text-align: center; vertical-align: middle; white-space: nowrap; }
    thead { position: sticky; top: 0; z-index: 20; background: #f1f5f9; }
    thead th { background: #f1f5f9; font-weight: 600; color: #475569; border-bottom: 2px solid #cbd5e1; height: 30px; }
    tbody th { position: sticky; left: 0; z-index: 10; background: white; font-weight: bold; color: #1e293b; border-right: 2px solid #e2e8f0; min-width: 100px; text-align: left; }
    thead th:first-child { position: sticky; left: 0; z-index: 30; background: #f1f5f9; border-right: 2px solid #e2e8f0; }

    /* ç­æ¬¡è‰²å— */
    .cell-inner { border-radius: 4px; padding: 4px 8px; font-weight: 500; min-width: 40px; }
    .type-off { background-color: #f1f5f9; color: #94a3b8; } 
    .type-work { background-color: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }
    .type-night { background-color: #f3e8ff; color: #6b21a8; border: 1px solid #e9d5ff; }
    .type-leave { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
    .type-al { background-color: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
    .stats-col { font-weight: bold; background: #fffbeb; color: #92400e; }

    /* T2 ç­è¡¨æ¯”è¾ƒæ ·å¼ */
    .t2-input-group { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 10px; }
    .t2-person { border: 1px solid #e2e8f0; padding: 15px; border-radius: 8px; }
    .t2-person input { width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 5px; box-sizing: border-box; }
    .t2-person textarea { min-height: 100px; }

    /* T2/T3 è¾“å‡ºåŒº */
    .output-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .result-box { border: 1px solid #e2e8f0; padding: 15px; border-radius: 8px; background: #f8fafc; }
    .result-box h4 { margin-top: 0; color: #0f766e; }
    .result-box textarea { min-height: 250px; background: white; }
    
    /* T3 æœç´¢åŒº */
    .t3-search-group { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
    .t3-search-group input[type="text"] { flex-grow: 1; max-width: 200px; margin-bottom: 0; }
    .t3-search-group button { margin-top: 0; }

  </style>
</head>
<body>

<div class="app-container">
  <div class="header">
    <h1>é£ä¹¦æ’ç­å¯è§†åŒ–çœ‹æ¿ <span class="badge">V5.0</span></h1>
  </div>
  
  <div class="tabs">
    <button class="tab-btn" onclick="AppUI.switchTab('t4')">å¯è§†åŒ–æ’ç­è¡¨</button>
    <button class="tab-btn active" onclick="AppUI.switchTab('t1')">å•äººç­è¡¨ç”Ÿæˆ</button>
    <button class="tab-btn" onclick="AppUI.switchTab('t2')">å¤šäººç­è¡¨æ¯”è¾ƒ</button>
    <button class="tab-btn" onclick="AppUI.switchTab('t3')">ç­æ¬¡ç»Ÿè®¡æœç´¢</button>
  </div>

  <div class="content-area">

    <div id="t1" class="tab-content active" style="padding: 0;">
      <h3>ç²˜è´´å•äººæ’ç­æ•°æ® (æ—¥æœŸ+æ˜ŸæœŸ+ç­æ¬¡)</h3>
      <span style="font-size:12px; color:#64748b;">è¯·å¤åˆ¶ä¸‰è¡Œå®Œæ•´æ•°æ®ï¼Œä¾‹å¦‚ï¼š12æœˆ1æ—¥... æ˜ŸæœŸä¸€... 9:00...</span>
      <textarea id="in1_raw" style="min-height:150px; margin-top:5px;" placeholder="ç²˜è´´å•äººä¸‰è¡Œæ•°æ®"></textarea>
      <div class="btn-group">
        <button class="btn btn-primary" onclick="App.t1_parse()">ç”Ÿæˆæ¯æ—¥ç­è¡¨</button>
        <button class="btn" onclick="AppUI.clear1()">æ¸…ç©º</button>
      </div>
      <div id="st1" class="status-msg"></div>
      
      <h3 style="margin-top: 20px;">ç”Ÿæˆç»“æœ (æ¯æ—¥æ—¥æœŸ: ç­æ¬¡)</h3>
      <textarea id="out1" style="flex-grow:1; background:#f0f9ff;" readonly placeholder="ç”Ÿæˆç»“æœå°†åœ¨æ­¤æ˜¾ç¤º"></textarea>
    </div>

    <div id="t2" class="tab-content" style="padding: 0;">
        <h3>1. ç²˜è´´æ—¥æœŸè¡Œ (åªéœ€ä¸€æ¬¡)</h3>
        <textarea id="in2_dates" placeholder="ç²˜è´´ï¼š12æœˆ1æ—¥ 12æœˆ2æ—¥... (åªéœ€ä¸€æ¬¡)"></textarea>
        
        <h3>2. ç²˜è´´ç­æ¬¡è¡Œ (æœ€å¤š4äºº)</h3>
        <div class="t2-input-group">
            <div class="t2-person">
                <input id="in2_name1" placeholder="å§“å 1 (å¿…å¡«)" value="å‘˜å·¥ A">
                <textarea id="in2_raw1" placeholder="ç²˜è´´å‘˜å·¥ A çš„ç­æ¬¡è¡Œ"></textarea>
            </div>
            <div class="t2-person">
                <input id="in2_name2" placeholder="å§“å 2 (å¿…å¡«)" value="å‘˜å·¥ B">
                <textarea id="in2_raw2" placeholder="ç²˜è´´å‘˜å·¥ B çš„ç­æ¬¡è¡Œ"></textarea>
            </div>
            <div class="t2-person">
                <input id="in2_name3" placeholder="å§“å 3 (å¯é€‰)">
                <textarea id="in2_raw3" placeholder="ç²˜è´´å‘˜å·¥ C çš„ç­æ¬¡è¡Œ (å¯é€‰)"></textarea>
            </div>
            <div class="t2-person">
                <input id="in2_name4" placeholder="å§“å 4 (å¯é€‰)">
                <textarea id="in2_raw4" placeholder="ç²˜è´´å‘˜å·¥ D çš„ç­æ¬¡è¡Œ (å¯é€‰)"></textarea>
            </div>
        </div>
        <div class="btn-group">
            <button class="btn btn-primary" onclick="App.t2_compare()">ğŸ” æ¯”è¾ƒå…±åŒä¸Šç­æ—¶é—´</button>
            <button class="btn btn-clear" onclick="AppUI.clear2()">æ¸…ç©º</button>
        </div>
        <div id="st2" class="status-msg"></div>

        <h3 style="margin-top: 20px;">æ¯”è¾ƒç»“æœ</h3>
        <div class="output-grid">
            <div class="result-box">
                <h4>ğŸ‰ å…±åŒä¸Šç­æ—¥æœŸåˆ—è¡¨</h4>
                <textarea id="out2_list" readonly placeholder="å…±åŒä¸Šç­çš„æ—¥æœŸå’Œç­æ¬¡å°†åœ¨æ­¤æ˜¾ç¤º"></textarea>
            </div>
            <div class="result-box">
                <h4>ğŸ“Š æ€»ç»“</h4>
                <textarea id="out2_summary" readonly placeholder="æ€»è®¡å…±åŒä¸Šç­å¤©æ•°"></textarea>
            </div>
        </div>
    </div>

    <div id="t3" class="tab-content" style="padding: 0;">
        <h3>1. ç²˜è´´å…¨éƒ¨äººå‘˜åå• (å§“ååˆ—)</h3>
        <textarea id="in3_names" placeholder="ç²˜è´´å§“ååˆ—ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰"></textarea>
        
        <h3>2. ç²˜è´´å…¨éƒ¨ç­æ¬¡çŸ©é˜µ (ä»£ç è¡Œ)</h3>
        <textarea id="in3_codes" style="min-height:150px;" placeholder="ç²˜è´´å…¨éƒ¨äººå‘˜çš„ç­æ¬¡ä»£ç è¡Œ"></textarea>
        
        <h3>3. æœç´¢ç‰¹å®šç­æ¬¡ä»£ç </h3>
        <div class="t3-search-group">
            <input type="text" id="in3_search" placeholder="ä¾‹å¦‚: MC, 9:00, AL" value="MC">
            <button class="btn btn-primary" onclick="App.t3_search()">ğŸ” å¼€å§‹æœç´¢ç»Ÿè®¡</button>
            <button class="btn btn-clear" onclick="AppUI.clear3()">æ¸…ç©º</button>
        </div>
        <div id="st3" class="status-msg"></div>

        <h3 style="margin-top: 20px;">ç»Ÿè®¡ç»“æœ</h3>
        <div class="output-grid">
            <div class="result-box">
                <h4>ğŸ‘¤ æ¶‰åŠäººå‘˜åå•åŠæ¬¡æ•°</h4>
                <textarea id="out3_list" readonly placeholder="å°†æ˜¾ç¤ºåŒ¹é…äººå‘˜å’Œä»–ä»¬å‡ºç°çš„æ¬¡æ•°"></textarea>
            </div>
            <div class="result-box">
                <h4>ğŸ“Š æ€»ç»“</h4>
                <textarea id="out3_summary" readonly placeholder="æ€»è®¡æ¬¡æ•°ã€æ€»è®¡äººæ•°"></textarea>
            </div>
        </div>
    </div>

    <div id="t4" class="tab-content main-layout">
        <div class="input-sidebar">
          <h3 style="margin-top: 0;">1. æ—¥æœŸæ•°æ®</h3>
          <textarea id="in_dates" placeholder="ç²˜è´´ï¼š12æœˆ1æ—¥ 12æœˆ2æ—¥..."></textarea>
          
          <h3>2. å§“ååˆ—è¡¨</h3>
          <textarea id="in_names" placeholder="ç²˜è´´å§“ååˆ—ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰" style="height:120px;"></textarea>
          
          <h3>3. ç­æ¬¡çŸ©é˜µ</h3>
          <textarea id="in_codes" placeholder="ç²˜è´´å…¨æœˆç­æ¬¡ä»£ç ..." style="height:150px;"></textarea>
          
          <div style="margin-top:auto;">
            <button class="btn btn-primary" onclick="App.t4_render()">ğŸš€ ç”Ÿæˆå¯è§†åŒ–å›¾è¡¨</button>
            <button class="btn btn-clear" onclick="AppUI.clear4()">ğŸ—‘ æ¸…ç©ºæ•°æ®</button>
          </div>
        </div>

        <div class="visual-area">
          <div id="status_msg_t4" class="status-bar"></div>
          <div id="visual_placeholder" class="visual-placeholder">
            <div style="font-size:40px; margin-bottom:10px;">ğŸ“Š</div>
            <div>åœ¨å·¦ä¾§ç²˜è´´æ•°æ®å¹¶ç‚¹å‡»â€œç”Ÿæˆâ€<br>å³å¯æŸ¥çœ‹å¸¦æœ‰é¢œè‰²ç¼–ç çš„æ’ç­è¡¨</div>
          </div>
          <div id="table_container" class="table-wrapper" style="display:none;">
            </div>
        </div>
    </div>

  </div>
</div>

<script>
// UI è¾…åŠ©å‡½æ•°
const AppUI = (function(){
    const $ = id => document.getElementById(id);
    const setStatus = (id, msg, type) => { 
        const el = $(id);
        el.textContent = msg; 
        el.className = `status-msg ${type}`; 
        el.style.display = 'block';
    };
    const hideStatus = (id) => { $(id).style.display = 'none'; };

    function switchTab(id){
        document.querySelectorAll('.tab-content').forEach(d=>d.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelector(`.tabs button[onclick*="${id}"]`).classList.add('active');
        // ç¡®ä¿åˆ‡æ¢ Tab æ—¶çŠ¶æ€æ æ¸…ç©º
        hideStatus('st1');
        hideStatus('st2');
        hideStatus('st3');
        hideStatus('status_msg_t4');
        App.loadSavedData(); // åˆ‡æ¢åˆ° T4 æ—¶åŠ è½½æ•°æ®
    }

    // æ¸…ç©ºå‡½æ•°
    function clear1() { $('in1_raw').value = ''; $('out1').value = ''; hideStatus('st1'); }
    function clear2() { 
        $('in2_dates').value = '';
        for(let i=1; i<=4; i++) {
            $(`in2_name${i}`).value = i === 1 ? "å‘˜å·¥ A" : i === 2 ? "å‘˜å·¥ B" : "";
            $(`in2_raw${i}`).value = "";
        }
        $('out2_list').value = '';
        $('out2_summary').value = '';
        hideStatus('st2');
    }
    function clear3() {
        $('in3_names').value = '';
        $('in3_codes').value = '';
        $('in3_search').value = 'MC';
        $('out3_list').value = '';
        $('out3_summary').value = '';
        hideStatus('st3');
    }
    function clear4() { 
        $('in_dates').value = ''; $('in_names').value = ''; $('in_codes').value = '';
        localStorage.removeItem('fs_dates');
        localStorage.removeItem('fs_names');
        localStorage.removeItem('fs_codes');
        $('table_container').style.display = 'none';
        $('visual_placeholder').style.display = 'block';
        hideStatus('status_msg_t4');
    }
    
    // çŠ¶æ€æç¤ºï¼ˆT4 ä¸“ç”¨ï¼‰
    function msgT4(text, isError=false) {
        const el = $('status_msg_t4');
        el.textContent = text;
        el.style.backgroundColor = isError ? '#fee2e2' : '#dcfce7';
        el.style.color = isError ? '#991b1b' : '#166534';
        el.classList.add('show');
        setTimeout(() => el.classList.remove('show'), 5000);
    }

    return { switchTab, setStatus, hideStatus, clear1, clear2, clear3, clear4, msgT4 };
})();

// æ ¸å¿ƒåŠŸèƒ½é€»è¾‘
const App = (function(){
    const $ = id => document.getElementById(id);
    
    // --- é€šç”¨è§£æå‡½æ•° ---
    function extractDates(text) {
        const dateRegex = /(\d{1,2})\s*[æœˆ\/-]\s*(\d{1,2})/g;
        const matches = [...text.matchAll(dateRegex)];
        
        if (matches.length > 0) {
            return matches.map(m => ({
                month: parseInt(m[1]), 
                day: parseInt(m[2]), 
                full: `${m[1]}æœˆ${m[2]}æ—¥`
            }));
        }
        return [];
    }

    function extractCodes(text) {
        const lines = text.split(/[\r\n]+/)
            .map(l => l.trim())
            .filter(l => /\d{1,2}:\d{2}|OFF|REST|MC|AL|PH/.test(l)); 
        
        if (lines.length === 0) return [];

        let codeLine = lines.find(l => !/æœˆ\d+æ—¥|æ˜ŸæœŸ/.test(l));

        if (!codeLine && lines.length > 0) {
            codeLine = lines[lines.length - 1];
        } else if (!codeLine) {
            return [];
        }

        return codeLine.split(/[\t\s]+/).filter(Boolean);
    }

    // --- æ•°æ®æŒä¹…åŒ– (T4 ä¿®å¤ Bug 2) ---
    function saveT4() {
        localStorage.setItem('fs_dates', $('in_dates').value);
        localStorage.setItem('fs_names', $('in_names').value);
        localStorage.setItem('fs_codes', $('in_codes').value);
    }
    function loadSavedData() {
        $('in_dates').value = localStorage.getItem('fs_dates') || '';
        $('in_names').value = localStorage.getItem('fs_names') || '';
        $('in_codes').value = localStorage.getItem('fs_codes') || '';
    }
    window.onload = loadSavedData;

    // --- Tab 1: å•äººç­è¡¨ç”Ÿæˆ ---
    function t1_parse() {
        AppUI.hideStatus('st1');
        $('out1').value = "";
        try {
            const raw = $('in1_raw').value;
            if (!raw.trim()) throw new Error("è¾“å…¥å†…å®¹ä¸ºç©ºã€‚è¯·ç²˜è´´ä¸‰è¡Œæ•°æ®ã€‚");

            const days = extractDates(raw);
            const shifts = extractCodes(raw);

            if(days.length === 0) throw new Error("è§£æå¤±è´¥ï¼šæœªè¯†åˆ«åˆ°æ—¥æœŸ (å¦‚ 12æœˆ1æ—¥)ã€‚");
            if(shifts.length === 0) throw new Error("è§£æå¤±è´¥ï¼šæœªè¯†åˆ«åˆ°ç­æ¬¡ä»£ç  (å¦‚ 9:00, OFF)ã€‚");
            
            let out = "";
            let count = Math.min(days.length, shifts.length);
            for(let i=0; i<count; i++) {
                out += `${days[i].full}: ${shifts[i]}\n`;
            }

            $('out1').value = out;
            if (days.length !== shifts.length) {
                 AppUI.setStatus('st1', `è§£ææˆåŠŸï¼ä½†æ—¥æœŸæ•° (${days.length}) ä¸ç­æ¬¡æ•° (${shifts.length}) ä¸åŒ¹é…ï¼Œå·²æŒ‰æœ€å°‘æ•°é‡åŒ¹é… ${count} å¤©ã€‚`, 'error');
            } else {
                AppUI.setStatus('st1', `è§£ææˆåŠŸï¼å…±åŒ¹é… ${count} å¤©æ•°æ®ã€‚`, 'ok');
            }
            

        } catch(e) {
            $('out1').value = "";
            AppUI.setStatus('st1', e.message, 'error');
            console.error(e);
        }
    }

    // --- Tab 2: å¤šäººç­è¡¨æ¯”è¾ƒ (ä¿®å¤ Bug 1) ---
    function t2_compare() {
        AppUI.hideStatus('st2');
        $('out2_list').value = '';
        $('out2_summary').value = '';

        try {
            const dateText = $('in2_dates').value.trim();
            if (!dateText) throw new Error("è¯·å…ˆåœ¨é¡¶éƒ¨ç²˜è´´æ—¥æœŸè¡Œã€‚");
            const days = extractDates(dateText);
            if(days.length === 0) throw new Error("æ—¥æœŸè¡Œè§£æå¤±è´¥ã€‚è¯·ç¡®ä¿æ ¼å¼æ­£ç¡® (å¦‚ 12æœˆ1æ—¥)ã€‚");
            
            const people = [];
            for (let i = 1; i <= 4; i++) {
                const name = $(`in2_name${i}`).value.trim();
                const raw = $(`in2_raw${i}`).value.trim();
                if (raw) {
                    if(!name) throw new Error(`å‘˜å·¥ ${i} çš„å§“åä¸èƒ½ä¸ºç©ºã€‚`);
                    people.push({ name, raw });
                }
            }

            if (people.length < 2) throw new Error("è¯·è‡³å°‘è¾“å…¥ä¸¤ä½å‘˜å·¥çš„ç­æ¬¡æ•°æ®è¿›è¡Œæ¯”è¾ƒã€‚");

            // 1. è§£ææ‰€æœ‰äººçš„ç­è¡¨ä¸º Map (æ—¥æœŸç´¢å¼• => ç­æ¬¡)
            const schedules = [];
            const dayKeys = days.map(d => d.full);

            for (const p of people) {
                const codes = extractCodes(p.raw);
                
                if (codes.length < dayKeys.length) {
                    throw new Error(`è§£æ ${p.name} çš„ç­è¡¨å¤±è´¥ï¼šç­æ¬¡æ•°é‡ (${codes.length}) å°‘äºæ—¥æœŸæ•°é‡ (${dayKeys.length})ã€‚`);
                }

                const scheduleMap = new Map();
                for(let i=0; i < dayKeys.length; i++) {
                    // ä»…ä½¿ç”¨å‰ n ä¸ªç­æ¬¡ï¼Œä¸æ—¥æœŸå¯¹é½
                    scheduleMap.set(dayKeys[i], codes[i].toUpperCase());
                }
                schedules.push({ name: p.name, schedule: scheduleMap });
            }
            
            // 2. æ¯”è¾ƒå…±åŒä¸Šç­æ—¶é—´
            let commonWorkingDays = [];

            for (const dateKey of dayKeys) {
                let isWorking = true;
                let shifts = [];

                for (const p of schedules) {
                    const shift = p.schedule.get(dateKey);
                    // æ£€æŸ¥æ˜¯å¦ä¼‘æ¯æˆ–è¯·å‡ (å®½æ¾æ£€æŸ¥ï¼Œåªè¦ä¸æ˜¯ä¼‘æ¯å°±ç®—ä¸Šç­)
                    if (!shift || /OFF|REST|MC|AL|PH|UPL|LATE/.test(shift)) {
                        isWorking = false;
                        break;
                    }
                    shifts.push(shift);
                }

                if (isWorking) {
                    // æ˜¾ç¤ºæ‰€æœ‰äººçš„ç­æ¬¡
                    const shiftsString = shifts.join('/'); 
                    commonWorkingDays.push({ date: dateKey, shifts: shiftsString });
                }
            }

            // 3. è¾“å‡ºç»“æœ
            const listOutput = commonWorkingDays.map(d => `${d.date}: ${d.shifts}`).join('\n');
            const summaryOutput = `å‚ä¸æ¯”è¾ƒäººæ•°ï¼š${schedules.length}äºº\næ¯”è¾ƒèŒƒå›´å¤©æ•°ï¼š${dayKeys.length}å¤©\n\nğŸ‰ å…±åŒä¸Šç­æ€»å¤©æ•°ï¼š\n${commonWorkingDays.length} å¤©`;
            
            $('out2_list').value = listOutput || "æœ¬æœˆæ— å…±åŒä¸Šç­æ—¥æœŸã€‚";
            $('out2_summary').value = summaryOutput;

            AppUI.setStatus('st2', `æ¯”è¾ƒæˆåŠŸï¼å…±æ‰¾åˆ° ${commonWorkingDays.length} ä¸ªå…±åŒä¸Šç­æ—¥ã€‚`, 'ok');

        } catch (e) {
            $('out2_list').value = '';
            $('out2_summary').value = '';
            AppUI.setStatus('st2', `æ¯”è¾ƒå¤±è´¥ï¼š${e.message}`, 'error');
            console.error(e);
        }
    }

    // --- Tab 3: ç­æ¬¡ç»Ÿè®¡æœç´¢ (æ–°å¢åŠŸèƒ½) ---
    function t3_search() {
        AppUI.hideStatus('st3');
        $('out3_list').value = '';
        $('out3_summary').value = '';

        try {
            const namesText = $('in3_names').value.trim();
            const codesText = $('in3_codes').value.trim();
            const searchCode = $('in3_search').value.trim().toUpperCase();

            if (!namesText || !codesText) throw new Error("è¯·ç²˜è´´äººå‘˜åå•å’Œç­æ¬¡çŸ©é˜µã€‚");
            if (!searchCode) throw new Error("è¯·è¾“å…¥è¦æœç´¢çš„ç­æ¬¡ä»£ç  (å¦‚ MC)ã€‚");

            const names = namesText.split(/[\r\n]+/)
                .map(l => l.trim())
                .filter(l => l && !/^(ç™½|ä¸­|æ™š|å¤œ|TICKET|VIP|IM|å¤§å®¢æˆ·)/.test(l));

            const codeLines = codesText.split(/[\r\n]+/)
                .map(l => l.trim())
                .filter(l => /\d{1,2}:\d{2}|OFF|REST|MC|AL|PH/.test(l) && !/æœˆ\d+æ—¥/.test(l));

            const count = Math.min(names.length, codeLines.length);
            if(count === 0) throw new Error("æœªæ‰¾åˆ°æœ‰æ•ˆæ•°æ®è¡Œã€‚");

            let totalCount = 0;
            let matchedPeople = new Map();

            for(let i=0; i<count; i++) {
                const name = names[i];
                const codes = codeLines[i].split(/[\t\s]+/).filter(Boolean);
                let personCount = 0;

                codes.forEach(code => {
                    if (code.toUpperCase().includes(searchCode)) {
                        personCount++;
                    }
                });

                if (personCount > 0) {
                    matchedPeople.set(name, personCount);
                    totalCount += personCount;
                }
            }

            // 3. è¾“å‡ºç»“æœ
            const listOutput = Array.from(matchedPeople.entries())
                .map(([name, count]) => `${name}: ${count} æ¬¡`)
                .join('\n');
            
            const summaryOutput = `æœç´¢ä»£ç ï¼š${searchCode}\n\nğŸ‰ æ€»è®¡å‡ºç°æ¬¡æ•°ï¼š\n${totalCount} æ¬¡\n\nğŸ‘¤ æ¶‰åŠæ€»äººæ•°ï¼š\n${matchedPeople.size} äºº`;

            $('out3_list').value = listOutput || `æ²¡æœ‰æ‰¾åˆ°åŒ…å« "${searchCode}" çš„ç­æ¬¡ã€‚`;
            $('out3_summary').value = summaryOutput;

            AppUI.setStatus('st3', `æœç´¢æˆåŠŸï¼æ‰¾åˆ° ${totalCount} æ¬¡åŒ¹é…ï¼Œæ¶‰åŠ ${matchedPeople.size} äººã€‚`, 'ok');

        } catch (e) {
            $('out3_list').value = '';
            $('out3_summary').value = '';
            AppUI.setStatus('st3', `æœç´¢å¤±è´¥ï¼š${e.message}`, 'error');
            console.error(e);
        }
    }

    // --- Tab 4: å¯è§†åŒ–æ’ç­è¡¨ (ä¿®å¤ Bug 2) ---
    function t4_render() {
        saveT4(); // æ¸²æŸ“å‰ç¡®ä¿æ•°æ®å·²ä¿å­˜
        try {
            const dText = $('in_dates').value;
            const nText = $('in_names').value;
            const cText = $('in_codes').value;

            if(!dText || !nText || !cText) throw new Error("è¯·å¡«æ»¡ä¸‰ä¸ªè¾“å…¥æ¡†");
            
            const days = extractDates(dText);
            if(days.length === 0) throw new Error("æ—¥æœŸæ•°æ®è§£æå¤±è´¥ (å¦‚ 12æœˆ1æ—¥)ã€‚");

            const names = nText.split(/[\r\n]+/)
                .map(l => l.trim())
                .filter(l => l && !/^(ç™½|ä¸­|æ™š|å¤œ|TICKET|VIP|IM|å¤§å®¢æˆ·)/.test(l));

            const codeLines = cText.split(/[\r\n]+/)
                .map(l => l.trim())
                .filter(l => /\d{1,2}:\d{2}|OFF|REST|MC|AL|PH/.test(l) && !/æœˆ\d+æ—¥/.test(l));

            const count = Math.min(names.length, codeLines.length);
            if(count === 0) throw new Error("æœªæ‰¾åˆ°æœ‰æ•ˆçš„å§“åæˆ–ç­æ¬¡æ•°æ®è¡Œã€‚");

            // æ£€æŸ¥ç­æ¬¡æ•°é‡æ˜¯å¦ä¸æ—¥æœŸæ•°é‡åŒ¹é…
            for(let i=0; i<count; i++) {
                 const codes = codeLines[i].split(/[\t\s]+/).filter(Boolean);
                 if (codes.length < days.length) {
                    throw new Error(`ç¬¬ ${i + 1} è¡Œ (${names[i]}) ç­æ¬¡æ•°é‡ (${codes.length}) å°‘äºæ—¥æœŸæ•°é‡ (${days.length})ã€‚è¯·æ£€æŸ¥ã€‚`);
                 }
            }

            const rows = [];
            for(let i=0; i<count; i++) {
                const codes = codeLines[i].split(/[\t\s]+/).filter(Boolean);
                let stats = { off:0, work:0, leave:0 };
                const processedCodes = codes.slice(0, days.length).map(c => {
                    const uc = c.toUpperCase();
                    if(/OFF|REST/.test(uc)) stats.off++;
                    else if(/MC|AL|PH|UPL|LATE/.test(uc)) stats.leave++;
                    else stats.work++;
                    return c;
                });
                
                rows.push({
                    name: names[i],
                    codes: processedCodes,
                    stats
                });
            }
            
            const data = { days, rows };
            const container = $('table_container');
            
            // ... (HTML Table Generation Logic) ...
            let html = '<table><thead><tr>';
            html += '<th style="min-width:120px; z-index:50;">äººå‘˜åå•</th>';
            data.days.forEach(d => {
                html += `<th>${d.month}/${d.day}</th>`;
            });
            html += '<th class="stats-col">å‡ºå‹¤</th><th class="stats-col">ä¼‘å‡</th>';
            html += '</tr></thead><tbody>';

            data.rows.forEach(row => {
                html += `<tr>`;
                html += `<th>${row.name}</th>`;
                
                row.codes.forEach(c => {
                    const typeClass = getCodeClass(c);
                    html += `<td><div class="cell-inner ${typeClass}">${c}</div></td>`;
                });

                for(let k=row.codes.length; k<data.days.length; k++) {
                     html += `<td></td>`;
                }

                html += `<td class="stats-col">${row.stats.work}</td>`;
                html += `<td class="stats-col" style="color:${row.stats.leave>0?'red':'inherit'}">${row.stats.leave}</td>`;
                
                html += `</tr>`;
            });

            html += '</tbody></table>';
            
            container.innerHTML = html;
            container.style.display = 'block';
            $('visual_placeholder').style.display = 'none';
            AppUI.msgT4(`æˆåŠŸç”Ÿæˆ ${data.rows.length} äººçš„æ’ç­è¡¨`);

        } catch(e) {
            AppUI.msgT4(e.message, true);
        }

        function getCodeClass(code) {
            const s = code.toUpperCase();
            if (s === 'OFF' || s === 'REST') return 'type-off';
            if (s.includes('MC') || s.includes('PH') || s.includes('UPL')) return 'type-leave';
            if (s.includes('AL')) return 'type-al';
            if (s.includes('15:') || s.includes('16:')) return 'type-night';
            if (/\d/.test(s)) return 'type-work';
            return '';
        }
    }

    return { t1_parse, t2_compare, t3_search, t4_render, loadSavedData };
})();

// åˆå§‹åŒ–ï¼šè®¾ç½®é»˜è®¤ Tab
AppUI.switchTab('t1'); 
</script>
</body>
</html>
