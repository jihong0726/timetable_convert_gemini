<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£ä¹¦æ’ç­å¯è§†åŒ–çœ‹æ¿ V6.12</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/zh-cn.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isBetween.js"></script>
    <script>
        dayjs.locale('zh-cn');
        dayjs.extend(dayjs_plugin_customParseFormat);
        dayjs.extend(dayjs_plugin_isBetween);
    </script>
    <style>
        /* åŸºç¡€æ ·å¼å’Œå¸ƒå±€ */
        body {
            font-family: 'Roboto', "Microsoft YaHei", sans-serif;
            margin: 0;
            background-color: #f4f7f9;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* å¤´éƒ¨å’Œå¯¼èˆªæ  */
        .header {
            background-color: #fff;
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba

[Image of X]
(0, 0, 0, 0.05);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header h1 {
            margin: 0;
            font-size: 24px;
            color: #1890ff;
        }

        .nav {
            display: flex;
            border-bottom: 2px solid #e8e8e8;
        }

        .nav-item {
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 500;
            color: #595959;
            transition: color 0.3s, border-bottom 0.3s;
            position: relative;
            user-select: none;
        }

        .nav-item:hover {
            color: #1890ff;
        }

        .nav-item.active {
            color: #1890ff;
            border-bottom: 3px solid #1890ff;
        }

        /* é€šç”¨å¡ç‰‡æ ·å¼ */
        .card {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba

[Image of X]
(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        /* æ¶ˆæ¯æ¡† */
        .message-box {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }

        .message-box.success {
            background-color: #e6f7ff;
            border: 1px solid #91d5ff;
            color: #1890ff;
        }

        .message-box.success .icon {
            color: #52c41a;
            margin-right: 10px;
            font-size: 18px;
        }

        .message-box.error {
            background-color: #fff1f0;
            border: 1px solid #ffa39e;
            color: #f5222d;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
            margin-right: 10px;
        }

        .btn-primary {
            background-color: #1890ff;
            color: #fff;
        }

        .btn-primary:hover {
            background-color: #40a9ff;
        }

        .btn-default {
            background-color: #fff;
            border: 1px solid #d9d9d9;
            color: #333;
        }

        .btn-default:hover {
            border-color: #40a9ff;
            color: #40a9ff;
        }

        /* è¡¨æ ¼æ ·å¼ */
        .schedule-table-container {
            /* å…³é”®ï¼šè®¾ç½®é«˜åº¦å’Œæ»šåŠ¨ï¼Œå®ç° sticky */
            overflow: auto; 
            max-height: 80vh; 
            border: 1px solid #e8e8e8;
            border-radius: 4px;
        }

        .schedule-table {
            width: 100%;
            border-collapse: separate; 
            border-spacing: 0;
            table-layout: fixed; 
            /* ä¿è¯åœ¨æ°´å¹³æ»šåŠ¨æ—¶ï¼Œè¡¨å¤´èƒ½çœ‹åˆ°è¡¨æ ¼å®½åº¦ */
            min-width: max-content; 
        }

        .schedule-table th, .schedule-table td {
            padding: 8px 10px;
            text-align: center;
            border-right: 1px solid #f0f0f0;
            border-bottom: 1px solid #f0f0f0;
            min-width: 80px; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            background-color: #fff; 
        }
        
        /* å§“ååˆ—ï¼ˆç¬¬ä¸€åˆ—ï¼‰çš„å›ºå®šæ ·å¼ */
        .schedule-table th:first-child, .schedule-table td:first-child {
            text-align: left;
            padding-left: 15px;
            min-width: 150px;
            max-width: 150px; 
            position: sticky;
            left: 0;
            z-index: 11; 
            background-color: #fff;
        }

        /* è¡¨å¤´ï¼ˆæ—¥æœŸè¡Œï¼‰çš„å›ºå®šæ ·å¼ */
        .schedule-table thead th {
            background-color: #fafafa;
            color: #595959;
            font-weight: 600;
            position: sticky; 
            top: 0; /* å…³é”®ï¼šå›ºå®šåœ¨é¡¶éƒ¨ */
            z-index: 10;
        }

        /* å·¦ä¸Šè§’å•å…ƒæ ¼å›ºå®šï¼ˆå§“å+æ—¥æœŸäº¤æ±‡ç‚¹ï¼‰ */
        .schedule-table thead th:first-child {
            z-index: 12; 
            background-color: #fafafa;
        }
        
        /* ç­æ¬¡é¢œè‰²å®šä¹‰ */
        .shift-9 { background-color: #e6f7ff; } 
        .shift-15 { background-color: #fffbe6; } 
        .shift-rest { background-color: #f6ffed; color: #52c41a; font-weight: bold;} 
        .shift-off { background-color: #f0f2f5; color: #595959; font-weight: bold;} 
        .shift-al, .shift-mc { background-color: #fff0f6; color: #eb2f96; font-weight: bold;} 
        .shift-special { background-color: #f9f0ff; color: #722ed1; } 
        
        /* T1: å¯è§†åŒ–æ’ç­è¡¨ */
        #tab-t4 textarea {
            width: 100%;
            height: 200px;
            padding: 10px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            box-sizing: border-box;
            font-family: monospace;
            font-size: 14px;
        }

        /* T2: å¤šäººæ¯”è¾ƒ */
        .comparison-setup {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .comparison-setup select {
            padding: 8px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            min-width: 200px;
            font-size: 14px;
        }

        .results-container {
            display: flex;
            gap: 20px;
        }

        .results-box {
            flex: 1;
            padding: 15px;
            border: 1px solid #e8e8e8;
            border-radius: 4px;
            min-height: 200px;
            font-family: monospace;
            background-color: #fff;
        }

        .results-box h3 {
            margin-top: 0;
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 10px;
            margin-bottom: 15px;
            color: #1890ff;
            font-size: 16px;
        }

        /* T4: ç­æ¬¡ç»Ÿè®¡æœç´¢ - ç»“æœä¼˜åŒ– */
        .search-summary-content {
            padding: 10px;
            text-align: center;
        }

        .summary-value {
            font-size: 1.8em;
            color: #1890ff;
            font-weight: bold;
            display: block;
            margin: 5px 0;
        }
        
        .employee-list-content {
            white-space: pre-wrap;
            font-family: monospace;
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }
        
        .employee-list-item {
            margin-bottom: 10px;
        }

        /* T3: å•äººç”Ÿæˆ */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input[type="date"], .form-group select {
            padding: 8px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            width: 200px;
            font-size: 14px;
        }
        
        /* T4: ç­æ¬¡ç»Ÿè®¡æœç´¢ */
        .t4-filters {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: flex-end;
        }
        .t4-filters .form-group {
            margin-bottom: 0;
        }
        /* --- T5: ç­æ¬¡ç»Ÿè®¡æœç´¢ç»“æœä¼˜åŒ– (å‚ç›´åˆ—è¡¨) --- */
.search-result-date-block {
    margin-bottom: 25px; /* æ—¥æœŸä¹‹é—´çš„é—´è· */
}
.search-result-date-header {
    font-size: 16px;
    font-weight: bold;
    color: #1890ff; /* æ ‡é¢˜é¢œè‰² */
    margin-bottom: 8px;
    border-bottom: 1px solid #f0f0f0;
    padding-bottom: 5px;
}
.search-result-name-list {
    padding-left: 10px; /* åå­—ç¨å¾®ç¼©è¿› */
}
.search-result-name-item {
    display: block;     /* å¼ºåˆ¶æ¢è¡Œï¼Œæ¯è¡Œä¸€ä¸ªåå­— */
    margin-bottom: 4px; /* åå­—ä¹‹é—´çš„é—´è· */
    color: #333;
    font-size: 14px;
    font-family: monospace; /* ä¿æŒä¸å…¶ä»–åˆ—è¡¨ä¸€è‡´çš„å­—ä½“ */
}
/* è°ƒæ•´ç»“æœå®¹å™¨å¸ƒå±€ï¼Œé˜²æ­¢å·¦ä¾§è¢«æ‹‰é•¿ */
.results-container {
    display: flex;
    gap: 20px;
    align-items: flex-start; 
}
    </style>
</head>
<body>

<div class="header">
    <h1>é£ä¹¦æ’ç­å¯è§†åŒ–çœ‹æ¿</h1>
    <span>V6.12 - 2025.12.04</span>
</div>

<div class="container">
    <div class="nav">
        <div class="nav-item active" data-tab="t4">å¯è§†åŒ–æ’ç­è¡¨</div>
        <div class="nav-item" data-tab="t3">å•äººç­è¡¨ç”Ÿæˆ</div>
        <div class="nav-item" data-tab="t2">å¤šäººç­è¡¨æ¯”è¾ƒ</div>
        <div class="nav-item" data-tab="t5">ç­æ¬¡ç»Ÿè®¡æœç´¢</div>
    </div>

    <div id="tab-t4" class="tab-content">
        <div class="card">
            <p>è¯·ç²˜è´´ä»é£ä¹¦æ’ç­å¯¼å‡ºçš„ Excel **å…¨éƒ¨å†…å®¹**ï¼ˆåŒ…æ‹¬è¡¨å¤´ï¼‰ï¼Œç„¶åç‚¹å‡»â€œè§£æå¹¶æ˜¾ç¤ºâ€ã€‚</p>
            <textarea id="schedule-input-t4" placeholder="ç²˜è´´æ’ç­è¡¨æ•°æ®..."></textarea>
            <button class="btn btn-primary" onclick="parseAndDisplaySchedule()">âœ… è§£æå¹¶æ˜¾ç¤º</button>
        </div>
        
        <div class="card">
            <h2>ğŸ“Š å¯è§†åŒ–æ’ç­è¡¨ç»“æœ</h2>
            <div id="schedule-output-t4" class="schedule-table-container">
                <p style="padding: 20px;">ç­‰å¾…æ•°æ®è¾“å…¥...</p>
            </div>
        </div>
    </div>

    <div id="tab-t3" class="tab-content" style="display:none;">
        <div class="card">
            <h2>ğŸ‘¤ å•äººç­è¡¨ç”Ÿæˆ</h2>
            <p>åŸºäºé€šç”¨æ’ç­æ•°æ®ï¼Œç”ŸæˆæŒ‡å®šå‘˜å·¥çš„ä¸ªäººç­è¡¨ã€‚</p>
            <div class="form-group">
                <label for="employee-select-t3">é€‰æ‹©å‘˜å·¥:</label>
                <select id="employee-select-t3" style="width: 100%; max-width: 300px;"></select>
            </div>
            <div class="form-group">
                <button class="btn btn-primary" onclick="generateSingleSchedule()">ğŸ“ ç”Ÿæˆä¸ªäººç­è¡¨</button>
            </div>
            
            <textarea id="single-schedule-output" style="width:100%; height:300px; margin-top: 15px; font-family: monospace;"></textarea>
        </div>
    </div>

    <div id="tab-t2" class="tab-content" style="display:none;">
        <div id="t2-message-box" class="message-box success" style="display:none;"></div>
        <div class="card">
            <div class="message-box success">
                <span class="icon">âœ…</span> æ‰¾åˆ°å…±äº«æ’ç­æ•°æ®ï¼Œè¯·é€‰æ‹© 2-4 ä½å‘˜å·¥è¿›è¡Œæ¯”è¾ƒ: 
                <button class="btn btn-primary" style="margin-left:auto;" onclick="startComparison()">æ¯”è¾ƒ</button>
            </div>

            <h2>è¯·é€‰æ‹©éœ€è¦æ¯”è¾ƒçš„ 2-4 ä½å‘˜å·¥</h2>
            <div id="comparison-selects" class="comparison-setup">
                </div>
            <button class="btn btn-primary" id="start-comparison-btn" onclick="startComparison()">å¼€å§‹æ¯”è¾ƒ</button>
            <button class="btn btn-default" onclick="clearComparisonSelections()">æ¸…ç©º</button>
            <div id="comparison-status" class="message-box success" style="display:none;"></div>
        </div>

        <div class="card" id="comparison-results" style="display:none;">
            <h2>æ¯”è¾ƒç»“æœ</h2>
            <div class="results-container">
                <div class="results-box">
                    <h3>âœ¨ å…±åŒä¸Šç­æ—¥æœŸåˆ—è¡¨</h3>
                    <div id="common-dates-list" style="white-space: pre-wrap;"></div>
                </div>
                <div class="results-box">
                    <h3>ğŸ“Š æ€»ç»“</h3>
                    <div id="comparison-summary" style="white-space: pre-wrap;"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-t5" class="tab-content" style="display:none;">
        <div class="card">
            <h2>ğŸ” ç­æ¬¡ç»Ÿè®¡æœç´¢</h2>
            <p>å¿«é€Ÿç»Ÿè®¡æŒ‡å®šæ—¥æœŸèŒƒå›´å†…ï¼Œç‰¹å®šç­æ¬¡çš„å‘˜å·¥æ•°é‡å’Œåˆ—è¡¨ã€‚</p>
            <div class="t4-filters">
                <div class="form-group">
                    <label for="date-start-t5">èµ·å§‹æ—¥æœŸ:</label>
                    <input type="date" id="date-start-t5" value="">
                </div>
                <div class="form-group">
                    <label for="date-end-t5">ç»“æŸæ—¥æœŸ:</label>
                    <input type="date" id="date-end-t5" value="">
                </div>
                <div class="form-group">
                    <label for="shift-code-t5">ç­æ¬¡ä»£ç :</label>
                    <input type="text" id="shift-code-t5" placeholder="ä¾‹å¦‚: 9:00, REST, AL" value="MC">
                </div>
                <button class="btn btn-primary" onclick="performShiftSearch()">ğŸ” æœç´¢ç»Ÿè®¡</button>
            </div>

            <div class="results-container">
                <div class="results-box" style="flex:none; width: 300px;">
                    <h3>æ€»è®¡</h3>
                    <div id="search-summary" class="search-summary-content"></div>
                </div>
                <div class="results-box">
                    <h3>å‘˜å·¥åˆ—è¡¨</h3>
                    <pre id="search-employee-list" class="employee-list-content"></pre>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let globalScheduleData = {};
    let globalEmployeeNames = [];
    let globalDates = [];
    let globalParsedInput = []; // å­˜å‚¨åŸå§‹è¾“å…¥è§£æåçš„äºŒç»´æ•°ç»„

    // --- ç­æ¬¡é¢œè‰²æ˜ å°„ ---
    const SHIFT_COLOR_MAP = {
        'REST': 'shift-rest',
        'OFF': 'shift-off',
        'AL': 'shift-al',
        'MC': 'shift-mc',
        '9:00': 'shift-9',
        '15:00': 'shift-15'
    };

    // --- ç­æ¬¡æ ‡å‡†åŒ–å‡½æ•° ---
    function normalizeShiftCode(code) {
        if (!code) return "";
        let cleanCode = code.toUpperCase().trim();

        cleanCode = cleanCode.replace(/[\(\)ï¼ˆï¼‰].*/, ''); 
        cleanCode = cleanCode.replace(/-\d+[HMT].*/i, ''); 
        cleanCode = cleanCode.replace(/[\s,ï¼Œ]/g, ''); 

        if (/REST|OFF|ä¼‘/.test(cleanCode)) return 'REST';
        if (/AL|å¹´å‡/.test(cleanCode)) return 'AL';
        if (/MC|ç—…å‡/.test(cleanCode)) return 'MC';
        
        const timeMatch = cleanCode.match(/\d{1,2}:\d{2}/);
        if (timeMatch) return timeMatch[0];

        return cleanCode;
    }
    
    // --- 1. æ•°æ®è§£æå’Œåˆå§‹åŒ– (T4) ---
    function parseAndDisplaySchedule() {
        const input = document.getElementById('schedule-input-t4').value.trim();
        if (!input) {
            alert("è¯·è¾“å…¥æ’ç­è¡¨æ•°æ®ï¼");
            return;
        }

        const lines = input.split('\n');
        if (lines.length < 2) {
            alert("æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œè‡³å°‘éœ€è¦åŒ…å«è¡¨å¤´å’Œä¸€è¡Œæ•°æ®ã€‚");
            return;
        }

        // å­˜å‚¨åŸå§‹è§£ææ•°æ®
        globalParsedInput = lines.map(line => line.trim().split('\t'));

        // 1. è§£æè¡¨å¤´ (ç¬¬ä¸€è¡Œ)
        const header = globalParsedInput[0];
        if (header.length < 2) {
            alert("è¡¨å¤´æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ç¡®ä¿ä½¿ç”¨Tabåˆ†éš”ã€‚");
            return;
        }
        
        // ç¡®å®šæ—¥æœŸèŒƒå›´
        const dateHeaders = header.slice(1); 
        let firstValidDateIndex = -1;
        let lastValidDateIndex = -1;
        
        globalDates = [];
        const currentYear = dayjs().format('YYYY'); 
        
        for (let i = 0; i < dateHeaders.length; i++) {
            let dateStr = dateHeaders[i].replace(/[\(\ï¼ˆ].*[\)\ï¼‰]/g, '').trim();
            let dateObj;
            
            // å°è¯•è§£ææ—¥æœŸï¼Œå¹¶è¡¥ä¸Šå½“å‰å¹´ä»½
            dateObj = dayjs(`${currentYear}/${dateStr}`, ['YYYY/MæœˆDæ—¥', 'YYYY/M/D'], true);
            
            // å¦‚æœè§£æå¤±è´¥ï¼Œå°è¯•ç›´æ¥è§£æä¸å¸¦å¹´ä»½çš„ M/D
            if (!dateObj.isValid()) {
                 dateObj = dayjs(dateStr, ['MæœˆDæ—¥', 'M/D'], true);
                 if (dateObj.isValid()) {
                     dateObj = dayjs().year(parseInt(currentYear)).month(dateObj.month()).date(dateObj.date());
                 }
            }
            
            if (dateObj && dateObj.isValid()) {
                if (firstValidDateIndex === -1) {
                    firstValidDateIndex = i + 1; 
                }
                lastValidDateIndex = i + 1;
                globalDates.push(dateObj.format('YYYY-MM-DD')); 
            } else if (firstValidDateIndex !== -1) {
                 globalDates.push(null);
            }
        }

        if (firstValidDateIndex === -1) {
            alert("æœªèƒ½è¯†åˆ«å‡ºæœ‰æ•ˆçš„æ—¥æœŸåˆ—ï¼Œè¯·æ£€æŸ¥æ•°æ®ã€‚");
            return;
        }

        // 2. è§£ææ•°æ®è¡Œ (å‘˜å·¥æ’ç­)
        globalScheduleData = {};
        globalEmployeeNames = [];

        for (let i = 1; i < globalParsedInput.length; i++) {
            const cells = globalParsedInput[i];
            const employeeName = cells[0].trim();
            
            if (!employeeName) continue;
            
            // å¯å‘å¼è¿‡æ»¤éå‘˜å·¥è¡Œ (V6.12 ä¿®æ­£)
            // æ£€æŸ¥æ—¥æœŸåˆ—åŒºåŸŸå†…æ˜¯å¦æœ‰ä»»ä½•ç­æ¬¡ä»£ç ï¼ˆæ•°å­—æ—¶é—´æˆ–ç‰¹å®šä»£ç ï¼‰
            const shiftCells = cells.slice(firstValidDateIndex, lastValidDateIndex + 1);
            const hasShiftData = shiftCells.some(shift => {
                 const normalized = normalizeShiftCode(shift);
                 return normalized.match(/\d{1,2}:\d{2}|REST|OFF|AL|MC/); 
            });

            if (!hasShiftData) continue; // è·³è¿‡ä¸åŒ…å«ç­æ¬¡æ•°æ®çš„è¡Œ (å¦‚æ±‡æ€»è¡Œã€ç­æ¬¡å®šä¹‰)

            globalEmployeeNames.push(employeeName);
            globalScheduleData[employeeName] = {};

            for (let j = 0; j < shiftCells.length; j++) {
                const date = globalDates[j];
                const shift = shiftCells[j].trim();
                if (date) { 
                    globalScheduleData[employeeName][date] = shift;
                }
            }
        }
        
        if (globalEmployeeNames.length === 0) {
            alert("æœªèƒ½è§£æå‡ºä»»ä½•å‘˜å·¥æ•°æ®ï¼Œè¯·æ£€æŸ¥æ•°æ®ã€‚");
            return;
        }

        // 3. æ¸²æŸ“è¡¨æ ¼ (T4)
        renderScheduleTable(header, globalEmployeeNames, globalDates, globalScheduleData, firstValidDateIndex, lastValidDateIndex);

        // 4. åˆå§‹åŒ–å…¶ä»–Tabsçš„æ•°æ®
        initializeT2Selectors();
        initializeT3Selector();
        initializeT5Dates();
        
        // æ˜¾ç¤ºæˆåŠŸçš„æ¶ˆæ¯
        const validDates = globalDates.filter(d => d);
        const dateStart = dayjs(validDates[0]).format('YYYYå¹´MæœˆDæ—¥');
        const dateEnd = dayjs(validDates.slice(-1)[0]).format('YYYYå¹´MæœˆDæ—¥');
        const message = `âœ… æ’ç­æ•°æ®è§£ææˆåŠŸï¼å…±æ‰¾åˆ° ${globalEmployeeNames.length} ä½å‘˜å·¥ï¼Œæ—¥æœŸèŒƒå›´ï¼š${dateStart} è‡³ ${dateEnd}ã€‚`;
        
        const outputDiv = document.getElementById('schedule-output-t4');
        const existingMessage = outputDiv.previousElementSibling;
        if (existingMessage && existingMessage.classList.contains('message-box')) {
             existingMessage.remove();
        }
        outputDiv.insertAdjacentHTML('beforebegin', `<div class="message-box success">${message}</div>`);
        
    }

    // --- 2. æ¸²æŸ“å¯è§†åŒ–æ’ç­è¡¨ (T4) ---
    function renderScheduleTable(header, employeeNames, dates, scheduleData, firstDateIndex, lastDateIndex) {
        const tableContainer = document.getElementById('schedule-output-t4');
        let html = '<table class="schedule-table"><thead><tr>';

        // æ¸²æŸ“è¡¨å¤´
        html += `<th>${header[0]}</th>`; // å§“ååˆ—

        // æ¸²æŸ“æ—¥æœŸå’Œæ˜ŸæœŸ
        for (let i = 0; i < dates.length; i++) {
            const date = dates[i];
            if (date) {
                const dayjsDate = dayjs(date);
                const dayStr = dayjsDate.format('MæœˆDæ—¥');
                const weekStr = dayjsDate.format('ï¼ˆdddï¼‰');
                html += `<th>${dayStr}<br>${weekStr}</th>`;
            } else {
                html += `<th>${header[firstDateIndex + i]}</th>`;
            }
        }
        
        // æ¸²æŸ“åŸå§‹æ’ç­è¡¨å¤´ä¸­çš„ç»Ÿè®¡åˆ—
        for (let i = lastDateIndex + 1; i < header.length; i++) {
             html += `<th>${header[i]}</th>`;
        }

        html += '</tr></thead><tbody>';

        // æ¸²æŸ“æ•°æ®è¡Œ
        employeeNames.forEach(name => {
            html += `<tr><th>${name}</th>`; // å§“ååˆ—
            
            // æŸ¥æ‰¾åŸå§‹è¡Œç´¢å¼•
            const originalRowIndex = globalParsedInput.findIndex(row => row[0].trim() === name);
            const originalCells = originalRowIndex !== -1 ? globalParsedInput[originalRowIndex] : [];

            // æ¸²æŸ“ç­æ¬¡
            for (let i = 0; i < dates.length; i++) {
                const date = dates[i];
                if (date) {
                    const shiftCode = scheduleData[name][date] || '';
                    const normalizedShift = normalizeShiftCode(shiftCode);
                    const colorClass = SHIFT_COLOR_MAP[normalizedShift] || (normalizedShift.includes(':') ? 'shift-special' : '');
                    html += `<td class="${colorClass}" title="${shiftCode}">${shiftCode}</td>`;
                } else {
                    // æ¸²æŸ“éæ—¥æœŸåˆ— (ç»Ÿè®¡åˆ—)ï¼Œä½¿ç”¨åŸå§‹æ•°æ®
                    const originalIndex = firstDateIndex + i;
                    html += `<td>${originalCells[originalIndex] || ''}</td>`;
                }
            }
            
            // æ¸²æŸ“åŸå§‹æ’ç­è¡¨å°¾éƒ¨çš„ç»Ÿè®¡åˆ—
            for (let i = lastDateIndex + 1; i < header.length; i++) {
                html += `<td>${originalCells[i] || ''}</td>`;
            }

            html += '</tr>';
        });

        html += '</tbody></table>';
        tableContainer.innerHTML = html;
    }

    // --- 3. å¤šäººç­è¡¨æ¯”è¾ƒ (T2) ---
    function initializeT2Selectors() {
        // ... (ä¿æŒ V6.11 é€»è¾‘ä¸å˜) ...
        const selectsContainer = document.getElementById('comparison-selects');
        selectsContainer.innerHTML = '';
        document.getElementById('comparison-results').style.display = 'none';
        document.getElementById('comparison-status').style.display = 'none';
        
        if (globalEmployeeNames.length === 0) {
            document.getElementById('t2-message-box').style.display = 'block';
            document.getElementById('t2-message-box').className = 'message-box error';
            document.getElementById('t2-message-box').innerHTML = 'âŒ è¯·å…ˆåœ¨â€œå¯è§†åŒ–æ’ç­è¡¨â€ä¸­å¯¼å…¥å¹¶è§£ææ•°æ®ï¼';
            document.getElementById('start-comparison-btn').disabled = true;
            return;
        }

        document.getElementById('t2-message-box').style.display = 'none';
        document.getElementById('start-comparison-btn').disabled = false;

        for (let i = 0; i < 4; i++) {
            const select = document.createElement('select');
            select.id = `employee-select-t2-${i}`;
            select.name = `employee-select-t2-${i}`;
            select.className = 'comparison-employee-select';
            
            let optionsHtml = '<option value="">- è¯·é€‰æ‹©å‘˜å·¥ -</option>';
            globalEmployeeNames.forEach(name => {
                optionsHtml += `<option value="${name}">${name}</option>`;
            });
            select.innerHTML = optionsHtml;
            selectsContainer.appendChild(select);

            if (i < 4 && globalEmployeeNames[i]) {
                select.value = globalEmployeeNames[i];
            }
        }
    }

    function clearComparisonSelections() {
        document.querySelectorAll('.comparison-employee-select').forEach(select => {
            select.selectedIndex = 0;
        });
        document.getElementById('comparison-results').style.display = 'none';
        document.getElementById('comparison-status').style.display = 'none';
    }

    function startComparison() {
        // ... (ä¿æŒ V6.11 é€»è¾‘ä¸å˜) ...
        const selectedNames = Array.from(document.querySelectorAll('.comparison-employee-select'))
            .map(select => select.value)
            .filter((name, index, self) => name && self.indexOf(name) === index); 

        if (selectedNames.length < 2) {
            alert('è¯·è‡³å°‘é€‰æ‹© 2 ä½**ä¸åŒ**çš„å‘˜å·¥è¿›è¡Œæ¯”è¾ƒï¼');
            return;
        }

        const commonDates = [];
        let totalWorkingDays = 0;

        const dateRange = globalDates.filter(date => date !== null); 
        
        dateRange.forEach(date => {
            let isCommonShift = true;
            let firstShift = null;

            const shifts = selectedNames.map(name => {
                const shiftCode = globalScheduleData[name][date] || '';
                return normalizeShiftCode(shiftCode);
            });
            
            for(const normalizedShift of shifts) {
                if (['REST', 'OFF', 'AL', 'MC', ''].includes(normalizedShift)) {
                    isCommonShift = false;
                    break;
                }
                
                if (firstShift === null) {
                    firstShift = normalizedShift;
                } else if (firstShift !== normalizedShift) {
                    isCommonShift = false;
                    break; 
                }
            }

            if (isCommonShift && firstShift) {
                commonDates.push({ date: date, shift: firstShift });
            }
        });

        totalWorkingDays = commonDates.length;

        const listDiv = document.getElementById('common-dates-list');
        const summaryDiv = document.getElementById('comparison-summary');
        const statusBox = document.getElementById('comparison-status');
        
        listDiv.innerHTML = '';
        if (commonDates.length === 0) {
            listDiv.textContent = 'æœªæ‰¾åˆ°ä»»ä½•å…±åŒå®Œå…¨ä¸€è‡´çš„ä¸Šç­æ—¥ã€‚';
        } else {
            commonDates.forEach(item => {
                const dateObj = dayjs(item.date);
                listDiv.innerHTML += `**${dateObj.format('MæœˆDæ—¥ (ddd)')}**: ${item.shift}\n`;
            });
        }
        
        const summaryText = `
**æ¯”è¾ƒäººå‘˜**: ${selectedNames.join(' vs ')}
**æ¯”è¾ƒèŒƒå›´å¤©æ•°**: ${dateRange.length} å¤©

-----------------------------------
âœ¨ **å…±åŒä¸Šç­æ€»å¤©æ•° (ç­æ¬¡éœ€å®Œå…¨ä¸€è‡´)**:
${totalWorkingDays} å¤©
        `.trim();
        
        summaryDiv.textContent = summaryText;

        const statusMessage = `æ¯”è¾ƒæˆåŠŸ! å…±æ‰¾åˆ° ${totalWorkingDays} ä¸ªå…±åŒå®Œå…¨ä¸€è‡´çš„ä¸Šç­æ—¥ã€‚`;
        statusBox.className = totalWorkingDays > 0 ? 'message-box success' : 'message-box error';
        statusBox.textContent = statusMessage;
        statusBox.style.display = 'block';
        
        document.getElementById('comparison-results').style.display = 'block';
    }

    // --- 4. å•äººç­è¡¨ç”Ÿæˆ (T3) ---
    function initializeT3Selector() {
        // (V6.12 ä¿®æ­£ï¼šä½¿ç”¨ globalEmployeeNamesï¼Œåªæ˜¾ç¤ºå‘˜å·¥æ•°æ®)
        const select = document.getElementById('employee-select-t3');
        select.innerHTML = '';
        
        if (globalEmployeeNames.length === 0) {
             select.innerHTML = '<option value="">è¯·å…ˆå¯¼å…¥æ•°æ®</option>';
             return;
        }

        let optionsHtml = '<option value="">- è¯·é€‰æ‹©å‘˜å·¥ -</option>';
        globalEmployeeNames.forEach(name => {
            optionsHtml += `<option value="${name}">${name}</option>`;
        });
        select.innerHTML = optionsHtml;
    }

    function generateSingleSchedule() {
        // ... (ä¿æŒ V6.11 é€»è¾‘ä¸å˜) ...
        const employeeName = document.getElementById('employee-select-t3').value;
        const output = document.getElementById('single-schedule-output');
        output.value = '';

        if (!employeeName) {
            alert("è¯·é€‰æ‹©ä¸€ä½å‘˜å·¥ï¼");
            return;
        }

        const employeeData = globalScheduleData[employeeName];
        if (!employeeData) {
            output.value = `æœªæ‰¾åˆ°å‘˜å·¥ ${employeeName} çš„æ’ç­æ•°æ®ã€‚`;
            return;
        }

        let result = `--- ${employeeName} ä¸ªäººæ’ç­è¡¨ ---\n`;
        let workingDays = 0;

        globalDates.filter(d => d).forEach(date => {
            const dateObj = dayjs(date);
            const shiftCode = employeeData[date] || 'æœªæ’ç­';
            const normalizedShift = normalizeShiftCode(shiftCode);
            
            result += `${dateObj.format('YYYYå¹´MæœˆDæ—¥ (ddd)')}: ${shiftCode}\n`;
            
            if (normalizedShift !== 'REST' && normalizedShift !== 'OFF' && normalizedShift !== 'AL' && normalizedShift !== 'MC' && shiftCode !== '') {
                 workingDays++;
            }
        });
        
        const validDatesCount = globalDates.filter(d => d).length;
        result += `\n--- æ€»ç»“ ---\n`;
        result += `æ’ç­æ€»å¤©æ•°: ${validDatesCount} å¤©\n`;
        result += `é¢„ä¼°å·¥ä½œå¤©æ•° (æ’é™¤ REST/OFF/AL/MC): ${workingDays} å¤©\n`;

        output.value = result;
    }

    // --- 5. ç­æ¬¡ç»Ÿè®¡æœç´¢ (T5) ---
    function initializeT5Dates() {
        const today = dayjs();
        // é»˜è®¤è®¾ç½®ä¸ºæœ¬æœˆç¬¬ä¸€å¤©å’Œæœ€åä¸€å¤©
        document.getElementById('date-start-t5').value = today.startOf('month').format('YYYY-MM-DD');
        document.getElementById('date-end-t5').value = today.endOf('month').format('YYYY-MM-DD');
        // é»˜è®¤ç­æ¬¡è®¾ç½®ä¸º MC (æ ¹æ®æ‚¨çš„æˆªå›¾)
        document.getElementById('shift-code-t5').value = 'MC'; 
    }

function performShiftSearch() {
        if (globalEmployeeNames.length === 0) {
            alert('è¯·å…ˆåœ¨â€œå¯è§†åŒ–æ’ç­è¡¨â€ä¸­å¯¼å…¥å¹¶è§£ææ•°æ®ï¼');
            return;
        }
        const dateStartStr = document.getElementById('date-start-t5').value;
        const dateEndStr = document.getElementById('date-end-t5').value;
        const shiftCodeInput = document.getElementById('shift-code-t5').value.trim();
        
        if (!dateStartStr || !dateEndStr || !shiftCodeInput) {
            alert('è¯·å¡«å†™èµ·å§‹æ—¥æœŸã€ç»“æŸæ—¥æœŸå’Œç­æ¬¡ä»£ç ï¼');
            return;
        }
        
        const dateStart = dayjs(dateStartStr);
        const dateEnd = dayjs(dateEndStr);
        
        // è§£æç›®æ ‡ç­æ¬¡
        const targetShifts = shiftCodeInput.split(/[,\sï¼Œ]+/)
            .map(s => normalizeShiftCode(s))
            .filter(s => s !== '');
            
        if (targetShifts.length === 0) {
            alert('è¯·æä¾›æœ‰æ•ˆçš„ç­æ¬¡ä»£ç ï¼');
            return;
        }
        
        // --- æ ¸å¿ƒé€»è¾‘ï¼šæŒ‰æ—¥æœŸå½’ç±» ---
        const resultsByDate = {}; // Key: æ—¥æœŸ, Value: [å‘˜å·¥åˆ—è¡¨]
        let totalShiftCount = 0;
        const involvedEmployees = new Set();
        
        const datesToSearch = globalDates.filter(d => d && dayjs(d).isBetween(dateStart, dateEnd, 'day', '[]'));
        
        datesToSearch.forEach(date => {
            const dayEmployees = [];
            
            globalEmployeeNames.forEach(name => {
                const shiftCode = globalScheduleData[name][date] || '';
                const normalizedShift = normalizeShiftCode(shiftCode);
                
                if (targetShifts.includes(normalizedShift)) {
                    dayEmployees.push(name);
                    involvedEmployees.add(name);
                    totalShiftCount++;
                }
            });
            
            if (dayEmployees.length > 0) {
                resultsByDate[date] = dayEmployees;
            }
        });
        
        // --- æ¸²æŸ“å·¦ä¾§ï¼šç»Ÿè®¡æ±‡æ€» ---
        const summaryDiv = document.getElementById('search-summary');
        const listDiv = document.getElementById('search-employee-list');
        
        summaryDiv.innerHTML = `
        <p>æœç´¢ç­æ¬¡: <br><strong>${targetShifts.join(' / ')}</strong></p>
        <p style="font-size:12px; color:#999;">${dateStart.format('YYYY/MM/DD')} - ${dateEnd.format('MM/DD')}</p>
        <hr style="border-top: 1px solid #e8e8e8; margin: 10px 0;">
        
        <p>æ€»è®¡äººæ¬¡:</p>
        <span class="summary-value">${totalShiftCount}</span>
        
        <p>æ¶‰åŠäººæ•°:</p>
        <span class="summary-value">${involvedEmployees.size}</span>
        `;
        
        // --- æ¸²æŸ“å³ä¾§ï¼šæ—¥æœŸ -> å‚ç›´å‘˜å·¥åˆ—è¡¨ ---
        let listHtml = '';
        const sortedResultDates = Object.keys(resultsByDate).sort();
        
        if (sortedResultDates.length === 0) {
            listHtml = '<div style="padding:20px; text-align:center; color:#999;">åœ¨æ­¤æ—¥æœŸèŒƒå›´å†…æœªæ‰¾åˆ°æŒ‡å®šç­æ¬¡ã€‚</div>';
        } else {
            sortedResultDates.forEach(date => {
                const dateObj = dayjs(date);
                const names = resultsByDate[date];
                
                listHtml += `
                <div class="search-result-date-block">
                    <div class="search-result-date-header">
                        ğŸ“… ${dateObj.format('MæœˆDæ—¥ (ddd)')}:
                    </div>
                    <div class="search-result-name-list">
                        ${names.map(name => `<div class="search-result-name-item">${name}</div>`).join('')}
                    </div>
                </div>
                `;
            });
        }
        
        listDiv.innerHTML = listHtml;
        // å…³é”®ï¼šé‡ç½®æ ·å¼ä»¥æ”¯æŒ div å¸ƒå±€
        listDiv.style.whiteSpace = 'normal';
        listDiv.style.fontFamily = 'inherit';
    }


    // --- 6. Tab åˆ‡æ¢é€»è¾‘ ---
    document.addEventListener('DOMContentLoaded', () => {
        const navItems = document.querySelectorAll('.nav-item');
        const tabContents = document.querySelectorAll('.tab-content');

        navItems.forEach(item => {
            item.addEventListener('click', () => {
                const targetTab = item.getAttribute('data-tab');

                navItems.forEach(nav => nav.classList.remove('active'));
                tabContents.forEach(content => content.style.display = 'none');

                item.classList.add('active');
                document.getElementById(`tab-${targetTab}`).style.display = 'block';

                if (globalEmployeeNames.length > 0) {
                    if (targetTab === 't2') initializeT2Selectors();
                    if (targetTab === 't3') initializeT3Selector();
                    if (targetTab === 't5') initializeT5Dates();
                }
            });
        });
        
        document.querySelector('.nav-item[data-tab="t4"]').click(); 
    });
</script>

</body>
</html>
