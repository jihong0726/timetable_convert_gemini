<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£ä¹¦æ’ç­å¯è§†åŒ–çœ‹æ¿ V6.10</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/zh-cn.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isBetween.js"></script>
    <script>
        dayjs.locale('zh-cn');
        dayjs.extend(dayjs_plugin_customParseFormat);
        dayjs.extend(dayjs_plugin_isBetween);
    </script>
    <style>
        /* åŸºç¡€æ ·å¼å’Œå¸ƒå±€ */
        body {
            font-family: 'Roboto', "Microsoft YaHei", sans-serif;
            margin: 0;
            background-color: #f4f7f9;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* å¤´éƒ¨å’Œå¯¼èˆªæ  */
        .header {
            background-color: #fff;
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header h1 {
            margin: 0;
            font-size: 24px;
            color: #1890ff;
        }

        .nav {
            display: flex;
            border-bottom: 2px solid #e8e8e8;
        }

        .nav-item {
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 500;
            color: #595959;
            transition: color 0.3s, border-bottom 0.3s;
            position: relative;
            user-select: none;
        }

        .nav-item:hover {
            color: #1890ff;
        }

        .nav-item.active {
            color: #1890ff;
            border-bottom: 3px solid #1890ff;
        }

        /* é€šç”¨å¡ç‰‡æ ·å¼ */
        .card {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        /* æ¶ˆæ¯æ¡† */
        .message-box {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }

        .message-box.success {
            background-color: #e6f7ff;
            border: 1px solid #91d5ff;
            color: #1890ff;
        }

        .message-box.success .icon {
            color: #52c41a;
            margin-right: 10px;
            font-size: 18px;
        }

        .message-box.error {
            background-color: #fff1f0;
            border: 1px solid #ffa39e;
            color: #f5222d;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
            margin-right: 10px;
        }

        .btn-primary {
            background-color: #1890ff;
            color: #fff;
        }

        .btn-primary:hover {
            background-color: #40a9ff;
        }

        .btn-default {
            background-color: #fff;
            border: 1px solid #d9d9d9;
            color: #333;
        }

        .btn-default:hover {
            border-color: #40a9ff;
            color: #40a9ff;
        }

        /* è¡¨æ ¼æ ·å¼ */
        .schedule-table-container {
            overflow-x: auto;
            max-height: 80vh;
            border: 1px solid #e8e8e8;
            border-radius: 4px;
        }

        .schedule-table {
            width: 100%;
            border-collapse: separate; /* ç”¨äº sticky è¾¹æ¡† */
            border-spacing: 0;
            table-layout: fixed; /* å›ºå®šåˆ—å®½ */
        }

        .schedule-table th, .schedule-table td {
            padding: 8px 10px;
            text-align: center;
            border-right: 1px solid #f0f0f0;
            border-bottom: 1px solid #f0f0f0;
            min-width: 80px; /* é»˜è®¤åˆ—å®½ */
            max-width: 80px; /* é»˜è®¤åˆ—å®½ */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            background-color: #fff; /* ç¡®ä¿å•å…ƒæ ¼èƒŒæ™¯æ˜¯ç™½è‰² */
        }

        .schedule-table thead th {
            background-color: #fafafa;
            color: #595959;
            font-weight: 600;
            position: sticky; /* å›ºå®šè¡¨å¤´ */
            top: 0;
            z-index: 10;
        }

        /* å›ºå®šç¬¬ä¸€åˆ—ï¼ˆå§“ååˆ—ï¼‰ */
        .schedule-table th:first-child, .schedule-table td:first-child {
            text-align: left;
            padding-left: 15px;
            min-width: 150px;
            max-width: 150px;
            position: sticky;
            left: 0;
            z-index: 11; /* å§“ååˆ— z-index é«˜äºæ™®é€šè¡¨å¤´ */
            background-color: #fff;
        }

        /* å·¦ä¸Šè§’å•å…ƒæ ¼å›ºå®š */
        .schedule-table thead th:first-child {
            z-index: 12; /* å·¦ä¸Šè§’æœ€é«˜ */
            background-color: #fafafa;
        }
        
        /* ç­æ¬¡é¢œè‰²å®šä¹‰ */
        .shift-9 { background-color: #e6f7ff; } /* æµ…è“ */
        .shift-15 { background-color: #fffbe6; } /* æµ…é»„ */
        .shift-rest { background-color: #f6ffed; color: #52c41a; font-weight: bold;} /* æµ…ç»¿ */
        .shift-off { background-color: #f0f2f5; color: #595959; font-weight: bold;} /* æµ…ç° */
        .shift-al, .shift-mc { background-color: #fff0f6; color: #eb2f96; font-weight: bold;} /* æµ…ç²‰ */
        .shift-special { background-color: #f9f0ff; color: #722ed1; } /* æµ…ç´« */
        
        /* T1: å¯è§†åŒ–æ’ç­è¡¨ */
        #tab-t1 textarea {
            width: 100%;
            height: 200px;
            padding: 10px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            box-sizing: border-box;
            font-family: monospace;
            font-size: 14px;
        }

        /* T2: å¤šäººæ¯”è¾ƒ */
        #tab-t2 .comparison-setup {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .comparison-setup select {
            padding: 8px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            min-width: 200px;
            font-size: 14px;
        }

        .results-container {
            display: flex;
            gap: 20px;
        }

        .results-box {
            flex: 1;
            padding: 15px;
            border: 1px solid #e8e8e8;
            border-radius: 4px;
            min-height: 200px;
            white-space: pre-wrap;
            font-family: monospace;
            background-color: #fff;
        }

        .results-box h3 {
            margin-top: 0;
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 10px;
            margin-bottom: 15px;
            color: #1890ff;
            font-size: 16px;
        }

        /* T3: å•äººç”Ÿæˆ */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input[type="date"], .form-group select {
            padding: 8px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            width: 200px;
            font-size: 14px;
        }
        
        /* T4: ç­æ¬¡ç»Ÿè®¡æœç´¢ */
        .t4-filters {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: flex-end;
        }
        .t4-filters .form-group {
            margin-bottom: 0;
        }

        /* Dropdown æ ·å¼ */
        .dropdown-container {
            position: relative;
            display: inline-block;
        }

        .dropdown-select {
            padding: 8px 15px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            background-color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-width: 200px;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #fff;
            border: 1px solid #e8e8e8;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            z-index: 100;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 5px;
            display: none;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            padding: 8px 15px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .dropdown-item:hover {
            background-color: #f0f0f0;
        }

        .dropdown-item.selected {
            background-color: #e6f7ff;
            color: #1890ff;
            font-weight: 500;
        }
    </style>
</head>
<body>

<div class="header">
    <h1>é£ä¹¦æ’ç­å¯è§†åŒ–çœ‹æ¿</h1>
    <span>V6.10 - 2025.12.04</span>
</div>

<div class="container">
    <div class="nav">
        <div class="nav-item active" data-tab="t4">å¯è§†åŒ–æ’ç­è¡¨</div>
        <div class="nav-item" data-tab="t3">å•äººç­è¡¨ç”Ÿæˆ</div>
        <div class="nav-item" data-tab="t2">å¤šäººç­è¡¨æ¯”è¾ƒ</div>
        <div class="nav-item" data-tab="t5">ç­æ¬¡ç»Ÿè®¡æœç´¢</div>
    </div>

    <div id="tab-t4" class="tab-content">
        <div class="card">
            <p>è¯·ç²˜è´´ä»é£ä¹¦æ’ç­å¯¼å‡ºçš„ Excel **å…¨éƒ¨å†…å®¹**ï¼ˆåŒ…æ‹¬è¡¨å¤´ï¼‰ï¼Œç„¶åç‚¹å‡»â€œè§£æå¹¶æ˜¾ç¤ºâ€ã€‚</p>
            <textarea id="schedule-input-t4" placeholder="ç²˜è´´æ’ç­è¡¨æ•°æ®..."></textarea>
            <button class="btn btn-primary" onclick="parseAndDisplaySchedule()">âœ… è§£æå¹¶æ˜¾ç¤º</button>
        </div>
        
        <div class="card">
            <h2>ğŸ“Š å¯è§†åŒ–æ’ç­è¡¨ç»“æœ</h2>
            <div id="schedule-output-t4" class="schedule-table-container">
                <p>ç­‰å¾…æ•°æ®è¾“å…¥...</p>
            </div>
        </div>
    </div>

    <div id="tab-t3" class="tab-content" style="display:none;">
        <div class="card">
            <h2>ğŸ‘¤ å•äººç­è¡¨ç”Ÿæˆ</h2>
            <p>åŸºäºé€šç”¨æ’ç­æ•°æ®ï¼Œç”ŸæˆæŒ‡å®šå‘˜å·¥çš„ä¸ªäººç­è¡¨ã€‚</p>
            <div class="form-group">
                <label for="employee-select-t3">é€‰æ‹©å‘˜å·¥:</label>
                <select id="employee-select-t3"></select>
            </div>
            <div class="form-group">
                <button class="btn btn-primary" onclick="generateSingleSchedule()">ğŸ“ ç”Ÿæˆä¸ªäººç­è¡¨</button>
            </div>
            
            <textarea id="single-schedule-output" style="width:100%; height:300px; margin-top: 15px; font-family: monospace;"></textarea>
        </div>
    </div>

    <div id="tab-t2" class="tab-content" style="display:none;">
        <div id="t2-message-box" class="message-box success" style="display:none;"></div>
        <div class="card">
            <div class="message-box success">
                <span class="icon">âœ…</span> æ‰¾åˆ°å…±äº«æ’ç­æ•°æ®ï¼Œè¯·é€‰æ‹© 2-4 ä½å‘˜å·¥è¿›è¡Œæ¯”è¾ƒ: 
                <button class="btn btn-primary" style="margin-left:auto;" onclick="startComparison()">æ¯”è¾ƒ</button>
            </div>

            <h2>è¯·é€‰æ‹©éœ€è¦æ¯”è¾ƒçš„ 2-4 ä½å‘˜å·¥</h2>
            <div id="comparison-selects" class="comparison-setup">
                </div>
            <button class="btn btn-primary" id="start-comparison-btn" onclick="startComparison()">å¼€å§‹æ¯”è¾ƒ</button>
            <button class="btn btn-default" onclick="clearComparisonSelections()">æ¸…ç©º</button>
            <div id="comparison-status" class="message-box success" style="display:none;"></div>
        </div>

        <div class="card" id="comparison-results" style="display:none;">
            <h2>æ¯”è¾ƒç»“æœ</h2>
            <div class="results-container">
                <div class="results-box">
                    <h3>âœ¨ å…±åŒä¸Šç­æ—¥æœŸåˆ—è¡¨</h3>
                    <div id="common-dates-list"></div>
                </div>
                <div class="results-box">
                    <h3>ğŸ“Š æ€»ç»“</h3>
                    <div id="comparison-summary"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-t5" class="tab-content" style="display:none;">
        <div class="card">
            <h2>ğŸ” ç­æ¬¡ç»Ÿè®¡æœç´¢</h2>
            <p>å¿«é€Ÿç»Ÿè®¡æŒ‡å®šæ—¥æœŸèŒƒå›´å†…ï¼Œç‰¹å®šç­æ¬¡çš„å‘˜å·¥æ•°é‡å’Œåˆ—è¡¨ã€‚</p>
            <div class="t4-filters">
                <div class="form-group">
                    <label for="date-start-t5">èµ·å§‹æ—¥æœŸ:</label>
                    <input type="date" id="date-start-t5" value="">
                </div>
                <div class="form-group">
                    <label for="date-end-t5">ç»“æŸæ—¥æœŸ:</label>
                    <input type="date" id="date-end-t5" value="">
                </div>
                <div class="form-group">
                    <label for="shift-code-t5">ç­æ¬¡ä»£ç :</label>
                    <input type="text" id="shift-code-t5" placeholder="ä¾‹å¦‚: 9:00, REST, AL">
                </div>
                <button class="btn btn-primary" onclick="performShiftSearch()">ğŸ” æœç´¢ç»Ÿè®¡</button>
            </div>

            <div class="results-container">
                <div class="results-box" style="flex:none; width: 300px;">
                    <h3>æ€»è®¡</h3>
                    <div id="search-summary"></div>
                </div>
                <div class="results-box">
                    <h3>å‘˜å·¥åˆ—è¡¨</h3>
                    <div id="search-employee-list"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let globalScheduleData = {};
    let globalEmployeeNames = [];
    let globalDates = [];

    // --- ç­æ¬¡é¢œè‰²æ˜ å°„ ---
    const SHIFT_COLOR_MAP = {
        'REST': 'shift-rest',
        'OFF': 'shift-off',
        'AL': 'shift-al',
        'MC': 'shift-mc',
        '9:00': 'shift-9',
        '15:00': 'shift-15'
    };

    // --- ç­æ¬¡æ ‡å‡†åŒ–å‡½æ•° (V6.10 å¢å¼º) ---
    function normalizeShiftCode(code) {
        if (!code) return "";
        let cleanCode = code.toUpperCase().trim();

        // 1. ç§»é™¤æ‹¬å·åŠå…¶å†…å®¹ (e.g., 9:00(B), 15:00(C) -> 9:00, 15:00)
        cleanCode = cleanCode.replace(/[\(\)ï¼ˆï¼‰].*/, ''); 
        
        // 2. ç§»é™¤å°¾éšçš„-H/M/Tç­‰ä¿®é¥°ç¬¦ (e.g., 9:00-4H, 15:00-6T -> 9:00, 15:00)
        cleanCode = cleanCode.replace(/-\d+[HMT].*/i, ''); 
        
        // 3. ç§»é™¤ç©ºç™½å’Œé€—å·
        cleanCode = cleanCode.replace(/[\s,ï¼Œ]/g, ''); 

        // 4. å°†å¸¸è§çš„è¯·å‡/ä¼‘æ¯ä»£ç æ ‡å‡†åŒ–
        if (/REST|OFF|ä¼‘/.test(cleanCode)) return 'REST';
        if (/AL|å¹´å‡/.test(cleanCode)) return 'AL';
        if (/MC|ç—…å‡/.test(cleanCode)) return 'MC';
        
        // 5. å°è¯•æå–çº¯æ—¶é—´æ ¼å¼ (e.g., 9:00-18:00 -> 9:00-18:00)
        if (/\d{1,2}:\d{2}/.test(cleanCode)) return cleanCode;

        // 6. æœ€åçš„é€šç”¨æ¸…ç†
        return cleanCode;
    }
    
    // --- 1. æ•°æ®è§£æå’Œåˆå§‹åŒ– (T4) ---
    function parseAndDisplaySchedule() {
        const input = document.getElementById('schedule-input-t4').value.trim();
        if (!input) {
            alert("è¯·è¾“å…¥æ’ç­è¡¨æ•°æ®ï¼");
            return;
        }

        const lines = input.split('\n');
        if (lines.length < 2) {
            alert("æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œè‡³å°‘éœ€è¦åŒ…å«è¡¨å¤´å’Œä¸€è¡Œæ•°æ®ã€‚");
            return;
        }

        // 1. è§£æè¡¨å¤´ (ç¬¬ä¸€è¡Œ)
        const header = lines[0].trim().split('\t');
        if (header.length < 2) {
            alert("è¡¨å¤´æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ç¡®ä¿ä½¿ç”¨Tabåˆ†éš”ã€‚");
            return;
        }
        
        // å‡è®¾ç¬¬ä¸€åˆ—æ˜¯å§“å
        const dateHeaders = header.slice(1); 
        
        // å°è¯•ç¡®å®šæ—¥æœŸèŒƒå›´
        let firstValidDateIndex = -1;
        let lastValidDateIndex = -1;
        
        // æŸ¥æ‰¾ç¬¬ä¸€ä¸ªæœ‰æ•ˆæ—¥æœŸï¼Œå¹¶æ„å»ºå…¨å±€æ—¥æœŸæ•°ç»„
        globalDates = [];
        for (let i = 0; i < dateHeaders.length; i++) {
            // å°è¯•è§£ææ—¥æœŸï¼Œæ ¼å¼å¦‚ "12æœˆ1æ—¥(å‘¨äº”)" æˆ– "12/1 (äº”)"
            let dateStr = dateHeaders[i].replace(/[\(\ï¼ˆ].*[\)\ï¼‰]/g, '').trim();
            // å°è¯•å¤šç§æ—¥æœŸæ ¼å¼ï¼Œä¼˜å…ˆå¹´/æœˆ/æ—¥
            let dateObj = dayjs(dateStr, ['YYYY/M/D', 'M/D', 'MæœˆDæ—¥'], true);
            
            // å¦‚æœè§£æå¤±è´¥ï¼Œå°è¯•åŠ ä¸Šå½“å‰å¹´ä»½ (å‡è®¾å½“å‰å¹´ä»½ä¸º 2025)
            if (!dateObj.isValid()) {
                 dateObj = dayjs(`2025å¹´${dateStr}`, ['YYYYå¹´MæœˆDæ—¥', 'YYYYå¹´M/D'], true);
            }
            
            if (dateObj.isValid()) {
                if (firstValidDateIndex === -1) {
                    firstValidDateIndex = i + 1; // +1 å› ä¸ºè¦è·³è¿‡å§“ååˆ—
                }
                lastValidDateIndex = i + 1;
                // å­˜å‚¨æ ‡å‡†åŒ–çš„æ—¥æœŸå­—ç¬¦ä¸²
                globalDates.push(dateObj.format('YYYY-MM-DD')); 
            } else if (firstValidDateIndex !== -1) {
                 // å¦‚æœä¸­é—´å‡ºç°æ— æ•ˆæ—¥æœŸï¼Œä½†å‰é¢å·²æœ‰æœ‰æ•ˆæ—¥æœŸï¼Œä»å°†å®ƒè§†ä¸ºæ—¥æœŸ
                 // è¿™ç§æƒ…å†µé€šå¸¸æ˜¯ç»Ÿè®¡åˆ—ï¼Œæˆ‘ä»¬å°†å…¶è®¾ä¸º null
                 globalDates.push(null);
            }
        }

        if (firstValidDateIndex === -1) {
            alert("æœªèƒ½è¯†åˆ«å‡ºæœ‰æ•ˆçš„æ—¥æœŸåˆ—ï¼Œè¯·æ£€æŸ¥æ•°æ®ã€‚");
            return;
        }

        // 2. è§£ææ•°æ®è¡Œ (å‘˜å·¥æ’ç­)
        globalScheduleData = {};
        globalEmployeeNames = [];

        for (let i = 1; i < lines.length; i++) {
            const row = lines[i].trim();
            if (!row) continue;

            const cells = row.split('\t');
            const employeeName = cells[0].trim();
            
            if (!employeeName) continue;

            globalEmployeeNames.push(employeeName);
            globalScheduleData[employeeName] = {};

            // ä»ç¬¬ä¸€ä¸ªæ—¥æœŸåˆ—å¼€å§‹å¤„ç†
            const shiftCells = cells.slice(firstValidDateIndex, lastValidDateIndex + 1);
            
            for (let j = 0; j < shiftCells.length; j++) {
                const date = globalDates[j];
                const shift = shiftCells[j].trim();
                if (date) { // åªå­˜å‚¨æœ‰æ•ˆæ—¥æœŸçš„æ’ç­
                    globalScheduleData[employeeName][date] = shift;
                }
            }
        }
        
        if (globalEmployeeNames.length === 0) {
            alert("æœªèƒ½è§£æå‡ºä»»ä½•å‘˜å·¥æ•°æ®ï¼Œè¯·æ£€æŸ¥æ•°æ®ã€‚");
            return;
        }

        // 3. æ¸²æŸ“è¡¨æ ¼ (T4)
        renderScheduleTable(header, globalEmployeeNames, globalDates, globalScheduleData, firstValidDateIndex, lastValidDateIndex);

        // 4. åˆå§‹åŒ–å…¶ä»–Tabsçš„æ•°æ®
        initializeT2Selectors();
        initializeT3Selector();
        initializeT5Dates();
        
        // æ˜¾ç¤ºæˆåŠŸçš„æ¶ˆæ¯
        const dateStart = dayjs(globalDates[0]).format('YYYYå¹´MæœˆDæ—¥');
        const dateEnd = dayjs(globalDates[globalDates.length - 1]).format('YYYYå¹´MæœˆDæ—¥');
        const message = `âœ… æ’ç­æ•°æ®è§£ææˆåŠŸï¼å…±æ‰¾åˆ° ${globalEmployeeNames.length} ä½å‘˜å·¥ï¼Œæ—¥æœŸèŒƒå›´ï¼š${dateStart} è‡³ ${dateEnd}ã€‚`;
        
        const outputDiv = document.getElementById('schedule-output-t4');
        outputDiv.insertAdjacentHTML('beforebegin', `<div class="message-box success">${message}</div>`);
        // æ¸…ç†æ—§æ¶ˆæ¯
        setTimeout(() => {
            const oldMessages = outputDiv.previousElementSibling;
            if (oldMessages && oldMessages.classList.contains('message-box')) {
                oldMessages.remove();
            }
        }, 5000);
    }

    // --- 2. æ¸²æŸ“å¯è§†åŒ–æ’ç­è¡¨ (T4) ---
    function renderScheduleTable(header, employeeNames, dates, scheduleData, firstDateIndex, lastDateIndex) {
        const tableContainer = document.getElementById('schedule-output-t4');
        let html = '<table class="schedule-table"><thead><tr>';

        // æ¸²æŸ“è¡¨å¤´
        html += `<th>${header[0]}</th>`; // å§“ååˆ—

        // æ¸²æŸ“æ—¥æœŸå’Œæ˜ŸæœŸ
        for (let i = 0; i < dates.length; i++) {
            const date = dates[i];
            if (date) {
                const dayjsDate = dayjs(date);
                const dayStr = dayjsDate.format('MæœˆDæ—¥');
                const weekStr = dayjsDate.format('ï¼ˆdddï¼‰');
                html += `<th>${dayStr}<br>${weekStr}</th>`;
            } else {
                // å¤„ç†éæ—¥æœŸåˆ— (å¦‚ç»Ÿè®¡åˆ—)
                html += `<th>${header[firstDateIndex + i]}</th>`;
            }
        }
        
        // æ¸²æŸ“åŸå§‹æ’ç­è¡¨å¤´ä¸­çš„ç»Ÿè®¡åˆ—
        for (let i = lastDateIndex + 1; i < header.length; i++) {
             html += `<th>${header[i]}</th>`;
        }

        html += '</tr></thead><tbody>';

        // æ¸²æŸ“æ•°æ®è¡Œ
        employeeNames.forEach(name => {
            html += `<tr><th>${name}</th>`; // å§“ååˆ—
            
            // æ¸²æŸ“ç­æ¬¡
            for (let i = 0; i < dates.length; i++) {
                const date = dates[i];
                if (date) {
                    const shiftCode = scheduleData[name][date] || '';
                    const normalizedShift = normalizeShiftCode(shiftCode);
                    const colorClass = SHIFT_COLOR_MAP[normalizedShift] || (normalizedShift.includes(':') ? 'shift-special' : '');
                    html += `<td class="${colorClass}" title="${shiftCode}">${shiftCode}</td>`;
                } else {
                    // æ¸²æŸ“éæ—¥æœŸåˆ— (ç»Ÿè®¡åˆ—)ï¼Œä½¿ç”¨åŸå§‹æ•°æ®
                    const originalIndex = firstDateIndex + i;
                    const originalCells = document.getElementById('schedule-input-t4').value.split('\n').find(line => line.includes(name)).split('\t');
                    html += `<td>${originalCells[originalIndex] || ''}</td>`;
                }
            }
            
            // æ¸²æŸ“åŸå§‹æ’ç­è¡¨å°¾éƒ¨çš„ç»Ÿè®¡åˆ—
            const originalRow = document.getElementById('schedule-input-t4').value.split('\n').find(line => line.includes(name));
            if (originalRow) {
                const originalCells = originalRow.split('\t');
                for (let i = lastDateIndex + 1; i < header.length; i++) {
                    html += `<td>${originalCells[i] || ''}</td>`;
                }
            }


            html += '</tr>';
        });

        html += '</tbody></table>';
        tableContainer.innerHTML = html;
    }

    // --- 3. å¤šäººç­è¡¨æ¯”è¾ƒ (T2) ---
    function initializeT2Selectors() {
        const selectsContainer = document.getElementById('comparison-selects');
        selectsContainer.innerHTML = '';
        document.getElementById('comparison-results').style.display = 'none';
        document.getElementById('comparison-status').style.display = 'none';
        
        if (globalEmployeeNames.length === 0) {
            document.getElementById('t2-message-box').style.display = 'block';
            document.getElementById('t2-message-box').className = 'message-box error';
            document.getElementById('t2-message-box').innerHTML = 'âŒ è¯·å…ˆåœ¨â€œå¯è§†åŒ–æ’ç­è¡¨â€ä¸­å¯¼å…¥å¹¶è§£ææ•°æ®ï¼';
            document.getElementById('start-comparison-btn').disabled = true;
            return;
        }

        document.getElementById('t2-message-box').style.display = 'none';
        document.getElementById('start-comparison-btn').disabled = false;

        for (let i = 0; i < 4; i++) {
            const select = document.createElement('select');
            select.id = `employee-select-${i}`;
            select.name = `employee-select-${i}`;
            select.className = 'comparison-employee-select';
            
            let optionsHtml = '<option value="">- è¯·é€‰æ‹©å‘˜å·¥ -</option>';
            globalEmployeeNames.forEach(name => {
                optionsHtml += `<option value="${name}">${name}</option>`;
            });
            select.innerHTML = optionsHtml;
            selectsContainer.appendChild(select);

            if (i >= 2) {
                select.style.display = 'block'; // é»˜è®¤æ˜¾ç¤º4ä¸ªï¼Œæ–¹ä¾¿é€‰æ‹©
            }
            
            // é»˜è®¤é€‰ä¸­å‰å››ä¸ªäººï¼Œæ–¹ä¾¿æµ‹è¯•å’Œæ¼”ç¤º
            if (i < 4 && globalEmployeeNames[i]) {
                select.value = globalEmployeeNames[i];
            }
        }
    }

    function clearComparisonSelections() {
        document.querySelectorAll('.comparison-employee-select').forEach(select => {
            select.selectedIndex = 0;
        });
        document.getElementById('comparison-results').style.display = 'none';
        document.getElementById('comparison-status').style.display = 'none';
    }

    function startComparison() {
        const selectedNames = Array.from(document.querySelectorAll('.comparison-employee-select'))
            .map(select => select.value)
            .filter(name => name);

        if (selectedNames.length < 2) {
            alert('è¯·è‡³å°‘é€‰æ‹© 2 ä½å‘˜å·¥è¿›è¡Œæ¯”è¾ƒï¼');
            return;
        }

        if (selectedNames.length > 4) {
             alert('æœ€å¤šåªèƒ½æ¯”è¾ƒ 4 ä½å‘˜å·¥ï¼');
            return;
        }

        const commonDates = [];
        let totalWorkingDays = 0;

        // æ¯”è¾ƒçš„æ—¥æœŸèŒƒå›´
        const dateRange = globalDates.filter(date => date !== null); 
        
        dateRange.forEach(date => {
            let isCommonShift = true;
            let firstShift = null;

            selectedNames.forEach(name => {
                const shiftCode = globalScheduleData[name][date] || '';
                const normalizedShift = normalizeShiftCode(shiftCode);
                
                // 1. æ£€æŸ¥æ˜¯å¦ä¼‘æ¯æˆ–è¯·å‡
                if (['REST', 'AL', 'MC'].includes(normalizedShift) || normalizedShift === '') {
                    isCommonShift = false;
                    return;
                }
                
                // 2. æ£€æŸ¥ç­æ¬¡æ˜¯å¦ä¸€è‡´
                if (firstShift === null) {
                    firstShift = normalizedShift;
                } else if (firstShift !== normalizedShift) {
                    isCommonShift = false;
                }
            });

            if (isCommonShift) {
                commonDates.push({ date: date, shift: firstShift });
            }
        });

        // ç»Ÿè®¡å…±åŒä¸Šç­å¤©æ•°
        totalWorkingDays = commonDates.length;

        // æ¸²æŸ“ç»“æœ
        const listDiv = document.getElementById('common-dates-list');
        const summaryDiv = document.getElementById('comparison-summary');
        const statusBox = document.getElementById('comparison-status');
        
        listDiv.innerHTML = '';
        if (commonDates.length === 0) {
            listDiv.textContent = 'æœªæ‰¾åˆ°ä»»ä½•å…±åŒå®Œå…¨ä¸€è‡´çš„ä¸Šç­æ—¥ã€‚';
        } else {
            commonDates.forEach(item => {
                const dateObj = dayjs(item.date);
                listDiv.innerHTML += `${dateObj.format('MæœˆDæ—¥')}: ${item.shift}\n`;
            });
        }
        
        const summaryText = `
æ¯”è¾ƒäººå‘˜: ${selectedNames.join(' vs ')}
æ¯”è¾ƒèŒƒå›´å¤©æ•°: ${dateRange.length} å¤©

âœ¨ å…±åŒä¸Šç­æ€»å¤©æ•° (ç­æ¬¡éœ€å®Œå…¨ä¸€è‡´):
${totalWorkingDays} å¤©
        `.trim();
        
        summaryDiv.textContent = summaryText;

        const statusMessage = `æ¯”è¾ƒæˆåŠŸ! å…±æ‰¾åˆ° ${totalWorkingDays} ä¸ªå…±åŒå®Œå…¨ä¸€è‡´çš„ä¸Šç­æ—¥ã€‚`;
        statusBox.className = totalWorkingDays > 0 ? 'message-box success' : 'message-box error';
        statusBox.textContent = statusMessage;
        statusBox.style.display = 'block';
        
        document.getElementById('comparison-results').style.display = 'block';
    }

    // --- 4. å•äººç­è¡¨ç”Ÿæˆ (T3) ---
    function initializeT3Selector() {
        const select = document.getElementById('employee-select-t3');
        select.innerHTML = '';
        
        if (globalEmployeeNames.length === 0) {
             select.innerHTML = '<option value="">è¯·å…ˆå¯¼å…¥æ•°æ®</option>';
             return;
        }

        let optionsHtml = '<option value="">- è¯·é€‰æ‹©å‘˜å·¥ -</option>';
        globalEmployeeNames.forEach(name => {
            optionsHtml += `<option value="${name}">${name}</option>`;
        });
        select.innerHTML = optionsHtml;
    }

    function generateSingleSchedule() {
        const employeeName = document.getElementById('employee-select-t3').value;
        const output = document.getElementById('single-schedule-output');
        output.value = '';

        if (!employeeName) {
            alert("è¯·é€‰æ‹©ä¸€ä½å‘˜å·¥ï¼");
            return;
        }

        const employeeData = globalScheduleData[employeeName];
        if (!employeeData) {
            output.value = `æœªæ‰¾åˆ°å‘˜å·¥ ${employeeName} çš„æ’ç­æ•°æ®ã€‚`;
            return;
        }

        let result = `--- ${employeeName} ä¸ªäººæ’ç­è¡¨ ---\n`;
        let workingDays = 0;

        globalDates.filter(d => d).forEach(date => {
            const dateObj = dayjs(date);
            const shiftCode = employeeData[date] || 'æœªæ’ç­';
            const normalizedShift = normalizeShiftCode(shiftCode);
            
            result += `${dateObj.format('YYYYå¹´MæœˆDæ—¥ (ddd)')}: ${shiftCode}\n`;
            
            if (normalizedShift !== 'REST' && normalizedShift !== 'AL' && normalizedShift !== 'MC' && shiftCode !== '') {
                 workingDays++;
            }
        });
        
        result += `\n--- æ€»ç»“ ---\n`;
        result += `æ’ç­æ€»å¤©æ•°: ${globalDates.filter(d => d).length} å¤©\n`;
        result += `é¢„ä¼°å·¥ä½œå¤©æ•° (æ’é™¤ REST/AL/MC): ${workingDays} å¤©\n`;

        output.value = result;
    }

    // --- 5. ç­æ¬¡ç»Ÿè®¡æœç´¢ (T5) ---
    function initializeT5Dates() {
        const today = dayjs().format('YYYY-MM-DD');
        document.getElementById('date-start-t5').value = dayjs().startOf('month').format('YYYY-MM-DD');
        document.getElementById('date-end-t5').value = dayjs().endOf('month').format('YYYY-MM-DD');
    }

    function performShiftSearch() {
        if (globalEmployeeNames.length === 0) {
            alert('è¯·å…ˆåœ¨â€œå¯è§†åŒ–æ’ç­è¡¨â€ä¸­å¯¼å…¥å¹¶è§£ææ•°æ®ï¼');
            return;
        }

        const dateStartStr = document.getElementById('date-start-t5').value;
        const dateEndStr = document.getElementById('date-end-t5').value;
        const shiftCodeInput = document.getElementById('shift-code-t5').value.trim();

        if (!dateStartStr || !dateEndStr || !shiftCodeInput) {
            alert('è¯·å¡«å†™èµ·å§‹æ—¥æœŸã€ç»“æŸæ—¥æœŸå’Œç­æ¬¡ä»£ç ï¼');
            return;
        }

        const dateStart = dayjs(dateStartStr);
        const dateEnd = dayjs(dateEndStr);
        
        // æ”¯æŒé€—å·åˆ†éš”çš„å¤šä¸ªç­æ¬¡ä»£ç 
        const targetShifts = shiftCodeInput.split(/[,\sï¼Œ]+/).map(s => normalizeShiftCode(s)).filter(s => s !== '');

        if (targetShifts.length === 0) {
            alert('è¯·æä¾›æœ‰æ•ˆçš„ç­æ¬¡ä»£ç ï¼');
            return;
        }

        const searchResults = {}; // { employeeName: [date1, date2, ...] }
        let totalOccurrences = 0;
        
        // ç­›é€‰å‡ºåœ¨æ—¥æœŸèŒƒå›´å†…çš„æœ‰æ•ˆæ—¥æœŸ
        const datesToSearch = globalDates.filter(d => d && dayjs(d).isBetween(dateStart, dateEnd, 'day', '[]'));

        globalEmployeeNames.forEach(name => {
            searchResults[name] = [];
            
            datesToSearch.forEach(date => {
                const shiftCode = globalScheduleData[name][date] || '';
                const normalizedShift = normalizeShiftCode(shiftCode);
                
                if (targetShifts.includes(normalizedShift)) {
                    searchResults[name].push(dayjs(date).format('MæœˆDæ—¥(ddd)'));
                    totalOccurrences++;
                }
            });
        });

        // æ¸²æŸ“ç»“æœ
        const summaryDiv = document.getElementById('search-summary');
        const listDiv = document.getElementById('search-employee-list');
        
        const employeeCount = Object.keys(searchResults).filter(name => searchResults[name].length > 0).length;

        summaryDiv.innerHTML = `
        æœç´¢ç­æ¬¡: ${targetShifts.join(' / ')}
        æ—¥æœŸèŒƒå›´: ${dateStart.format('YYYY/M/D')} è‡³ ${dateEnd.format('YYYY/M/D')}
        <br>
        <hr>
        **æ€»è®¡å¤©æ¬¡:** ${totalOccurrences} å¤©æ¬¡
        **æ¶‰åŠå‘˜å·¥æ•°:** ${employeeCount} äºº
        `;
        
        let listHtml = '';
        if (employeeCount === 0) {
            listHtml = '<p>åœ¨è¯¥æ—¥æœŸèŒƒå›´å†…ï¼Œæœªæ‰¾åˆ°å‘˜å·¥æœ‰æ­¤ç­æ¬¡ã€‚</p>';
        } else {
            Object.keys(searchResults).forEach(name => {
                if (searchResults[name].length > 0) {
                    listHtml += `**${name}** (${searchResults[name].length} å¤©):\n`;
                    listHtml += `  ${searchResults[name].join(', ')}\n\n`;
                }
            });
        }
        
        listDiv.textContent = listHtml; // ä½¿ç”¨ textContent ä¿æŒ pre-wrap æ ¼å¼
    }


    // --- 6. Tab åˆ‡æ¢é€»è¾‘ ---
    document.addEventListener('DOMContentLoaded', () => {
        const navItems = document.querySelectorAll('.nav-item');
        const tabContents = document.querySelectorAll('.tab-content');

        navItems.forEach(item => {
            item.addEventListener('click', () => {
                const targetTab = item.getAttribute('data-tab');

                // ç§»é™¤æ‰€æœ‰ active çŠ¶æ€
                navItems.forEach(nav => nav.classList.remove('active'));
                tabContents.forEach(content => content.style.display = 'none');

                // æ¿€æ´»å½“å‰ Tab
                item.classList.add('active');
                document.getElementById(`tab-${targetTab}`).style.display = 'block';

                // ç¡®ä¿æ•°æ®å·²åŠ è½½æ—¶ï¼ŒT2/T3/T5çš„ä¸‹æ‹‰æ¡†å’Œæ—¥æœŸæ˜¯åˆå§‹åŒ–çš„
                if (globalEmployeeNames.length > 0) {
                    if (targetTab === 't2') initializeT2Selectors();
                    if (targetTab === 't3') initializeT3Selector();
                    if (targetTab === 't5') initializeT5Dates();
                }
            });
        });
        
        // åˆå§‹åŠ è½½æ—¶é€‰ä¸­ T4
        document.querySelector('.nav-item[data-tab="t4"]').click(); 
    });
</script>

</body>
</html>
