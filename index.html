<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>é£ä¹¦æ’ç­å¯è§†åŒ–çœ‹æ¿</title>
  <meta name="viewport" content="width=device-width, initial-width=1.0">
  <style>
    :root { --primary: #2563eb; --bg: #f1f5f9; --text: #1e293b; --border: #cbd5e1; --shadow: 0 4px 15px rgba(0,0,0,0.08); }
    body { 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
        background: var(--bg); 
        color: var(--text); 
        padding: 10px; 
        margin: 0; 
        display: flex; 
        flex-direction: column; 
        min-height: 100vh;
    }
    
    .app-container { 
        width: 1200px; 
        margin: 0 auto; 
        background: white; 
        border-radius: 12px; 
        box-shadow: var(--shadow); 
        overflow: hidden; 
        display: flex; 
        flex-direction: column; 
        flex-grow: 1; 
    }
    
    .header { background: #1e293b; color: white; padding: 15px 20px; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
    .header h1 { margin: 0; font-size: 18px; }

    .tabs { display: flex; background: #f8fafc; border-bottom: 1px solid var(--border); }
    .tab-btn { flex: 1; border: none; background: none; color: #64748b; padding: 12px; cursor: pointer; white-space: nowrap; font-weight: 500; transition: 0.2s; max-width: 300px; }
    .tab-btn.active { color: var(--primary); background: white; font-weight: bold; border-bottom: 3px solid var(--primary); }

    .content-area { padding: 24px; flex-grow: 1; display: flex; flex-direction: column; }
    .tab-content { display: none; }
    .tab-content.active { display: flex; flex-direction: column; flex-grow: 1; }
    
    textarea { 
        width: 100%; 
        box-sizing: border-box; 
        border: 1px solid #cbd5e1; 
        border-radius: 6px; 
        padding: 8px; 
        font-size: 12px; 
        font-family: monospace; 
        resize: vertical; 
        min-height: 100px; 
        margin-bottom: 10px; 
    }
    textarea:focus { outline: 2px solid var(--primary); border-color: transparent; }
    input[type="text"], select { width: 100%; box-sizing: border-box; border: 1px solid #cbd5e1; border-radius: 6px; padding: 8px; margin-bottom: 10px; }
    
    .btn-group { display: flex; gap: 10px; margin-top: 10px; }
    .btn { background: white; border: 1px solid #cbd5e1; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; color: #334155; transition: 0.2s; }
    .btn-primary { background: var(--primary); color: white; border-color: var(--primary); }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-clear { background: #fee2e2; color: #b91c1c; border-color: #fecaca; }
    
    .status-msg { margin-top: 5px; font-size: 13px; font-weight: bold; padding: 10px; border-radius: 6px; }
    .status-msg.ok { color: #16a34a; background: #dcfce7; border: 1px solid #bbf7d0; }
    .status-msg.error { color: #dc2626; background: #fee2e2; border: 1px solid #fecaca; }

    /* T4 å¯è§†åŒ–å¸ƒå±€ */
    .main-layout { display: flex; flex: 1; overflow: hidden; }
    .input-sidebar { width: 400px; background: #f8fafc; border-right: 1px solid var(--border); padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
    .visual-area { flex: 1; overflow: hidden; display: flex; flex-direction: column; position: relative; }
    .visual-placeholder { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #94a3b8; text-align: center; }
    .status-bar { padding: 8px 15px; background: #fff7ed; border-bottom: 1px solid #fed7aa; font-size: 12px; color: #9a3412; display: none; }
    .status-bar.show { display: block; }
    
    .table-wrapper { flex: 1; overflow: auto; position: relative; }
    
    /* è¡¨æ ¼æ ·å¼ */
    table { border-collapse: separate; border-spacing: 0; width: max-content; font-size: 12px; }
    th, td { border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; padding: 6px 10px; text-align: center; vertical-align: middle; white-space: nowrap; }
    
    /* å¤´éƒ¨å›ºå®š */
    thead { position: sticky; top: 0; z-index: 20; background: #f1f5f9; }
    thead th { background: #f1f5f9; font-weight: 600; color: #475569; border-bottom: 2px solid #cbd5e1; height: 30px; }
    
    /* äººå‘˜åå•åˆ—å›ºå®š */
    tbody th { 
        position: sticky; 
        left: 0; 
        z-index: 10; 
        background: white; 
        font-weight: bold; 
        color: #1e293b; 
        border-right: 2px solid #e2e8f0; 
        min-width: 100px; 
        text-align: left; 
    }
    /* é¡¶å·¦è§’å•å…ƒæ ¼å›ºå®š */
    thead th:first-child { 
        position: sticky; 
        left: 0; 
        z-index: 30; 
        background: #f1f5f9; 
        border-right: 2px solid #e2e8f0; 
    }

    /* ç­æ¬¡è‰²å— */
    .cell-inner { border-radius: 4px; padding: 4px 8px; font-weight: 500; min-width: 40px; }
    .type-off { background-color: #f1f5f9; color: #94a3b8; } 
    .type-work { background-color: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }
    .type-night { background-color: #f3e8ff; color: #6b21a8; border: 1px solid #e9d5ff; }
    .type-leave { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
    .type-al { background-color: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
    .stats-col { font-weight: bold; background: #fffbeb; color: #92400e; }

    /* T1, T2, T3 å…±äº«æ•°æ®æç¤ºæ ·å¼ */
    .shared-data-prompt { background: #ecfdf5; border: 1px solid #a7f3d0; padding: 10px; margin-bottom: 15px; border-radius: 6px; font-size: 13px; color: #065f46; display: flex; justify-content: space-between; align-items: center; }
    .shared-data-prompt button { padding: 4px 10px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; }
    
    /* T2 ç­è¡¨æ¯”è¾ƒæ ·å¼ */
    .t2-selection-group { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px; }
    .t2-selection-group select { min-height: 38px; }

    /* T2/T3 è¾“å‡ºåŒº */
    .output-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .result-box { border: 1px solid #e2e8f0; padding: 15px; border-radius: 8px; background: #f8fafc; display: flex; flex-direction: column;}
    .result-box h4 { margin-top: 0; color: #0f766e; }
    .result-box textarea { min-height: 250px; background: white; flex-grow: 1;}
    .output-actions { display: flex; gap: 10px; margin-top: 5px; justify-content: flex-end;}
    
    /* Footer: æ˜¾ç¤ºç‰ˆæœ¬å· */
    .footer { text-align: center; padding: 10px 0; font-size: 11px; color: #94a3b8; flex-shrink: 0; }
    .footer span { font-weight: bold; }

  </style>
</head>
<body>

<div class="app-container">
  <div class="header">
    <h1>é£ä¹¦æ’ç­å¯è§†åŒ–çœ‹æ¿</h1> 
  </div>
  
  <div class="tabs">
    <button class="tab-btn" onclick="AppUI.switchTab('t4')">å¯è§†åŒ–æ’ç­è¡¨</button>
    <button class="tab-btn active" onclick="AppUI.switchTab('t1')">å•äººç­è¡¨ç”Ÿæˆ</button>
    <button class="tab-btn" onclick="AppUI.switchTab('t2')">å¤šäººç­è¡¨æ¯”è¾ƒ</button>
    <button class="tab-btn" onclick="AppUI.switchTab('t3')">ç­æ¬¡ç»Ÿè®¡æœç´¢</button>
  </div>

  <div class="content-area">

    <div id="t1" class="tab-content active" style="padding: 0;">
      <div id="shared_prompt_t1" class="shared-data-prompt" style="display:none;">
        <span>âœ… æ‰¾åˆ°å…±äº«æ’ç­æ•°æ®ï¼Œè¯·é€‰æ‹©ä¸€ä½å‘˜å·¥ï¼š</span>
        <select id="t1_select_name"></select>
        <button class="btn-primary" onclick="App.t1_use_shared()">ç”Ÿæˆ</button>
      </div>
      
      <h3>ç²˜è´´å•äººæ’ç­æ•°æ® (æ—¥æœŸ+æ˜ŸæœŸ+ç­æ¬¡)</h3>
      <span style="font-size:12px; color:#64748b;">è¯·å¤åˆ¶ä¸‰è¡Œå®Œæ•´æ•°æ®ï¼Œä¾‹å¦‚ï¼š12æœˆ1æ—¥... æ˜ŸæœŸä¸€... 9:00...</span>
      <textarea id="in1_raw" style="min-height:150px; margin-top:5px;" placeholder="ç²˜è´´å•äººä¸‰è¡Œæ•°æ®"></textarea>
      <div class="btn-group">
        <button class="btn btn-primary" onclick="App.t1_parse()">ç”Ÿæˆæ¯æ—¥ç­è¡¨</button>
        <button class="btn" onclick="AppUI.clear1()">æ¸…ç©º</button>
      </div>
      <div id="st1" class="status-msg"></div>
      
      <h3 id="t1_output_title" style="margin-top: 20px;">ç”Ÿæˆç»“æœ (æ¯æ—¥æ—¥æœŸ: ç­æ¬¡)</h3>
      <textarea id="out1" style="flex-grow:1; background:#f0f9ff;" readonly placeholder="ç”Ÿæˆç»“æœå°†åœ¨æ­¤æ˜¾ç¤º"></textarea>
      <div class="output-actions">
        <button class="btn" onclick="AppUI.copyToClipboard('out1')">ğŸ“‹ å¤åˆ¶ç»“æœ</button>
        <button class="btn" onclick="AppUI.exportToFile('out1', document.getElementById('t1_output_title').textContent.replace(/ã€|ã€‘/g, '_').replace(/ç”Ÿæˆç»“æœ \(æ¯æ—¥æ—¥æœŸ: ç­æ¬¡\)/, 'ç­è¡¨'))">ğŸ“¤ å¯¼å‡ºä¸ºTXT</button>
      </div>
    </div>

    <div id="t2" class="tab-content" style="padding: 0;">
        <div id="shared_prompt_t2" class="shared-data-prompt" style="display:none;">
          <span>âœ… æ‰¾åˆ°å…±äº«æ’ç­æ•°æ®ï¼Œè¯·é€‰æ‹© 2-4 ä½å‘˜å·¥è¿›è¡Œæ¯”è¾ƒï¼š</span>
          <button class="btn-primary" onclick="App.t2_compare_shared()">ğŸ” æ¯”è¾ƒ</button>
        </div>

        <div id="t2_manual_input">
            <h3>1. ç²˜è´´æ—¥æœŸè¡Œ (åªéœ€ä¸€æ¬¡)</h3>
            <textarea id="in2_dates" placeholder="ç²˜è´´ï¼š12æœˆ1æ—¥ 12æœˆ2æ—¥... (åªéœ€ä¸€æ¬¡)"></textarea>
            
            <h3>2. ç²˜è´´ç­æ¬¡è¡Œ (æœ€å¤š4äºº)</h3>
            <div class="t2-selection-group">
                <div class="t2-person">
                    <input id="in2_name1" placeholder="å§“å 1 (å¿…å¡«)" value="å‘˜å·¥ A">
                    <textarea id="in2_raw1" placeholder="ç²˜è´´å‘˜å·¥ A çš„ç­æ¬¡è¡Œ"></textarea>
                </div>
                <div class="t2-person">
                    <input id="in2_name2" placeholder="å§“å 2 (å¿…å¡«)" value="å‘˜å·¥ B">
                    <textarea id="in2_raw2" placeholder="ç²˜è´´å‘˜å·¥ B çš„ç­æ¬¡è¡Œ"></textarea>
                </div>
                <div class="t2-person">
                    <input id="in2_name3" placeholder="å§“å 3 (å¯é€‰)">
                    <textarea id="in2_raw3" placeholder="ç²˜è´´å‘˜å·¥ C çš„ç­æ¬¡è¡Œ (å¯é€‰)"></textarea>
                </div>
                <div class="t2-person">
                    <input id="in2_name4" placeholder="å§“å 4 (å¯é€‰)">
                    <textarea id="in2_raw4" placeholder="ç²˜è´´å‘˜å·¥ D çš„ç­æ¬¡è¡Œ (å¯é€‰)"></textarea>
                </div>
            </div>
        </div>
        
        <div id="t2_shared_selection" style="display: none;">
            <h3>è¯·é€‰æ‹©éœ€è¦æ¯”è¾ƒçš„ 2-4 ä½å‘˜å·¥</h3>
            <div class="t2-selection-group">
                <select id="t2_select_1"></select>
                <select id="t2_select_2"></select>
                <select id="t2_select_3"></select>
                <select id="t2_select_4"></select>
            </div>
        </div>

        <div class="btn-group">
            <button class="btn btn-primary" onclick="App.t2_compare()">ğŸ” å¼€å§‹æ¯”è¾ƒ</button>
            <button class="btn btn-clear" onclick="AppUI.clear2()">æ¸…ç©º</button>
        </div>
        <div id="st2" class="status-msg"></div>

        <h3 style="margin-top: 20px;">æ¯”è¾ƒç»“æœ</h3>
        <div class="output-grid">
            <div class="result-box">
                <h4>ğŸ‰ å…±åŒä¸Šç­æ—¥æœŸåˆ—è¡¨</h4>
                <textarea id="out2_list" readonly placeholder="å…±åŒä¸Šç­çš„æ—¥æœŸå’Œç­æ¬¡å°†åœ¨æ­¤æ˜¾ç¤º"></textarea>
            </div>
            <div class="result-box">
                <h4>ğŸ“Š æ€»ç»“</h4>
                <textarea id="out2_summary" readonly placeholder="æ€»è®¡å…±åŒä¸Šç­å¤©æ•°"></textarea>
            </div>
        </div>
    </div>

    <div id="t3" class="tab-content" style="padding: 0;">
        <div id="shared_prompt_t3" class="shared-data-prompt" style="display:none;">
          <span>âœ… æ­£åœ¨ä½¿ç”¨å…±äº«æ’ç­æ•°æ®ï¼Œæ— éœ€ç²˜è´´ã€‚</span>
          <button class="btn-primary" onclick="App.t3_search()">ğŸ” æœç´¢</button>
        </div>
        
        <div id="t3_manual_input">
            <h3>1. ç²˜è´´å…¨éƒ¨äººå‘˜åå• (å§“ååˆ—)</h3>
            <textarea id="in3_names" placeholder="ç²˜è´´å§“ååˆ—ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰"></textarea>
            
            <h3>2. ç²˜è´´å…¨éƒ¨ç­æ¬¡çŸ©é˜µ (ä»£ç è¡Œ)</h3>
            <textarea id="in3_codes" style="min-height:150px;" placeholder="ç²˜è´´å…¨éƒ¨äººå‘˜çš„ç­æ¬¡ä»£ç è¡Œ"></textarea>
        </div>

        <h3>3. æœç´¢ç‰¹å®šç­æ¬¡ä»£ç </h3>
        <div class="t3-search-group" style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
            <input type="text" id="in3_search" placeholder="ä¾‹å¦‚: MC, 9:00, AL" value="MC">
            <button class="btn btn-primary" onclick="App.t3_search()">ğŸ” å¼€å§‹æœç´¢ç»Ÿè®¡</button>
            <button class="btn btn-clear" onclick="AppUI.clear3()">æ¸…ç©º</button>
        </div>
        <div id="st3" class="status-msg"></div>

        <h3 style="margin-top: 20px;">ç»Ÿè®¡ç»“æœ</h3>
        <div class="output-grid">
            <div class="result-box">
                <h4>ğŸ‘¤ æ¶‰åŠäººå‘˜åå•åŠæ¬¡æ•°</h4>
                <textarea id="out3_list" readonly placeholder="å°†æ˜¾ç¤ºåŒ¹é…äººå‘˜å’Œä»–ä»¬å‡ºç°çš„æ¬¡æ•°"></textarea>
            </div>
            <div class="result-box">
                <h4>ğŸ“Š æ€»ç»“</h4>
                <textarea id="out3_summary" readonly placeholder="æ€»è®¡æ¬¡æ•°ã€æ€»è®¡äººæ•°"></textarea>
            </div>
        </div>
    </div>

    <div id="t4" class="tab-content main-layout">
        <div class="input-sidebar">
          <h3 style="margin-top: 0;">1. æ—¥æœŸè¡Œ (åªéœ€ç²˜è´´æ—¥æœŸå’Œæ˜ŸæœŸ)</h3>
          <textarea id="in_dates" placeholder="ç²˜è´´ï¼š12æœˆ1æ—¥ 12æœˆ2æ—¥ æ˜ŸæœŸä¸€ æ˜ŸæœŸäºŒ ..."></textarea>
          
          <h3>2. å§“ååˆ—è¡¨ (ç²˜è´´å§“ååˆ—)</h3>
          <span style="font-size:12px; color:#1e40af; font-weight:bold;">âœ… ç¨‹åºå°†è‡ªåŠ¨è¿‡æ»¤åˆ†ç»„å’Œå…ƒæ•°æ®è¡Œã€‚</span>
          <textarea id="in_names" placeholder="ç²˜è´´å§“ååˆ—è¡¨ï¼Œç¨‹åºå°†è‡ªåŠ¨è¿‡æ»¤éäººåè¡Œ" style="height:120px;"></textarea>
          
          <h3>3. ç­æ¬¡çŸ©é˜µ (ç²˜è´´ç­æ¬¡ä»£ç åˆ—)</h3>
          <span style="font-size:12px; color:#1e40af; font-weight:bold;">âœ… ç¨‹åºå°†è‡ªåŠ¨è¿‡æ»¤ç»Ÿè®¡è¡Œã€çº¯æ•°å­—è¡Œå’Œçº¯é›¶è¡Œã€‚</span>
          <textarea id="in_codes" placeholder="ç²˜è´´å…¨éƒ¨ç­æ¬¡ä»£ç è¡Œ..." style="height:150px;"></textarea>
          
          <div style="margin-top:auto;">
            <button class="btn btn-primary" onclick="App.t4_render()">ğŸš€ ç”Ÿæˆå¯è§†åŒ–å›¾è¡¨</button>
            <button class="btn btn-clear" onclick="AppUI.clear4()">ğŸ—‘ æ¸…ç©ºæ•°æ®</button>
          </div>
        </div>

        <div class="visual-area">
          <div id="status_msg_t4" class="status-bar"></div>
          <div id="visual_placeholder" class="visual-placeholder">
            <div style="font-size:40px; margin-bottom:10px;">ğŸ“Š</div>
            <div>åœ¨å·¦ä¾§ç²˜è´´æ•°æ®å¹¶ç‚¹å‡»â€œç”Ÿæˆâ€<br>å³å¯æŸ¥çœ‹å¸¦æœ‰é¢œè‰²ç¼–ç çš„æ’ç­è¡¨</div>
          </div>
          <div id="table_container" class="table-wrapper" style="display:none;">
            </div>
        </div>
    </div>

  </div>
</div>

<div class="footer">
    é£ä¹¦æ’ç­å¯è§†åŒ–çœ‹æ¿ Â· Version <span>V6.9 (2025/12/04 å¢å¼ºçº¯ä¸­æ–‡åè¯†åˆ«ç‰ˆ)</span>
</div>

<script>
// UI è¾…åŠ©å‡½æ•°
const AppUI = (function(){
    const $ = id => document.getElementById(id);
    const setStatus = (id, msg, type) => { 
        const el = $(id);
        el.textContent = msg; 
        el.className = `status-msg ${type}`; 
        el.style.display = 'block';
    };
    const hideStatus = (id) => { $(id).style.display = 'none'; };

    function copyToClipboard(elementId) {
        const copyText = $(elementId).value;
        if (!copyText.trim()) {
             setStatus('st1', 'å¤åˆ¶å¤±è´¥ï¼šå†…å®¹ä¸ºç©ºã€‚', 'error');
             return;
        }
        
        navigator.clipboard.writeText(copyText).then(() => {
            setStatus('st1', 'å†…å®¹å·²æˆåŠŸå¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'ok');
            setTimeout(() => hideStatus('st1'), 2000);
        }).catch(err => {
            const textarea = document.createElement('textarea');
            textarea.value = copyText;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                setStatus('st1', 'å†…å®¹å·²æˆåŠŸå¤åˆ¶åˆ°å‰ªè´´æ¿ï¼(é™çº§)', 'ok');
                setTimeout(() => hideStatus('st1'), 2000);
            } catch (err) {
                setStatus('st1', 'å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶æ–‡æœ¬æ¡†å†…å®¹ã€‚', 'error');
            }
            document.body.removeChild(textarea);
        });
    }

    function exportToFile(elementId, baseFileName) {
        const text = $(elementId).value;
        if (!text.trim()) {
            setStatus('st1', 'å¯¼å‡ºå¤±è´¥ï¼šå†…å®¹ä¸ºç©ºã€‚', 'error');
            return;
        }
        const safeFileName = baseFileName.replace(/[^a-z0-9\u4e00-\u9fa5]/gi, '_').replace(/__/g, '_');
        const fileName = `${safeFileName}_${new Date().toISOString().slice(0, 10)}.txt`;
        const blob = new Blob([text], {type: 'text/plain;charset=utf-8'});
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = fileName;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        setStatus('st1', 'æ–‡ä»¶å·²å¼€å§‹ä¸‹è½½ï¼', 'ok');
        setTimeout(() => hideStatus('st1'), 2000);
    }
    
    function populateNameSelects(names, isShared=true) {
        const t1Select = $('t1_select_name');
        t1Select.innerHTML = names.map(n => `<option value="${n}">${n}</option>`).join('');
        
        const t2Selects = ['t2_select_1', 't2_select_2', 't2_select_3', 't2_select_4'];
        const optionsHtml = names.map(n => `<option value="${n}">${n}</option>`).join('');
        t2Selects.forEach((id, index) => {
            const select = $(id);
            select.innerHTML = '<option value="">-- é€‰æ‹©å‘˜å·¥ --</option>' + optionsHtml;
            if (names[index]) {
                select.value = names[index];
            } else {
                select.value = '';
            }
        });
        
        $('t2_manual_input').style.display = isShared ? 'none' : 'block';
        $('t2_shared_selection').style.display = isShared ? 'grid' : 'none';
        
    }

    function switchTab(id){
        document.querySelectorAll('.tab-content').forEach(d=>d.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelector(`.tabs button[onclick*="${id}"]`).classList.add('active');
        
        hideStatus('st1');
        hideStatus('st2');
        hideStatus('st3');
        hideStatus('status_msg_t4');

        if (id !== 't4') {
            App.checkSharedData(id);
        } else {
            App.loadSavedData(); 
        }
    }

    function clear1() { 
        $('in1_raw').value = ''; 
        $('out1').value = ''; 
        hideStatus('st1'); 
        $('in1_raw').disabled = App.SharedData !== null; 
        $('t1_output_title').textContent = "ç”Ÿæˆç»“æœ (æ¯æ—¥æ—¥æœŸ: ç­æ¬¡)";
    }
    function clear2() { 
        $('in2_dates').value = '';
        for(let i=1; i<=4; i++) {
            $(`in2_name${i}`).value = i === 1 ? "å‘˜å·¥ A" : i === 2 ? "å‘˜å·¥ B" : "";
            $(`in2_raw${i}`).value = "";
        }
        $('out2_list').value = '';
        $('out2_summary').value = '';
        hideStatus('st2');
        App.checkSharedData('t2'); 
    }
    function clear3() {
        $('in3_names').value = '';
        $('in3_codes').value = '';
        $('in3_search').value = 'MC';
        $('out3_list').value = '';
        $('out3_summary').value = '';
        hideStatus('st3');
        App.checkSharedData('t3'); 
    }
    function clear4() { 
        $('in_dates').value = ''; $('in_names').value = ''; $('in_codes').value = '';
        localStorage.removeItem('fs_dates');
        localStorage.removeItem('fs_names');
        localStorage.removeItem('fs_codes');
        App.SharedData = null; 
        $('table_container').style.display = 'none';
        $('visual_placeholder').style.display = 'block';
        hideStatus('status_msg_t4');
        
        App.checkSharedData('t1');
        App.checkSharedData('t2');
        App.checkSharedData('t3');
    }
    
    function msgT4(text, isError=false) {
        const el = $('status_msg_t4');
        el.textContent = text;
        el.style.backgroundColor = isError ? '#fee2e2' : '#dcfce7';
        el.style.color = isError ? '#991b1b' : '#166534';
        el.classList.add('show');
        setTimeout(() => el.classList.remove('show'), 5000);
    }

    return { switchTab, setStatus, hideStatus, clear1, clear2, clear3, clear4, msgT4, populateNameSelects, copyToClipboard, exportToFile };
})();

// æ ¸å¿ƒåŠŸèƒ½é€»è¾‘
const App = (function(){
    const $ = id => document.getElementById(id);
    
    let SharedData = null; 

    // --- é€šç”¨å·¥å…·å‡½æ•° ---

    function shiftCodeToTimeRange(code) {
        if (!code) return "";
        let baseCode = code.toUpperCase().trim();
        let startTime = null;

        baseCode = baseCode.replace(/[\(\)ï¼ˆï¼‰].*/, ''); 
        baseCode = baseCode.replace(/-\d+[H|M].*/i, ''); 
        const cleanedCode = baseCode.replace(/[^A-Z0-9:]/g, ''); 

        const mappings = {
            'æ—©æ—©': '08:00', 'ç™½': '09:00', 'ä¸­': '12:00',
            'æ™š': '15:00', 'æ™šæ™š': '17:00', 'å¤œ': '00:00', 
        };

        if (mappings[cleanedCode]) {
            startTime = mappings[cleanedCode];
        } else {
            const timeMatch = cleanedCode.match(/^(\d{1,2}):(\d{2})(:00)?$/);
            if (timeMatch) {
                const hour = parseInt(timeMatch[1]);
                const minute = timeMatch[2];
                if (hour === 0) return '00:00 - 09:00'; 
                startTime = `${String(hour).padStart(2, '0')}:${minute}`;
            } else if (cleanedCode === 'REST' || cleanedCode === 'OFF') {
                return 'ä¼‘æ¯';
            } else if (/AL|MC|PH|UPL|LATE|HL|EL/.test(cleanedCode)) {
                return cleanedCode; 
            } else if (cleanedCode === 'è¯·å‡') {
                return 'è¯·å‡';
            } else if (cleanedCode === 'ç—…å‡') {
                return 'MC';
            } else if (cleanedCode === 'å¹´å‡') {
                return 'AL';
            } else if (code.trim().length > 0) {
                 return code.trim(); 
            } else {
                return "";
            }
        }

        if (startTime) {
            const [hour, minute] = startTime.split(':').map(Number);
            let endHour = hour + 9;
            
            if (endHour >= 24) {
                endHour -= 24; 
            }
            
            const endTime = `${String(endHour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
            return `${startTime} - ${endTime}`;
        }

        return code.trim();
    }

    function extractDates(text) {
        const dateRegex = /(\d{1,2})\s*[æœˆ\/-]\s*(\d{1,2})/g;
        const matches = [...text.matchAll(dateRegex)];
        
        if (matches.length > 0) {
            return matches.map(m => ({
                month: parseInt(m[1]), 
                day: parseInt(m[2]), 
                full: `${m[1]}æœˆ${m[2]}æ—¥`
            }));
        }
        return [];
    }
    
    // V6.8 ç­æ¬¡è¡Œè¿‡æ»¤
    function filterCodeLines(text) {
        const lines = text.split(/[\r\n]+/)
            .map(l => l.trim())
            .filter(l => l); 

        return lines.filter(line => {
            const containsValidCode = /\d{1,2}:\d{2}|OFF|REST|MC|AL|PH|UPL|æ—©æ—©|ç™½|ä¸­|æ™š|æ™šæ™š|å¤œ|HL|EL/i.test(line);
            
            const isDateLine = /æœˆ\d+æ—¥|æ˜ŸæœŸ/.test(line);
            const isPureNumbers = /^[\s\d,ï¼Œ]+$/.test(line.replace(/\s/g, ''));
            const isPureZeros = /^[\s0,ï¼Œ]+$/.test(line.replace(/\s/g, ''));
            
            // æ’é™¤å…ƒæ•°æ®/æ ‡é¢˜è¡Œ (å¢åŠ éƒ¨é—¨åˆ†ç»„æ’é™¤)
            const isMetadata = /TICKET|VIPç­è¡¨|å¤§å®¢æˆ·ç»ç†|IMå·|ç™½9:00|æ™š15:00|ä¼‘|æ—©æ—©|ç™½|ä¸­|æ™š|å¤œ|å‰éš†å¡|æ”¯æ´è´¦æˆ·ç»„|ç­è¡¨|å‘˜å·¥|æ’ç­|åˆæ™´|é›ªä¸½|å‡å¤|å­å¦|å®é›ª/i.test(line);
            
            // æ’é™¤æ–¹æ‹¬å·åŒ…è£¹çš„å†…å®¹
            const isBracketed = /ã€.*ã€‘|\[.*\]/.test(line.trim());


            return containsValidCode && !isDateLine && !isPureNumbers && !isPureZeros && !isMetadata && !isBracketed;
        });
    }

    // ç­æ¬¡ä»£ç åˆ‡å‰²
    function splitCodeLine(line) {
        return line.split(/[\t\s,ï¼Œ]+/).map(code => {
            const cleanCode = code.replace(/[\(\)ï¼ˆï¼‰].*/, '').trim(); 
            return cleanCode || code.trim(); 
        }).filter(Boolean); 
    }
    
    // V6.9 å§“åè¡Œè¿‡æ»¤ (å¢å¼ºå¯¹çº¯ä¸­æ–‡åçš„è¯†åˆ«)
    function filterNameLines(text) {
        const lines = text.split(/[\r\n]+/)
            .map(l => l.trim())
            .filter(l => l);

        const names = lines.filter(line => {
            // 1. æ’é™¤åŒ…å«éäººåå…³é”®è¯çš„è¡Œ (V6.9: å…³é”®è¯åˆ—è¡¨ä¸å˜)
            if (/(IMå·|å·¥å·|Z-\d+|é‚®ç®±|@|TICKET|VIPç­è¡¨|ç™½9:00|æ™š15:00|ä¼‘|æ—©æ—©|ç™½|ä¸­|æ™š|å¤œ|å‰éš†å¡|æ”¯æ´è´¦æˆ·ç»„|ç­è¡¨|å‘˜å·¥|æ’ç­|å¤§å®¢æˆ·ç»ç†|åˆæ™´|é›ªä¸½|å‡å¤|å­å¦|å®é›ª)/i.test(line) ||
                /^[\d\s,ï¼Œ\t]+$/.test(line) || // æ’é™¤æ•°å­—è¡Œ
                line.length < 2 // æ’é™¤å•å­—
               ) 
            {
                return false;
            }
            
            // 2. å¼ºåˆ¶æ’é™¤è¢«æ–¹æ‹¬å·æˆ–ä¸­æ–‡ä¹¦åå·åŒ…è£¹çš„è¡Œ
            if (/ã€.*ã€‘|\[.*\]|ã€Š.*ã€‹/.test(line.trim())) {
                return false;
            }
            
            // 3. V6.9 æ”¹è¿›: åŒºåˆ†çº¯ä¸­æ–‡åå’Œä¸­è‹±æ–‡æ··åˆå
            const isPureChinese = /^[\u4e00-\u9fa5]{2,4}$/.test(line); // 2-4ä¸ªçº¯ä¸­æ–‡å­—
            const isMixedName = /[\u4e00-\u9fa5]/.test(line) && /[a-zA-Z]/.test(line) && line.length > 3; // æ··åˆå
            
            if (!isPureChinese && !isMixedName) {
                // å¦‚æœä¸æ˜¯çº¯ä¸­æ–‡åï¼Œä¹Ÿä¸æ˜¯ä¸­è‹±æ–‡æ··åˆåï¼Œåˆ™è¿›è¡Œæ›´ä¸¥æ ¼çš„æ£€æŸ¥
                if(line.length < 3) return false;
            }
            
            // 4. æ’é™¤åŒ…å«æœ‰æ•ˆç­æ¬¡ä»£ç çš„è¡Œï¼ˆé˜²æ­¢æŠŠç­æ¬¡è¡Œå½“åå­—ï¼‰
            // çº¯ä¸­æ–‡åè¡Œï¼ˆå¦‚ï¼šç‹æ˜ï¼‰åé¢ä¸å¤ªå¯èƒ½è·Ÿä¸€ä¸²ç­æ¬¡ï¼Œå¦‚æœåé¢æœ‰ç­æ¬¡ï¼Œåˆ™åˆ¤å®šä¸ºç­æ¬¡ä»£ç è¡Œã€‚
            // æ’é™¤æ¡ä»¶ï¼šå¦‚æœè¡Œå°¾è·Ÿç€æ˜æ˜¾çš„ç­æ¬¡ä»£ç  (ç©ºæ ¼/tabåè·Ÿç­æ¬¡)
            const containsTrailingShiftCode = /\s+(OFF|REST|MC|AL|\d{1,2}:\d{2})\s*$/.test(line.trim().toUpperCase());

            // ç­æ¬¡ä»£ç è¡Œæ¯”å§“åè¡Œé•¿å¾ˆå¤šï¼Œè¿™é‡Œåªæ£€æŸ¥æ˜¯å¦åŒ…å«æ˜æ˜¾çš„ç­æ¬¡ä»£ç ã€‚
            const containsValidCode = /\d{1,2}:\d{2}|OFF|REST|MC|AL|PH|UPL|æ—©æ—©|ç™½|ä¸­|æ™š|æ™šæ™š|å¤œ|HL|EL/i.test(line);
            
            // é’ˆå¯¹çº¯ä¸­æ–‡åï¼Œå¦‚æœå®ƒåŒ…å«ç­æ¬¡ä»£ç ï¼Œæˆ‘ä»¬å‡è®¾å®ƒä¸æ˜¯å§“åè¡Œã€‚
            if (isPureChinese && containsValidCode) {
                return false;
            }
            // é’ˆå¯¹ä¸­è‹±æ–‡æ··åˆåï¼Œé™¤éå®ƒ**éå¸¸é•¿**æˆ–åŒ…å«å¾ˆå¤šæ•°å­—ï¼Œå¦åˆ™æˆ‘ä»¬å€¾å‘äºä¿ç•™ã€‚
            if (containsTrailingShiftCode && line.length > 10) { 
                 return false; 
            }
            
            // åªè¦æ˜¯ 2-4ä¸ªçº¯ä¸­æ–‡ï¼Œæˆ–è€…ä¸­è‹±æ–‡æ··åˆï¼Œå¹¶ä¸”æ²¡æœ‰è¢«å…³é”®è¯ã€æ–¹æ‹¬å·æˆ–ç­æ¬¡ä»£ç æ’é™¤ï¼Œå°±ä¿ç•™ã€‚
            return true;
        }).map(name => {
             // æ¸…ç†æ‰è¡Œå°¾çš„ IMå·æˆ–æ‹¬å·å†…çš„æ— å…³ä¿¡æ¯
             return name.replace(/\s*IMå·.*/i, '').replace(/["â€œâ€]/g, '').trim();
        });

        // æœ€ç»ˆå»é‡å’ŒäºŒæ¬¡æ’é™¤é•¿åº¦è¿‡çŸ­/çº¯æ•°å­—çš„è¡Œ
        return [...new Set(names)].filter(name => name.length > 1 && !/^\d+$/.test(name));
    }


    // --- æ•°æ®æŒä¹…åŒ– (T4) ---
    function saveT4() {
        localStorage.setItem('fs_dates', $('in_dates').value);
        localStorage.setItem('fs_names', $('in_names').value);
        localStorage.setItem('fs_codes', $('in_codes').value);
    }
    function loadSavedData() {
        $('in_dates').value = localStorage.getItem('fs_dates') || '';
        $('in_names').value = localStorage.getItem('fs_names') || '';
        $('in_codes').value = localStorage.getItem('fs_codes') || '';
    }
    window.onload = loadSavedData;
    
    // --- å…±äº«æ•°æ®æ£€æŸ¥ ---
    function checkSharedData(tabId) {
        const hasShared = !!SharedData && SharedData.rows.length > 0;
        
        if (tabId === 't1') {
            $('shared_prompt_t1').style.display = hasShared ? 'flex' : 'none';
            $('in1_raw').disabled = hasShared;
            $('t1_select_name').disabled = !hasShared;
            if (hasShared) {
                AppUI.populateNameSelects(SharedData.rows.map(r => r.name), true);
            }
        } else if (tabId === 't2') {
            $('shared_prompt_t2').style.display = hasShared ? 'flex' : 'none';
            
            if (hasShared) {
                AppUI.populateNameSelects(SharedData.rows.map(r => r.name), true);
                $('t2_manual_input').style.display = 'none';
                $('t2_shared_selection').style.display = 'grid';
            } else {
                $('t2_manual_input').style.display = 'block';
                $('t2_shared_selection').style.display = 'none';
            }
            const compareBtn = document.querySelector('#t2 .btn-group .btn-primary');
            compareBtn.onclick = hasShared ? App.t2_compare_shared : App.t2_compare_manual;


        } else if (tabId === 't3') {
            $('shared_prompt_t3').style.display = hasShared ? 'flex' : 'none';
            $('t3_manual_input').style.display = hasShared ? 'none' : 'block';
        }
    }


    // --- Tab 1: å•äººç­è¡¨ç”Ÿæˆ ---
    function t1_parse() {
        if (SharedData && $('shared_prompt_t1').style.display === 'flex') {
            t1_use_shared();
        } else {
            t1_parse_manual($('in1_raw').value);
        }
    }
    function t1_use_shared() {
        AppUI.hideStatus('st1');
        $('out1').value = "";
        try {
            if (!SharedData) throw new Error("å…±äº«æ•°æ®ä¸¢å¤±ï¼Œè¯·è¿”å›å¯è§†åŒ–æ’ç­è¡¨é‡æ–°ç”Ÿæˆã€‚");
            const selectedName = $('t1_select_name').value;
            
            if (!selectedName) throw new Error("è¯·é€‰æ‹©ä¸€ä½å‘˜å·¥ã€‚");

            const row = SharedData.rows.find(r => r.name === selectedName);
            
            if (!row) throw new Error("æœªæ‰¾åˆ°è¯¥å‘˜å·¥æ•°æ®ã€‚");
            
            const monthName = SharedData.days[0] ? `${SharedData.days[0].month}æœˆ` : 'æœ¬æœˆ';
            $('t1_output_title').textContent = `ã€${selectedName}ã€‘çš„ã€${monthName}ã€‘ç­è¡¨`;

            let out = "";
            row.codes.forEach((shift, index) => {
                const date = SharedData.days[index].full;
                const timeRange = shiftCodeToTimeRange(shift);
                out += `${date}: ${timeRange}\n`;
            });
            
            $('out1').value = out;
            AppUI.setStatus('st1', `ä½¿ç”¨å…±äº«æ•°æ®ç”ŸæˆæˆåŠŸï¼å‘˜å·¥: ${selectedName}`, 'ok');

        } catch(e) {
             $('out1').value = "";
             AppUI.setStatus('st1', e.message, 'error');
             console.error(e);
        }
    }
    function t1_parse_manual(rawText) {
        AppUI.hideStatus('st1');
        $('out1').value = "";
        $('t1_output_title').textContent = "ç”Ÿæˆç»“æœ (æ¯æ—¥æ—¥æœŸ: ç­æ¬¡)";
        try {
            if (!rawText.trim()) throw new Error("è¾“å…¥å†…å®¹ä¸ºç©ºã€‚è¯·ç²˜è´´ä¸‰è¡Œæ•°æ®ã€‚");

            // T1 çš„æ—¥æœŸå’Œç­æ¬¡æå–é€»è¾‘è¾ƒä¸ºç®€å•ï¼Œä¸ä½¿ç”¨ T4 çš„ä¸¥æ ¼è¿‡æ»¤ï¼Œåªå–æœ€æœ‰å¯èƒ½çš„è¡Œ
            const days = extractDates(rawText);
            
            const potentialCodeLines = rawText.split(/[\r\n]+/)
                .map(l => l.trim())
                .filter(l => l)
                .filter(l => /\d{1,2}:\d{2}|OFF|REST|MC|AL|PH|UPL|æ—©æ—©|ç™½|ä¸­|æ™š|æ™šæ™š|å¤œ/i.test(l) && !/æœˆ\d+æ—¥|æ˜ŸæœŸ/.test(l));

            if(potentialCodeLines.length === 0) throw new Error("è§£æå¤±è´¥ï¼šæœªè¯†åˆ«åˆ°ç­æ¬¡ä»£ç  (å¦‚ 9:00, OFF)ã€‚");
            
            // å‡è®¾æœ€é•¿çš„è¡Œæ˜¯ç­æ¬¡è¡Œ
            const targetCodeLine = potentialCodeLines.sort((a, b) => b.split(/[\t\s,ï¼Œ]+/).filter(Boolean).length - a.split(/[\t\s,ï¼Œ]+/).filter(Boolean).length)[0];
            const shifts = splitCodeLine(targetCodeLine);


            if(days.length === 0) throw new Error("è§£æå¤±è´¥ï¼šæœªè¯†åˆ«åˆ°æ—¥æœŸ (å¦‚ 12æœˆ1æ—¥)ã€‚");
            
            let out = "";
            let count = Math.min(days.length, shifts.length);
            for(let i=0; i<count; i++) {
                const timeRange = shiftCodeToTimeRange(shifts[i]);
                out += `${days[i].full}: ${timeRange}\n`;
            }

            $('out1').value = out;
            if (days.length !== shifts.length) {
                 AppUI.setStatus('st1', `è§£ææˆåŠŸï¼ä½†æ—¥æœŸæ•° (${days.length}) ä¸ç­æ¬¡æ•° (${shifts.length}) ä¸åŒ¹é…ï¼Œå·²æŒ‰æœ€å°‘æ•°é‡åŒ¹é… ${count} å¤©ã€‚`, 'error');
            } else {
                AppUI.setStatus('st1', `è§£ææˆåŠŸï¼å…±åŒ¹é… ${count} å¤©æ•°æ®ã€‚`, 'ok');
            }

        } catch(e) {
            $('out1').value = "";
            AppUI.setStatus('st1', e.message, 'error');
            console.error(e);
        }
    }
    
    // --- Tab 2: å¤šäººç­è¡¨æ¯”è¾ƒ ---
    function t2_compare() {
        if (SharedData && $('t2_shared_selection').style.display === 'grid') {
            t2_compare_shared();
        } else {
            t2_compare_manual();
        }
    }
    
    function t2_compare_shared() {
        AppUI.hideStatus('st2');
        $('out2_list').value = '';
        $('out2_summary').value = '';

        try {
            if (!SharedData) throw new Error("å…±äº«æ•°æ®ä¸¢å¤±ï¼Œè¯·è¿”å›å¯è§†åŒ–æ’ç­è¡¨é‡æ–°ç”Ÿæˆã€‚");

            const rawSelectedNames = [
                $('t2_select_1').value,
                $('t2_select_2').value,
                $('t2_select_3').value,
                $('t2_select_4').value
            ].filter(Boolean); 

            if (rawSelectedNames.length < 2) throw new Error("è¯·è‡³å°‘é€‰æ‹©ä¸¤ä½å‘˜å·¥è¿›è¡Œæ¯”è¾ƒã€‚");
            
            const uniqueNames = [...new Set(rawSelectedNames)];
            if (uniqueNames.length < rawSelectedNames.length) {
                console.warn("å‘ç°é‡å¤é€‰æ‹©çš„å‘˜å·¥ï¼Œå·²è‡ªåŠ¨å»é‡ã€‚");
            }

            const schedules = uniqueNames.map(name => {
                const row = SharedData.rows.find(r => r.name === name);
                if (!row) throw new Error(`æœªæ‰¾åˆ°å‘˜å·¥ ${name} çš„æ•°æ®ã€‚`);
                
                const scheduleMap = new Map();
                row.codes.forEach((code, index) => {
                    if(SharedData.days[index]) {
                        scheduleMap.set(SharedData.days[index].full, code.toUpperCase().replace(/[\(\)ï¼ˆï¼‰].*/, '').trim()); 
                    }
                });
                return { name, schedule: scheduleMap };
            });
            
            t2_compare_internal(SharedData.days.map(d => d.full), schedules);

        } catch (e) {
            $('out2_list').value = '';
            $('out2_summary').value = '';
            AppUI.setStatus('st2', `å…±äº«æ•°æ®æ¯”è¾ƒå¤±è´¥ï¼š${e.message}`, 'error');
            console.error(e);
        }
    }

    function t2_compare_manual() {
        AppUI.hideStatus('st2');
        $('out2_list').value = '';
        $('out2_summary').value = '';

        try {
            const dateText = $('in2_dates').value.trim();
            if (!dateText) throw new Error("è¯·å…ˆåœ¨é¡¶éƒ¨ç²˜è´´æ—¥æœŸè¡Œã€‚");
            const days = extractDates(dateText);
            if(days.length === 0) throw new Error("æ—¥æœŸè¡Œè§£æå¤±è´¥ã€‚è¯·ç¡®ä¿æ ¼å¼æ­£ç¡® (å¦‚ 12æœˆ1æ—¥)ã€‚");
            const dayKeys = days.map(d => d.full);

            const people = [];
            const uniqueNamesCheck = new Set();
            for (let i = 1; i <= 4; i++) {
                const name = $(`in2_name${i}`).value.trim();
                const raw = $(`in2_raw${i}`).value.trim();
                if (raw) {
                    if(!name) throw new Error(`å‘˜å·¥ ${i} çš„å§“åä¸èƒ½ä¸ºç©ºã€‚`);
                    if(uniqueNamesCheck.has(name)) throw new Error(`å‘˜å·¥å§“å ${name} é‡å¤ã€‚`);
                    uniqueNamesCheck.add(name);
                    people.push({ name, raw });
                }
            }

            if (people.length < 2) throw new Error("è¯·è‡³å°‘è¾“å…¥ä¸¤ä½å‘˜å·¥çš„ç­æ¬¡æ•°æ®è¿›è¡Œæ¯”è¾ƒã€‚");

            const schedules = [];
            for (const p of people) {
                // T2 æ‰‹åŠ¨è¾“å…¥ä¹Ÿä½¿ç”¨ T1 çš„ç®€å•æå–é€»è¾‘
                const potentialCodeLines = p.raw.split(/[\r\n]+/)
                    .map(l => l.trim())
                    .filter(l => l)
                    .filter(l => /\d{1,2}:\d{2}|OFF|REST|MC|AL|PH|UPL|æ—©æ—©|ç™½|ä¸­|æ™š|æ™šæ™š|å¤œ/i.test(l) && !/æœˆ\d+æ—¥|æ˜ŸæœŸ/.test(l));

                if(potentialCodeLines.length === 0) throw new Error(`è§£æ ${p.name} çš„ç­è¡¨å¤±è´¥ï¼šæœªè¯†åˆ«åˆ°ç­æ¬¡ä»£ç ã€‚`);
                const targetCodeLine = potentialCodeLines.sort((a, b) => b.split(/[\t\s,ï¼Œ]+/).filter(Boolean).length - a.split(/[\t\s,ï¼Œ]+/).filter(Boolean).length)[0];
                const codes = splitCodeLine(targetCodeLine);
                
                if (codes.length < dayKeys.length) {
                    throw new Error(`è§£æ ${p.name} çš„ç­è¡¨å¤±è´¥ï¼šç­æ¬¡æ•°é‡ (${codes.length}) å°‘äºæ—¥æœŸæ•°é‡ (${dayKeys.length})ã€‚`);
                }

                const scheduleMap = new Map();
                for(let i=0; i < dayKeys.length; i++) {
                    scheduleMap.set(dayKeys[i], codes[i].toUpperCase().replace(/[\(\)ï¼ˆï¼‰].*/, '').trim()); 
                }
                schedules.push({ name: p.name, schedule: scheduleMap });
            }
            
            t2_compare_internal(dayKeys, schedules);

        } catch (e) {
            $('out2_list').value = '';
            $('out2_summary').value = '';
            AppUI.setStatus('st2', `æ‰‹åŠ¨è¾“å…¥æ¯”è¾ƒå¤±è´¥ï¼š${e.message}`, 'error');
            console.error(e);
        }
    }
    
    function t2_compare_internal(dayKeys, schedules) {
        let commonWorkingDays = [];
        const namesList = schedules.map(s => s.name).join(' vs ');
        const numPeople = schedules.length;

        for (const dateKey of dayKeys) {
            let isWorking = true;
            let firstShift = null;

            for (const p of schedules) {
                const shift = p.schedule.get(dateKey);
                
                // 1. æ£€æŸ¥æ˜¯å¦ä¼‘æ¯æˆ–è¯·å‡ (OFF, REST, MC, AL, PH, UPL, LATE, è¯·å‡, ç—…å‡, å¹´å‡, å›¢å»º, åŸ¹è®­, æ”¯æ´, é©¬æ¥, HL, EL)
                if (!shift || /OFF|REST|MC|AL|PH|UPL|LATE|è¯·å‡|ç—…å‡|å¹´å‡|å›¢å»º|åŸ¹è®­|æ”¯æ´|é©¬æ¥|HL|EL/i.test(shift)) {
                    isWorking = false;
                    break;
                }
                
                // 2. æ£€æŸ¥ç­æ¬¡ä»£ç æ˜¯å¦å®Œå…¨ä¸€è‡´
                if (firstShift === null) {
                    firstShift = shift;
                } else if (shift !== firstShift) {
                    isWorking = false;
                    break;
                }
            }

            if (isWorking) {
                const timeRange = shiftCodeToTimeRange(firstShift);
                commonWorkingDays.push({ date: dateKey, shift: timeRange });
            }
        }

        const listOutput = commonWorkingDays.map(d => `${d.date}: ${d.shift}`).join('\n');
        const summaryOutput = `æ¯”è¾ƒäººå‘˜ï¼š${namesList}\næ¯”è¾ƒèŒƒå›´å¤©æ•°ï¼š${dayKeys.length}å¤©\n\nğŸ‰ å…±åŒä¸Šç­æ€»å¤©æ•° (ç­æ¬¡éœ€å®Œå…¨ä¸€è‡´)ï¼š\n${commonWorkingDays.length} å¤©`;
        
        $('out2_list').value = listOutput || "æœ¬æœˆæ— å…±åŒä¸”ç­æ¬¡å®Œå…¨ä¸€è‡´çš„ä¸Šç­æ—¥æœŸã€‚";
        $('out2_summary').value = summaryOutput;

        AppUI.setStatus('st2', `æ¯”è¾ƒæˆåŠŸï¼å…±æ‰¾åˆ° ${commonWorkingDays.length} ä¸ªå…±åŒä¸”ç­æ¬¡å®Œå…¨ä¸€è‡´çš„ä¸Šç­æ—¥ã€‚`, 'ok');
    }

    // --- Tab 3: ç­æ¬¡ç»Ÿè®¡æœç´¢ ---
    function t3_search() {
        if (SharedData && $('shared_prompt_t3').style.display === 'flex') {
            t3_search_shared();
        } else {
            t3_search_manual();
        }
    }
    
    function t3_search_shared() {
        AppUI.hideStatus('st3');
        $('out3_list').value = '';
        $('out3_summary').value = '';

        try {
            if (!SharedData) throw new Error("å…±äº«æ•°æ®ä¸¢å¤±ï¼Œè¯·è¿”å›å¯è§†åŒ–æ’ç­è¡¨é‡æ–°ç”Ÿæˆã€‚");
            const searchCode = $('in3_search').value.trim().toUpperCase().replace(/[\(\)ï¼ˆï¼‰\s].*/, '').trim();
            if (!searchCode) throw new Error("è¯·è¾“å…¥è¦æœç´¢çš„ç­æ¬¡ä»£ç  (å¦‚ MC)ã€‚");

            t3_search_internal(SharedData.rows.map(r => r.name), SharedData.rows.map(r => r.codes), searchCode);

        } catch (e) {
            $('out3_list').value = '';
            $('out3_summary').value = '';
            AppUI.setStatus('st3', `å…±äº«æ•°æ®æœç´¢å¤±è´¥ï¼š${e.message}`, 'error');
            console.error(e);
        }
    }
    
    function t3_search_manual() {
        AppUI.hideStatus('st3');
        $('out3_list').value = '';
        $('out3_summary').value = '';

        try {
            const namesText = $('in3_names').value.trim();
            const codesText = $('in3_codes').value.trim();
            const searchCode = $('in3_search').value.trim().toUpperCase().replace(/[\(\)ï¼ˆï¼‰\s].*/, '').trim();

            if (!namesText || !codesText) throw new Error("è¯·ç²˜è´´äººå‘˜åå•å’Œç­æ¬¡çŸ©é˜µã€‚");
            if (!searchCode) throw new Error("è¯·è¾“å…¥è¦æœç´¢çš„ç­æ¬¡ä»£ç  (å¦‚ MC)ã€‚");

            const names = filterNameLines(namesText); 
            const filteredCodeLines = filterCodeLines(codesText);
            
            if(names.length === 0 || filteredCodeLines.length === 0) throw new Error("æœªæ‰¾åˆ°åŒ¹é…çš„å§“åå’Œç­æ¬¡æ•°æ®ã€‚");

            // æ ¸å¿ƒå¯¹é½é€»è¾‘ï¼šæŒ‰æœ€å°‘è¡Œæ•°å¯¹é½
            const count = Math.min(names.length, filteredCodeLines.length);
            
            if (names.length !== filteredCodeLines.length) {
                console.warn(`T3 å¯¹é½è­¦å‘Šï¼šå§“åè¡Œæ•° (${names.length}) ä¸ç­æ¬¡è¡Œæ•° (${filteredCodeLines.length}) ä¸å®Œå…¨åŒ¹é…ï¼Œå·²æŒ‰æœ€å°‘è¡Œæ•° ${count} å¯¹é½ã€‚`);
            }
            
            const codesMatrix = filteredCodeLines.slice(0, count).map(line => splitCodeLine(line));
            const alignedNames = names.slice(0, count);

            t3_search_internal(alignedNames, codesMatrix, searchCode);

        } catch (e) {
            $('out3_list').value = '';
            $('out3_summary').value = '';
            AppUI.setStatus('st3', `æ‰‹åŠ¨æœç´¢å¤±è´¥ï¼š${e.message}`, 'error');
            console.error(e);
        }
    }
    
    function t3_search_internal(names, codesMatrix, searchCode) {
        let totalCount = 0;
        let matchedPeople = new Map();
        
        for(let i=0; i < names.length; i++) {
            const name = names[i];
            const codes = codesMatrix[i] || [];
            let personCount = 0;

            codes.forEach(code => {
                const cleanedCode = code.toUpperCase().replace(/[\(\)ï¼ˆï¼‰].*/, '').trim();
                
                if (cleanedCode.startsWith(searchCode) || code.toUpperCase().includes(searchCode)) {
                    personCount++;
                }
            });

            if (personCount > 0) {
                matchedPeople.set(name, personCount);
                totalCount += personCount;
            }
        }

        const listOutput = Array.from(matchedPeople.entries())
            .map(([name, count]) => `${name}: ${count} æ¬¡`)
            .join('\n');
        
        const summaryOutput = `æœç´¢ä»£ç ï¼š${searchCode}\n\nğŸ‰ æ€»è®¡å‡ºç°æ¬¡æ•°ï¼š\n${totalCount} æ¬¡\n\nğŸ‘¤ æ¶‰åŠæ€»äººæ•°ï¼š\n${matchedPeople.size} äºº`;

        $('out3_list').value = listOutput || `æ²¡æœ‰æ‰¾åˆ°åŒ…å« "${searchCode}" çš„ç­æ¬¡ã€‚`;
        $('out3_summary').value = summaryOutput;

        AppUI.setStatus('st3', `æœç´¢æˆåŠŸï¼æ‰¾åˆ° ${totalCount} æ¬¡åŒ¹é…ï¼Œæ¶‰åŠ ${matchedPeople.size} äººã€‚`, 'ok');
    }

    // --- Tab 4: å¯è§†åŒ–æ’ç­è¡¨ ---
    function t4_render() {
        saveT4();
        try {
            const dText = $('in_dates').value;
            const nText = $('in_names').value;
            const cText = $('in_codes').value;

            if(!dText || !nText || !cText) throw new Error("è¯·å¡«æ»¡ä¸‰ä¸ªè¾“å…¥æ¡†");
            
            const days = extractDates(dText);
            if(days.length === 0) throw new Error("æ—¥æœŸæ•°æ®è§£æå¤±è´¥ (å¦‚ 12æœˆ1æ—¥)ã€‚è¯·æ£€æŸ¥æ—¥æœŸè¡Œæ˜¯å¦åŒ…å« 'æœˆ/æ—¥' æ ¼å¼ã€‚");

            // V6.9 è‡ªåŠ¨è¿‡æ»¤å§“åå’Œç­æ¬¡è¡Œ
            const names = filterNameLines(nText); 
            const filteredCodeLines = filterCodeLines(cText);

            if(names.length === 0) throw new Error("å§“ååˆ—è¡¨ä¸ºç©ºï¼Œè¯·æ£€æŸ¥ç²˜è´´çš„å†…å®¹ã€‚");
            if(filteredCodeLines.length === 0) throw new Error("ç­æ¬¡çŸ©é˜µä¸ºç©ºï¼Œè¯·æ£€æŸ¥ç²˜è´´çš„å†…å®¹ã€‚");

            // æ ¸å¿ƒå¯¹é½é€»è¾‘ï¼šæŒ‰æœ€å°‘è¡Œæ•°å¯¹é½
            const nameCount = names.length;
            const codeLineCount = filteredCodeLines.length;
            const finalCount = Math.min(nameCount, codeLineCount);
            
            if (nameCount !== codeLineCount) {
                AppUI.msgT4(`âš ï¸ è­¦å‘Š: å§“åè¡Œæ•° (${nameCount}) ä¸ç­æ¬¡è¡Œæ•° (${codeLineCount}) ä¸å®Œå…¨åŒ¹é…ï¼Œå·²æŒ‰æœ€å°‘è¡Œæ•° ${finalCount} å¯¹é½ã€‚`, true);
            }

            const rows = [];
            let rowWarningCount = 0;
            
            for(let i=0; i<finalCount; i++) {
                const codes = splitCodeLine(filteredCodeLines[i]); 
                 
                if (codes.length < days.length) {
                    console.warn(`ç¬¬ ${i + 1} è¡Œ (${names[i]}) ç­æ¬¡æ•°é‡ (${codes.length}) å°‘äºæ—¥æœŸæ•°é‡ (${days.length})ã€‚`);
                    rowWarningCount++;
                 }
                
                let stats = { off:0, work:0, leave:0 };
                const processedCodes = codes.slice(0, days.length).map(c => {
                    const uc = c.toUpperCase().replace(/[\(\)ï¼ˆï¼‰\s].*/, '').trim(); 
                    
                    if(/OFF|REST/.test(uc)) stats.off++;
                    else if(/MC|AL|PH|UPL|LATE|è¯·å‡|ç—…å‡|å¹´å‡|HL|EL/.test(uc)) stats.leave++;
                    else if(uc.length > 0) stats.work++; 
                    
                    return c; 
                });
                
                rows.push({
                    name: names[i],
                    codes: processedCodes,
                    stats
                });
            }
            
            const data = { days, rows };
            SharedData = data; 
            
            const container = $('table_container');
            
            // --- HTML Table Generation Logic ---
            let html = '<table><thead><tr>';
            html += '<th style="min-width:120px; z-index:50;">äººå‘˜åå•</th>';
            data.days.forEach(d => {
                html += `<th>${d.month}/${d.day}</th>`;
            });
            html += '<th class="stats-col">å‡ºå‹¤</th><th class="stats-col">è¯·/ä¼‘å‡</th>'; 
            html += '</tr></thead><tbody>';

            data.rows.forEach(row => {
                html += `<tr>`;
                html += `<th>${row.name}</th>`;
                
                const renderedCodes = row.codes.map(c => {
                     const typeClass = getCodeClass(c);
                     return `<td><div class="cell-inner ${typeClass}">${c}</div></td>`;
                }).join('');
                
                html += renderedCodes;

                for(let k=row.codes.length; k<data.days.length; k++) {
                     html += `<td></td>`;
                }

                html += `<td class="stats-col">${row.stats.work}</td>`;
                const combinedLeave = row.stats.leave + row.stats.off;
                html += `<td class="stats-col" style="color:${row.stats.leave>0?'red':'inherit'}">${combinedLeave}</td>`;
                
                html += `</tr>`;
            });

            html += '</tbody></table>';
            
            container.innerHTML = html;
            container.style.display = 'block';
            $('visual_placeholder').style.display = 'none';
            
            let msg = `æˆåŠŸç”Ÿæˆ ${data.rows.length} äººçš„æ’ç­è¡¨`;
            if (rowWarningCount > 0) {
                 msg += ` (âš ï¸ è­¦å‘Š: æœ‰ ${rowWarningCount} ä½å‘˜å·¥çš„ç­æ¬¡æ•°æ®é•¿åº¦ä¸è¶³)`;
                 AppUI.msgT4(msg, true);
            } else if (nameCount !== codeLineCount) {
                 // åŒ¹é…è¡Œæ•°ä¸ä¸€è‡´ä½†æ— æ•°æ®ç¼ºå¤±è­¦å‘Šæ—¶
                 AppUI.msgT4(msg);
            } else {
                 AppUI.msgT4(msg);
            }

        } catch(e) {
            SharedData = null; 
            AppUI.msgT4(`ç”Ÿæˆå¤±è´¥ï¼š${e.message}`, true);
        }

        function getCodeClass(code) {
            const s = code.toUpperCase().replace(/[\(\)ï¼ˆï¼‰\s].*/, '').trim(); 
            if (s === 'OFF' || s === 'REST') return 'type-off';
            if (/MC|PH|UPL|LATE|è¯·å‡|ç—…å‡|HL|EL/.test(s)) return 'type-leave';
            if (s === 'AL' || s === 'å¹´å‡') return 'type-al';
            
            if (s.includes('15:') || s.includes('16:') || s.includes('17:') || s.includes('æ™š') || s === 'å¤œ') return 'type-night';
            
            if (/\d{1,2}:\d{2}/.test(s) || /æ—©|ç™½|ä¸­/.test(s) || s.includes('8:') || s.includes('9:') || s.includes('12:')) return 'type-work';
            
            return ''; 
        }

        App.checkSharedData('t1');
        App.checkSharedData('t2');
        App.checkSharedData('t3');
    }

    return { 
        t1_parse, t1_use_shared, 
        t2_compare, t2_compare_shared, t2_compare_manual,
        t3_search, 
        t4_render, 
        loadSavedData, 
        checkSharedData,
        SharedData 
    };
})();

// åˆå§‹åŒ–ï¼šè®¾ç½®é»˜è®¤ Tab
AppUI.switchTab('t4'); 
</script>
</body>
</html>
